<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π –†–æ–∑–∫–ª–∞–¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.5s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen font-sans text-gray-800">
    <div id="app" class="p-4 md:p-8">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-700 mb-2">üìÖ –ì–Ω—É—á–∫–∏–π –†–æ–∑–∫–ª–∞–¥</h1>
            <p class="text-gray-600">–û–±–µ—Ä—ñ—Ç—å –¥–µ–∫—ñ–ª—å–∫–∞ –≥—Ä—É–ø –∞–±–æ –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤ –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è</p>
        </header>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

            <!-- Sidebar: Controls -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">

                <!-- Tabs: Student vs Teacher -->
                <div class="flex mb-6 border-b">
                    <button @click="mode = 'student'"
                        :class="['flex-1 py-2 font-semibold transition', mode === 'student' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-400 hover:text-gray-600']">
                        –°—Ç—É–¥–µ–Ω—Ç
                    </button>
                    <button @click="mode = 'teacher'"
                        :class="['flex-1 py-2 font-semibold transition', mode === 'teacher' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-400 hover:text-gray-600']">
                        –í–∏–∫–ª–∞–¥–∞—á
                    </button>
                </div>

                <!-- Search Bar -->
                <div class="mb-6 relative">
                    <label class="block text-sm font-bold mb-1">üîç –®–≤–∏–¥–∫–∏–π –ø–æ—à—É–∫ –≥—Ä—É–ø–∏</label>
                    <input type="text" v-model="searchQuery" @input="onSearchInput" @focus="onSearchInput"
                        placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–ù-21..."
                        class="w-full border rounded p-2 focus:ring focus:ring-blue-200">

                    <!-- Dropdown Results -->
                    <div v-if="searchResults.length > 0"
                        class="absolute z-50 w-full bg-white border rounded-b shadow-lg max-h-60 overflow-y-auto">
                        <div v-for="(res, idx) in searchResults" :key="idx" @click="selectSearchResult(res)"
                            class="p-2 hover:bg-blue-50 cursor-pointer border-b last:border-b-0 text-sm">
                            <span class="font-bold text-blue-700">{{ res.group.Value }}</span>
                            <span class="text-gray-500 text-xs ml-2">{{ res.facultyName }}</span>
                        </div>
                    </div>
                    <div v-if="isSearching && !isCacheLoaded" class="absolute right-2 top-8">
                        <div class="animate-spin h-4 w-4 border-2 border-blue-500 rounded-full border-t-transparent">
                        </div>
                    </div>
                </div>

                <div v-if="loadingFilters" class="text-center py-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                </div>

                <div v-else class="space-y-4">
                    <!-- Faculty Filter (Common) -->
                    <div>
                        <label class="block text-sm font-bold mb-1">–§–∞–∫—É–ª—å—Ç–µ—Ç</label>
                        <select v-model="selectedFaculty" @change="onFacultyChange"
                            class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                            <option value="">-- –û–±–µ—Ä—ñ—Ç—å —Ñ–∞–∫—É–ª—å—Ç–µ—Ç --</option>
                            <option v-for="fac in faculties" :key="fac.Key" :value="fac.Key">{{ fac.Value }}</option>
                        </select>
                    </div>

                    <!-- Student Filters -->
                    <div v-if="mode === 'student'">
                        <div>
                            <label class="block text-sm font-bold mb-1">–§–æ—Ä–º–∞ –Ω–∞–≤—á–∞–Ω–Ω—è</label>
                            <select v-model="selectedEduForm" @change="loadGroups"
                                class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                                <option value="">-- –í—Å—ñ --</option>
                                <option v-for="item in eduForms" :key="item.Key" :value="item.Key">{{ item.Value }}
                                </option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">–ö—É—Ä—Å</label>
                            <select v-model="selectedCourse" @change="loadGroups"
                                class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                                <option value="">-- –í—Å—ñ --</option>
                                <option v-for="item in courses" :key="item.Key" :value="item.Key">{{ item.Value }}
                                </option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">–ì—Ä—É–ø–∞</label>
                            <select v-model="selectedGroup"
                                class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                                <option value="">-- –û–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É --</option>
                                <option v-for="grp in groups" :key="grp.Key" :value="grp">{{ grp.Value }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- Teacher Filters -->
                    <div v-else>
                        <div>
                            <label class="block text-sm font-bold mb-1">–ö–∞—Ñ–µ–¥—Ä–∞</label>
                            <select v-model="selectedChair" @change="loadEmployees"
                                class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                                <option value="">-- –û–±–µ—Ä—ñ—Ç—å –∫–∞—Ñ–µ–¥—Ä—É --</option>
                                <option v-for="chair in chairs" :key="chair.Key" :value="chair.Key">{{ chair.Value }}
                                </option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">–í–∏–∫–ª–∞–¥–∞—á</label>
                            <select v-model="selectedEmployee"
                                class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                                <option value="">-- –û–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞ --</option>
                                <option v-for="emp in employees" :key="emp.Key" :value="emp">{{ emp.Value }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- Date Range -->
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-bold mb-1">–ó</label>
                            <input type="date" v-model="dateStart" class="w-full border rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">–ü–æ</label>
                            <input type="date" v-model="dateEnd" class="w-full border rounded p-2 text-sm">
                        </div>
                    </div>

                    <!-- Add Button -->
                    <button @click="addEntity" :disabled="!canAdd"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                        + –î–æ–¥–∞—Ç–∏ –¥–æ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è
                    </button>
                    <p v-if="errorMessage" class="text-red-500 text-sm mt-2">{{ errorMessage }}</p>
                </div>

                <!-- Export -->
                <div v-if="Object.keys(groupedSchedule).length > 0" class="mt-6 pt-6 border-t">
                    <button @click="exportExcel"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition flex items-center justify-center gap-2">
                        <span>üì•</span> –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ Excel
                    </button>
                </div>
            </div>

            <!-- Main Panel: Results -->
            <div class="lg:col-span-3 space-y-6">

                <!-- Helper message if empty -->
                <div v-if="activeEntities.length === 0"
                    class="bg-white p-12 rounded-xl shadow text-center text-gray-400">
                    <p class="text-xl">–°–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</p>
                    <p>–î–æ–¥–∞–π—Ç–µ –≥—Ä—É–ø—É –∞–±–æ –≤–∏–∫–ª–∞–¥–∞—á–∞, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥</p>
                </div>

                <!-- Global Controls (Discipline Filter) -->
                <div v-if="activeEntities.length > 0" class="bg-white p-4 rounded-xl shadow">
                    <div class="mb-2 font-bold text-gray-700">–§—ñ–ª—å—Ç—Ä –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞—Ö:</div>
                    <div class="flex flex-wrap gap-2">
                        <!-- "All" Chip -->
                        <button @click="selectedDisciplines = []" :class="['px-3 py-1 rounded-full text-sm border transition', 
                                selectedDisciplines.length === 0 
                                ? 'bg-blue-600 text-white border-blue-600 font-bold shadow-md' 
                                : 'bg-gray-100 text-gray-600 border-gray-200 hover:bg-gray-200']">
                            –í—Å—ñ –ø—Ä–µ–¥–º–µ—Ç–∏
                        </button>

                        <!-- Discipline Chips -->
                        <button v-for="disc in availableDisciplines" :key="disc" @click="toggleDiscipline(disc)" :class="['px-3 py-1 rounded-full text-sm border transition text-left', 
                                selectedDisciplines.includes(disc) 
                                ? 'bg-blue-100 text-blue-800 border-blue-300 font-semibold shadow-sm ring-1 ring-blue-300' 
                                : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50']">
                            {{ disc }}
                        </button>
                    </div>
                </div>

                <!-- Active Entities List -->
                <div v-else class="flex flex-wrap gap-3">
                    <div v-for="(entity, index) in activeEntities" :key="index"
                        class="flex items-center bg-white border border-blue-200 text-blue-800 px-4 py-2 rounded-full shadow-sm">
                        <span class="font-medium mr-2">{{ entity.name }}</span>
                        <span class="text-xs text-gray-500 uppercase mr-3">({{ entity.type }})</span>
                        <button @click="removeEntity(index)"
                            class="text-red-400 hover:text-red-700 font-bold">‚úï</button>
                    </div>
                </div>

                <!-- Schedule Grid -->
                <!-- We group by DATE, then by TIME slot -->
                <div v-if="Object.keys(groupedSchedule).length > 0" class="bg-white rounded-xl shadow overflow-hidden">
                    <div v-for="(dayData, date) in groupedSchedule" :key="date" class="border-b last:border-b-0">
                        <div class="bg-gray-50 px-6 py-3 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="font-bold text-lg text-gray-800">{{ dayData.dayName }}, {{ date }}</h3>
                        </div>

                        <div class="divide-y divide-gray-100">
                            <div v-for="(timeSlot, time) in dayData.slots" :key="time"
                                class="grid grid-cols-12 hover:bg-gray-50 transition p-4">
                                <!-- Time Column -->
                                <div
                                    class="col-span-12 md:col-span-2 text-center md:text-left mb-2 md:mb-0 flex flex-row md:flex-col items-center md:items-start gap-2 md:gap-1">
                                    <span
                                        class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded whitespace-nowrap">
                                        {{ time }}
                                    </span>
                                    <span v-if="timeSlot.start" class="text-sm text-gray-500 font-medium">
                                        {{ timeSlot.start }} - {{ timeSlot.end }}
                                    </span>
                                </div>

                                <!-- Classes Column -->
                                <div class="col-span-12 md:col-span-10 grid gap-4">
                                    <div v-for="(lesson, idx) in timeSlot.lessons" :key="idx"
                                        class="bg-white border rounded-lg p-3 shadow-sm relative pl-4 border-l-4 transition-all duration-500"
                                        :class="[
                                            getColorClass(lesson.entityId),
                                            isActiveLesson(date, timeSlot.start, timeSlot.end) ? 'ring-4 ring-green-400 scale-[1.02] z-10' : ''
                                        ]">

                                        <div class="flex justify-between items-start">
                                            <div>
                                                <div v-if="isActiveLesson(date, timeSlot.start, timeSlot.end)"
                                                    class="inline-block bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full mb-1 animate-pulse">
                                                    –ó–ê–†–ê–ó
                                                </div>
                                                <h4 class="font-bold text-gray-900">{{ lesson.discipline }}</h4>
                                                <p class="text-sm text-gray-600 block md:hidden mt-1 font-semibold">{{
                                                    lesson.entityName }}</p>
                                                <div class="text-sm text-gray-500 mt-1 flex flex-wrap gap-x-4">
                                                    <span v-if="lesson.type">üè∑Ô∏è {{ lesson.type }}</span>
                                                    <span v-if="lesson.cabinet">üìç {{ lesson.cabinet }}</span>
                                                    <span v-if="lesson.teacher">üë®‚Äçüè´ <span
                                                            v-html="lesson.teacher"></span></span>
                                                    <span v-if="lesson.group">üéì {{ lesson.group }}</span>
                                                </div>
                                            </div>
                                            <div class="hidden md:block text-right">
                                                <span
                                                    class="text-xs font-bold uppercase tracking-wider text-gray-400 bg-gray-100 px-2 py-1 rounded">
                                                    {{ lesson.entityName }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="activeEntities.length > 0 && Object.keys(groupedSchedule).length === 0 && !loadingSchedule"
                    class="text-center py-10 text-gray-500">
                    –ù–∞ –≤–∏–±—Ä–∞–Ω–∏–π –ø–µ—Ä—ñ–æ–¥ —Ä–æ–∑–∫–ª–∞–¥—É –Ω–µ–º–∞—î.
                </div>

                <div v-if="loadingSchedule" class="text-center py-10">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="text-gray-500 mt-2">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—É...</p>
                </div>

            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 text-center pb-8">
            <a href="http://wp-fuaid.zzz.com.ua/"
                class="inline-block text-blue-600 hover:text-blue-800 font-semibold border-b-2 border-transparent hover:border-blue-600 transition">
                ‚¨Ö –ù–∞ –≥–æ–ª–æ–≤–Ω—É
            </a>
        </footer>
    </div>

    <script>
        const API_PROXY = '/api/';
        const VUZ_ID = 11927; // Hardcoded ID from analysis

        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                // State
                const mode = ref('student'); // 'student' or 'teacher'
                const loadingFilters = ref(false);
                const loadingSchedule = ref(false);
                const errorMessage = ref('');

                // Dictionaries
                const faculties = ref([]);
                const eduForms = ref([]);
                const courses = ref([]);
                const chairs = ref([]);
                const groups = ref([]); // List of groups for selected faculty
                const employees = ref([]); // List of teachers

                // Selections
                const selectedFaculty = ref('');
                const selectedEduForm = ref('');
                const selectedCourse = ref('');
                const selectedGroup = ref(''); // Object {Key, Value}
                const selectedChair = ref('');
                const selectedEmployee = ref(''); // Object {Key, Value}

                // Filter within results
                const selectedDisciplines = ref([]);

                // Dates (Default to current week)
                const dateStart = ref(new Date().toISOString().split('T')[0]);
                const nextWeek = new Date();
                nextWeek.setDate(nextWeek.getDate() + 7);
                const dateEnd = ref(nextWeek.toISOString().split('T')[0]);

                // Active Data
                const activeEntities = ref([]); // Array of { id, name, type, scheduleData }

                // --- API Helpers ---
                const fetchApi = async (action, params = {}) => {
                    // Append action to the path for the Node server to parse correctly
                    // e.g. /api/GetStudentScheduleFiltersData
                    const url = new URL(API_PROXY + action, window.location.origin);

                    url.searchParams.append('aVuzID', VUZ_ID);

                    // Only needed for dictionaries
                    if (!action.startsWith('GetScheduleData')) {
                        url.searchParams.append('aGiveStudyTimes', 'true');
                    }

                    const quoteIfNeeded = (val) => {
                        if (typeof val === 'string') return `"${val}"`;
                        return val;
                    };

                    for (const [key, value] of Object.entries(params)) {
                        if (value !== undefined && value !== null) {
                            url.searchParams.append(key, quoteIfNeeded(value));
                        }
                    }

                    try {
                        const res = await fetch(url);
                        if (!res.ok) throw new Error('Network error');
                        const json = await res.json();
                        return json.d; // The API wraps result in 'd'
                    } catch (e) {
                        console.error("API Error", e);
                        errorMessage.value = "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö";
                        return null;
                    }
                };

                // --- Computed ---
                const availableDisciplines = computed(() => {
                    const set = new Set();
                    activeEntities.value.forEach(entity => {
                        if (!entity.scheduleData) return;
                        entity.scheduleData.forEach(item => {
                            if (item.discipline) set.add(item.discipline);
                        });
                    });
                    return Array.from(set).sort();
                });

                const canAdd = computed(() => {
                    if (mode.value === 'student') return !!selectedGroup.value;
                    if (mode.value === 'teacher') return !!selectedEmployee.value;
                    return false;
                });

                const groupedSchedule = computed(() => {
                    // Merge all schedules from activeEntities
                    const merged = [];

                    activeEntities.value.forEach(entity => {
                        if (!entity.scheduleData) return;
                        entity.scheduleData.forEach(item => {
                            merged.push({
                                ...item,
                                entityName: entity.name,
                                entityId: entity.id, // For coloring
                                entityType: entity.type
                            });
                        });
                    });

                    // Group by Date -> Time
                    const days = {};

                    // Sorting helper
                    const parseDate = (str) => { // dd.mm.yyyy
                        const [d, m, y] = str.split('.');
                        return new Date(`${y}-${m}-${d}`);
                    };

                    merged.sort((a, b) => parseDate(a.full_date) - parseDate(b.full_date));

                    merged.forEach(lesson => {
                        if (!days[lesson.full_date]) {
                            days[lesson.full_date] = {
                                date: lesson.full_date,
                                dayName: lesson.week_day,
                                slots: {}
                            };
                        }

                        const timeKey = lesson.study_time; // e.g. "1 –ø–∞—Ä—ñ (08:30-09:50)"
                        if (!days[lesson.full_date].slots[timeKey]) {
                            days[lesson.full_date].slots[timeKey] = {
                                time: timeKey,
                                start: lesson.study_time_begin,
                                end: lesson.study_time_end,
                                lessons: []
                            };
                        }

                        // normalize data for display
                        const lessonData = {
                            discipline: lesson.discipline,
                            type: lesson.study_type,
                            cabinet: lesson.cabinet,
                            teacher: lesson.employee_short || lesson.employee, // For students seeing teacher
                            group: lesson.group, // For teachers seeing group
                            entityName: lesson.entityName,
                            entityId: lesson.entityId,
                            timeStart: lesson.study_time_begin,
                            timeEnd: lesson.study_time_end
                        };

                        if (selectedDisciplines.value.length > 0 && !selectedDisciplines.value.includes(lesson.discipline)) {
                            return;
                        }

                        days[lesson.full_date].slots[timeKey].lessons.push(lessonData);
                    });

                    // Sort times within days (simple string sort usually works if format is consistent "1 pair...")
                    // But better to rely on structure. Let's return object.
                    return days;
                });

                // --- Methods ---

                const init = async () => {
                    loadState();
                    loadingFilters.value = true;
                    // Initial load -> Get Faculties
                    const data = await fetchApi('GetStudentScheduleFiltersData');
                    if (data) {
                        faculties.value = data.faculties || [];
                        eduForms.value = data.educForms || [];
                        courses.value = data.courses || [];
                    }
                    loadingFilters.value = false;
                };

                const onFacultyChange = () => {
                    // Reset dependants
                    groups.value = [];
                    chairs.value = [];
                    selectedGroup.value = '';
                    selectedEmployee.value = '';
                    selectedChair.value = '';

                    if (!selectedFaculty.value) return;

                    if (mode.value === 'student') loadGroups();
                    else loadChairs();
                };

                const loadGroups = async () => {
                    if (mode.value !== 'student' || !selectedFaculty.value) return;

                    const data = await fetchApi('GetStudyGroups', {
                        aFacultyID: selectedFaculty.value,
                        aEducationForm: selectedEduForm.value || "",
                        aCourse: selectedCourse.value || ""
                    });

                    if (data && data.studyGroups) {
                        groups.value = data.studyGroups;
                    }
                };

                const loadChairs = async () => {
                    const data = await fetchApi('GetEmployeeChairs', {
                        aFacultyID: selectedFaculty.value
                    });
                    if (data) {
                        chairs.value = data.chairs || [];
                        // Some endpoints return employees right away if chair is null, but we usually pick chair first
                    }
                };

                const loadEmployees = async () => {
                    if (!selectedChair.value) return;
                    const data = await fetchApi('GetEmployees', {
                        aFacultyID: selectedFaculty.value,
                        aChairID: selectedChair.value
                    });
                    if (data) {
                        employees.value = data || []; // Sometimes it's direct array or {d: ...}
                    }
                };

                const addEntity = async () => {
                    let id, name, type, payload, action;
                    const startDate = dateStart.value.split('-').reverse().join('.'); // YYYY-MM-DD -> DD.MM.YYYY
                    const endDate = dateEnd.value.split('-').reverse().join('.');

                    if (mode.value === 'student') {
                        id = selectedGroup.value.Key;
                        name = selectedGroup.value.Value;
                        type = '–ì—Ä—É–ø–∞';
                        action = 'GetScheduleDataX'; // Student schedule
                        payload = {
                            aStudyGroupID: id,
                            aStartDate: startDate,
                            aEndDate: endDate,
                            aStudyTypeID: "" // Required by API even if empty
                        };
                    } else {
                        id = selectedEmployee.value.Key;
                        name = selectedEmployee.value.Value;
                        type = '–í–∏–∫–ª–∞–¥–∞—á';
                        action = 'GetScheduleDataEmp'; // Teacher schedule
                        payload = {
                            aEmployeeID: id,
                            aStartDate: startDate,
                            aEndDate: endDate,
                            aStudyTypeID: "" // Required by API even if empty
                        };
                    }

                    // Check if already exists
                    if (activeEntities.value.find(e => e.id === id && e.type === type)) {
                        errorMessage.value = "–í–∂–µ –¥–æ–¥–∞–Ω–æ!";
                        setTimeout(() => errorMessage.value = '', 2000);
                        return;
                    }

                    loadingSchedule.value = true;
                    const data = await fetchApi(action, payload);
                    loadingSchedule.value = false;

                    if (data) {
                        activeEntities.value.push({
                            id,
                            name,
                            type,
                            scheduleData: data
                        });
                    }
                };

                const removeEntity = (index) => {
                    activeEntities.value.splice(index, 1);
                };

                const exportExcel = () => {
                    const rows = [];

                    // Header
                    rows.push(["–î–∞—Ç–∞", "–î–µ–Ω—å", "–ß–∞—Å", "–î–∏—Å—Ü–∏–ø–ª—ñ–Ω–∞", "–¢–∏–ø", "–ê—É–¥–∏—Ç–æ—Ä—ñ—è", "–í–∏–∫–ª–∞–¥–∞—á/–ì—Ä—É–ø–∞", "–î–ª—è –∫–æ–≥–æ"]);

                    // Iterate grouped schedule
                    // groupedSchedule is Object: "dd.mm.yyyy": { date, dayName, slots: { "time": { lessons: [] } } }

                    // Sort dates
                    const dates = Object.keys(groupedSchedule.value).sort((a, b) => {
                        const [d1, m1, y1] = a.split('.');
                        const [d2, m2, y2] = b.split('.');
                        return new Date(`${y1}-${m1}-${d1}`) - new Date(`${y2}-${m2}-${d2}`);
                    });

                    dates.forEach(date => {
                        const dayData = groupedSchedule.value[date];
                        const dayName = dayData.dayName;

                        // Sort times
                        const times = Object.keys(dayData.slots).sort();

                        times.forEach(time => {
                            const slot = dayData.slots[time];
                            slot.lessons.forEach(lesson => {
                                // Clean HTML from teacher name if present
                                let teacherText = lesson.teacher || "";
                                if (teacherText.includes('<')) {
                                    const temp = document.createElement("div");
                                    temp.innerHTML = teacherText;
                                    teacherText = temp.textContent || temp.innerText || "";
                                }

                                rows.push([
                                    date,
                                    dayName,
                                    time,
                                    lesson.discipline,
                                    lesson.type,
                                    lesson.cabinet,
                                    teacherText || lesson.group, // Show whoever is relevant
                                    lesson.entityName // Who this schedule belongs to
                                ]);
                            });
                        });
                    });

                    const ws = XLSX.utils.aoa_to_sheet(rows);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "–†–æ–∑–∫–ª–∞–¥");
                    XLSX.writeFile(wb, "rozklad.xlsx");
                };

                // --- Persistence ---
                const STORAGE_KEY = 'schedule_app_v1';

                const saveState = () => {
                    const state = {
                        mode: mode.value,
                        activeEntities: activeEntities.value,
                        selectedDisciplines: selectedDisciplines.value
                    };
                    try {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                    } catch (e) {
                        console.error('Save failed', e);
                    }
                };

                const loadState = () => {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        try {
                            const parsed = JSON.parse(saved);
                            if (parsed.mode) mode.value = parsed.mode;
                            if (parsed.activeEntities) activeEntities.value = parsed.activeEntities;
                            if (parsed.selectedDisciplines) selectedDisciplines.value = parsed.selectedDisciplines;
                        } catch (e) {
                            console.error('Load failed', e);
                        }
                    }
                };

                // Watch for changes to auto-save
                watch([mode, activeEntities, selectedDisciplines], () => {
                    saveState();
                }, { deep: true });

                const toggleDiscipline = (disc) => {
                    if (selectedDisciplines.value.includes(disc)) {
                        selectedDisciplines.value = selectedDisciplines.value.filter(d => d !== disc);
                    } else {
                        selectedDisciplines.value.push(disc);
                    }
                };

                // Color generator for different entities
                const getColorClass = (id) => {
                    const colors = [
                        'border-red-400 bg-red-50',
                        'border-green-400 bg-green-50',
                        'border-yellow-400 bg-yellow-50',
                        'border-purple-400 bg-purple-50',
                        'border-pink-400 bg-pink-50',
                        'border-indigo-400 bg-indigo-50'
                    ];
                    // Simple hash
                    const num = String(id).split('').reduce((a, b) => a + b.charCodeAt(0), 0);
                    return colors[num % colors.length];
                };

                // Watchers
                watch(mode, () => {
                    // Clear deeper selections when switching mode, but keep faculty
                    selectedGroup.value = '';
                    selectedEmployee.value = '';
                    if (selectedFaculty.value) {
                        if (mode.value === 'student') loadGroups();
                        else loadChairs();
                    }
                });

                // --- Smart Search ---
                const searchQuery = ref('');
                const searchResults = ref([]);
                const allGroupsCache = ref([]); // Flattened list of { group: obj, facultyId: str, facultyName: str }
                const isCacheLoaded = ref(false);
                const isSearching = ref(false);

                const buildGroupCache = async () => {
                    if (isCacheLoaded.value) return;
                    isSearching.value = true;

                    const temp = [];
                    // We need faculties first
                    if (faculties.value.length === 0) {
                        await init();
                    }

                    // Parallel fetch for all faculties
                    const promises = faculties.value.map(async (fac) => {
                        const data = await fetchApi('GetStudyGroups', { aFacultyID: fac.Key });
                        if (data && data.studyGroups) {
                            data.studyGroups.forEach(g => {
                                temp.push({
                                    group: g,
                                    facultyId: fac.Key,
                                    facultyName: fac.Value,
                                    label: `${g.Value} (${fac.Value})`
                                });
                            });
                        }
                    });

                    await Promise.all(promises);
                    allGroupsCache.value = temp;
                    isCacheLoaded.value = true;
                    isSearching.value = false;
                };

                const onSearchInput = async () => {
                    if (!isCacheLoaded.value) {
                        await buildGroupCache();
                    }
                    const q = searchQuery.value.toLowerCase().trim();
                    if (!q) {
                        searchResults.value = [];
                        return;
                    }
                    // Simple limit to 10 results
                    searchResults.value = allGroupsCache.value
                        .filter(item => item.label.toLowerCase().includes(q))
                        .slice(0, 10);
                };

                const selectSearchResult = async (item) => {
                    // Reset search
                    searchQuery.value = '';
                    searchResults.value = [];

                    // Set State
                    mode.value = 'student';
                    // We need to wait for Vue to update watchers? 
                    // No, we can just set values directly, but we need to ensure faculties are loaded.

                    selectedFaculty.value = item.facultyId;
                    await loadGroups(); // Fetch groups for this faculty to populate the dropdown (optional but good for consistency)

                    selectedGroup.value = item.group;

                    // Trigger add
                    await addEntity();
                };

                // --- Time Highlighting ---
                const currentTime = ref(new Date());

                setInterval(() => {
                    currentTime.value = new Date();
                }, 60000); // Every minute

                const isActiveLesson = (dateStr, start, end) => {
                    if (!start || !end) return false;

                    const now = currentTime.value;

                    // Check Date
                    // dateStr is dd.mm.yyyy
                    const [d, m, y] = dateStr.split('.').map(Number);
                    if (now.getDate() !== d || (now.getMonth() + 1) !== m || now.getFullYear() !== y) {
                        return false;
                    }

                    // Check Time
                    // start/end is "HH:mm"
                    const [h1, m1] = start.split(':').map(Number);
                    const [h2, m2] = end.split(':').map(Number);

                    const nowMin = now.getHours() * 60 + now.getMinutes();
                    const startMin = h1 * 60 + m1;
                    const endMin = h2 * 60 + m2;

                    return nowMin >= startMin && nowMin < endMin;
                };

                onMounted(init);

                return {
                    mode,
                    loadingFilters,
                    loadingSchedule,
                    errorMessage,
                    faculties,
                    eduForms,
                    courses,
                    chairs,
                    groups,
                    employees,
                    selectedFaculty,
                    selectedEduForm,
                    selectedCourse,
                    selectedGroup,
                    selectedChair,
                    selectedEmployee,
                    dateStart,
                    dateEnd,
                    activeEntities,
                    onFacultyChange,
                    loadGroups,
                    loadEmployees,
                    addEntity,
                    removeEntity,
                    exportExcel,
                    canAdd,
                    groupedSchedule,
                    availableDisciplines,
                    selectedDisciplines,
                    toggleDiscipline,
                    isActiveLesson,
                    searchQuery,
                    searchResults,
                    isSearching,
                    onSearchInput,
                    selectSearchResult,
                    getColorClass
                };
            }
        }).mount('#app');
    </script>
</body>

</html>