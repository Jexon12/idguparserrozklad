<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π –†–æ–∑–∫–ª–∞–¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.5s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen font-sans text-gray-800">
    <div id="app" class="p-4 md:p-8">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-700 mb-2">üìÖ –ì–Ω—É—á–∫–∏–π –†–æ–∑–∫–ª–∞–¥</h1>
            <p class="text-gray-600">–û–±–µ—Ä—ñ—Ç—å –¥–µ–∫—ñ–ª—å–∫–∞ –≥—Ä—É–ø –∞–±–æ –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤ –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è</p>
        </header>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

            <!-- Sidebar: Controls -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">

                <!-- Tabs: Student vs Teacher -->
                <div class="flex mb-6 border-b">
                    <button @click="mode = 'student'"
                        :class="['flex-1 py-2 font-semibold transition', mode === 'student' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-400 hover:text-gray-600']">
                        –°—Ç—É–¥–µ–Ω—Ç
                    </button>
                    <button @click="mode = 'teacher'"
                        :class="['flex-1 py-2 font-semibold transition', mode === 'teacher' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-400 hover:text-gray-600']">
                        –í–∏–∫–ª–∞–¥–∞—á
                    </button>
                    <button @click="mode = 'occupancy'"
                        :class="['flex-1 py-2 font-semibold transition', mode === 'occupancy' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-400 hover:text-gray-600']">
                        –ó–∞–π–Ω—è—Ç—ñ—Å—Ç—å
                    </button>
                </div>

                <!-- Search Bar (Standard Mode Only) -->
                <div v-if="mode !== 'occupancy'" class="mb-6 relative">
                    <label class="block text-sm font-bold mb-1">üîç –®–≤–∏–¥–∫–∏–π –ø–æ—à—É–∫ –≥—Ä—É–ø–∏</label>
                    <input type="text" v-model="searchQuery" @input="onSearchInput" @focus="onSearchInput"
                        placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–ù-21..."
                        class="w-full border rounded p-2 focus:ring focus:ring-blue-200">

                    <!-- Dropdown Results -->
                    <div v-if="searchResults.length > 0"
                        class="absolute z-50 w-full bg-white border rounded-b shadow-lg max-h-60 overflow-y-auto">
                        <div v-for="(res, idx) in searchResults" :key="idx" @click="selectSearchResult(res)"
                            class="p-2 hover:bg-blue-50 cursor-pointer border-b last:border-b-0 text-sm flex items-center">
                            <span class="mr-2 text-lg">{{ res.type === 'group' ? 'üéì' : 'üë®‚Äçüè´' }}</span>
                            <div>
                                <div class="font-bold text-blue-700">{{ res.label ? res.label.split('(')[0] :
                                    res.value.Value }}</div>
                                <div class="text-gray-500 text-xs">{{ res.label }}</div>
                            </div>
                        </div>
                    </div>
                    <div v-if="isSearching" class="absolute right-2 top-8 flex items-center gap-2">
                        <span class="text-xs text-gray-400 animate-pulse whitespace-nowrap">{{ cacheStatus }}</span>
                        <div class="animate-spin h-4 w-4 border-2 border-blue-500 rounded-full border-t-transparent">
                        </div>
                    </div>
                    <div v-if="searchQuery && searchResults.length === 0 && !isSearching && isCacheLoaded"
                        class="absolute z-50 w-full bg-white border rounded-b shadow-lg p-3 text-sm text-gray-500 text-center">
                        –ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ üòû
                    </div>
                </div>

                <div v-if="loadingFilters" class="text-center py-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                </div>

                <div v-else class="space-y-4">
                    <!-- Faculty Filter (Common) - Hide in Occupancy -->
                    <!-- Faculty Filter (Common) - Hide in Occupancy -->
                    <div v-if="mode !== 'occupancy'">
                        <label class="block text-sm font-bold mb-1">–§–∞–∫—É–ª—å—Ç–µ—Ç</label>
                        <select v-model="selectedFaculty" @change="onFacultyChange"
                            class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                            <option value="">-- –û–±–µ—Ä—ñ—Ç—å —Ñ–∞–∫—É–ª—å—Ç–µ—Ç --</option>
                            <option v-for="fac in faculties" :key="fac.Key" :value="fac.Key">{{ fac.Value }}
                            </option>
                        </select>
                    </div>

                    <!-- Common Filter: Study Type -->
                    <div v-if="mode !== 'occupancy'">
                        <label class="block text-sm font-bold mb-1">–¢–∏–ø –∑–∞–Ω—è—Ç—Ç—è</label>
                        <select v-model="selectedStudyType"
                            class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                            <option value="">-- –í—Å—ñ —Ç–∏–ø–∏ --</option>
                            <option v-for="type in studyTypes" :key="type.Key" :value="type.Key">{{ type.Value }}
                            </option>
                        </select>
                    </div>

                    <!-- Student Filters -->
                    <div v-if="mode === 'student'">
                        <div>
                            <label class="block text-sm font-bold mb-1">–§–æ—Ä–º–∞ –Ω–∞–≤—á–∞–Ω–Ω—è</label>
                            <select v-model="selectedEduForm" @change="loadGroups"
                                class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                                <option value="">-- –í—Å—ñ --</option>
                                <option v-for="item in eduForms" :key="item.Key" :value="item.Key">{{ item.Value }}
                                </option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">–ö—É—Ä—Å</label>
                            <select v-model="selectedCourse" @change="loadGroups"
                                class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                                <option value="">-- –í—Å—ñ --</option>
                                <option v-for="item in courses" :key="item.Key" :value="item.Key">{{ item.Value }}
                                </option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-bold mb-1">–ì—Ä—É–ø–∞</label>
                            <select v-model="selectedGroup"
                                class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                                <option value="">-- –û–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É --</option>
                                <option v-for="grp in groups" :key="grp.Key" :value="grp">{{ grp.Value }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- Teacher Filters -->
                    <div v-else-if="mode === 'teacher'">
                        <div>
                            <label class="block text-sm font-bold mb-1">–ö–∞—Ñ–µ–¥—Ä–∞</label>
                            <select v-model="selectedChair" @change="loadEmployees"
                                class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                                <option value="">-- –û–±–µ—Ä—ñ—Ç—å –∫–∞—Ñ–µ–¥—Ä—É --</option>
                                <option v-for="chair in chairs" :key="chair.Key" :value="chair.Key">{{ chair.Value
                                    }}
                                </option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">–í–∏–∫–ª–∞–¥–∞—á</label>
                            <select v-model="selectedEmployee"
                                class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                                <option value="">-- –û–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞ --</option>
                                <option v-for="emp in employees" :key="emp.Key" :value="emp">{{ emp.Value }}
                                </option>
                            </select>
                        </div>
                    </div>

                    <!-- Occupancy Controls -->
                    <div v-if="mode === 'occupancy'">
                        <div>
                            <label class="block text-sm font-bold mb-1">–î–∞—Ç–∞ –∞–Ω–∞–ª—ñ–∑—É</label>
                            <input type="date" v-model="occupancyDate" class="w-full border rounded p-2 text-sm">
                        </div>

                        <div v-if="isScanning" class="mt-4">
                            <div class="text-sm font-bold text-blue-600 mb-1">–°–∫–∞–Ω—É–≤–∞–Ω–Ω—è...</div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                                <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-300"
                                    :style="{ width: (scanProgress.total ? (scanProgress.current / scanProgress.total * 100) : 0) + '%' }">
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 text-center">
                                {{ scanProgress.current }} / {{ scanProgress.total }}
                                <br>
                                {{ scanProgress.text }}
                                <span v-if="scanErrors > 0" class="text-red-500 font-bold ml-1">
                                    (–ü–æ–º–∏–ª–æ–∫: {{ scanErrors }})
                                </span>
                            </div>
                            <button @click="stopScan = true"
                                class="mt-2 text-xs text-red-500 underline w-full text-center">
                                –ó—É–ø–∏–Ω–∏—Ç–∏
                            </button>
                        </div>

                        <div v-else class="mt-4">
                            <button @click="startOccupancyScan"
                                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded transition">
                                üöÄ –ü–æ—á–∞—Ç–∏ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è
                            </button>
                            <p class="text-xs text-gray-500 mt-2 text-center">
                                –£–≤–∞–≥–∞: –¶–µ –∑–∞–π–º–µ –ø–µ–≤–Ω–∏–π —á–∞—Å (~30—Å). –ú–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ —Ä–æ–∑–∫–ª–∞–¥ —É—Å—ñ—Ö –≥—Ä—É–ø.
                            </p>
                        </div>
                        <p v-if="errorMessage" class="text-red-500 text-sm mt-2">{{ errorMessage }}</p>
                    </div>

                    <!-- Notes Manager (New Button) -->
                    <div v-if="mode !== 'occupancy'" class="pt-4 border-t">
                        <button @click="showAllNotesModal = true"
                            class="w-full bg-yellow-100 hover:bg-yellow-200 text-yellow-800 font-bold py-2 px-4 rounded transition flex items-center justify-center gap-2">
                            üìù –ö–µ—Ä—É–≤–∞—Ç–∏ –Ω–æ—Ç–∞—Ç–∫–∞–º–∏
                        </button>
                    </div>

                    <!-- Date Range and Add Button (Standard Mode Only) -->
                    <div v-if="mode !== 'occupancy'" class="space-y-4 pt-4 border-t">
                        <!-- Date Range -->
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-sm font-bold mb-1">–ó</label>
                                <input type="date" v-model="dateStart" class="w-full border rounded p-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">–ü–æ</label>
                                <input type="date" v-model="dateEnd" class="w-full border rounded p-2 text-sm">
                            </div>
                        </div>

                        <!-- Add Button -->
                        <button @click="addEntity" :disabled="!canAdd"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                            + –î–æ–¥–∞—Ç–∏ –¥–æ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è
                        </button>
                        <p v-if="errorMessage" class="text-red-500 text-sm mt-2">{{ errorMessage }}</p>
                    </div>

                    <!-- Export -->
                    <div v-if="Object.keys(groupedSchedule).length > 0" class="mt-6 pt-6 border-t">
                        <button v-if="Object.keys(groupedSchedule).length > 0" @click="exportExcel"
                            class="mt-6 pt-6 border-t w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition flex items-center justify-center gap-2">
                            <span>üì•</span> –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ Excel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Panel: Results -->
            <div class="lg:col-span-3 space-y-6">

                <!-- OCCUPANCY VIEW -->
                <div v-if="mode === 'occupancy'">
                    <div v-if="occupancyResults.length > 0" class="bg-white p-4 rounded-xl shadow">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <h3 class="font-bold text-lg text-gray-800">–ó–∞–π–Ω—è—Ç—ñ—Å—Ç—å –∞—É–¥–∏—Ç–æ—Ä—ñ–π ({{ occupancyDate
                                }})
                            </h3>

                            <div class="flex gap-2 w-full md:w-auto">
                                <input type="text" v-model="occupancySearch" placeholder="–ü–æ—à—É–∫ (–Ω–∞–ø—Ä. 110)..."
                                    class="border rounded px-3 py-1 text-sm focus:ring focus:ring-blue-200 flex-grow">
                                <button @click="exportOccupancy"
                                    class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-1 px-3 rounded transition flex items-center gap-2 whitespace-nowrap">
                                    <span>üì•</span> Excel
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div v-for="cab in filteredOccupancyResults" :key="cab.name"
                                class="border rounded-lg p-3 hover:shadow-md transition bg-gray-50">
                                <div class="font-bold text-lg text-gray-800 mb-2 flex justify-between">
                                    {{ cab.name }}
                                    <span class="text-xs font-normal bg-white border px-1 rounded text-gray-500">{{
                                        cab.building || '?' }}</span>
                                </div>
                                <div class="space-y-1">
                                    <div v-for="slot in [1,2,3,4,5,6,7]" :key="slot" class="flex items-center text-xs">
                                        <div class="w-6 font-bold text-gray-400">{{ slot }}</div>
                                        <div class="flex-1 h-6 rounded px-2 flex items-center overflow-hidden whitespace-nowrap"
                                            :class="cab.slots[slot] ? 'bg-red-100 text-red-800 border border-red-200' : 'bg-green-100 text-green-800 border border-green-200'">
                                            <span v-if="cab.slots[slot]" class="truncate">
                                                {{ cab.slots[slot].group }} ({{ cab.slots[slot].teacher }})
                                            </span>
                                            <span v-else class="text-green-600 font-bold">–í—ñ–ª—å–Ω–∞</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Scan Empty State or No Matches -->
                        <div v-if="occupancyResults.length > 0 && filteredOccupancyResults.length === 0"
                            class="text-center py-8 text-gray-500">
                            –ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ –∑–∞–ø–∏—Ç–æ–º "{{ occupancySearch }}" üòû
                        </div>

                    </div>

                    <div v-else-if="!isScanning" class="bg-white p-12 rounded-xl shadow text-center text-gray-400">
                        <p class="text-xl">–î–∞–Ω—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ</p>
                        <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ü–æ—á–∞—Ç–∏ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è", —â–æ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∑–∞–π–Ω—è—Ç—ñ—Å—Ç—å</p>
                    </div>
                </div>

                <!-- STANDARD VIEW -->
                <div v-else>
                    <!-- Statistics Block -->
                    <div v-if="activeEntities.length > 0" class="bg-white p-4 rounded-xl shadow mb-6">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center">
                            üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–æ–∑–∫–ª–∞–¥—É
                            <span class="ml-auto text-xs font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
                                –í—Å—å–æ–≥–æ –ø–∞—Ä: {{ scheduleStats.totalPairs }}
                            </span>
                        </h3>
                        <div class="space-y-3">
                            <div v-for="subj in scheduleStats.topSubjects" :key="subj.name">
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="truncate pr-2 font-medium text-gray-700">{{ subj.name }}</span>
                                    <span class="text-gray-500">{{ subj.count }} ({{ subj.percent }}%)</span>
                                </div>
                                <div class="w-full bg-gray-100 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full transition-all duration-1000"
                                        :style="{ width: subj.percent + '%' }"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Helper message if empty -->
                    <div v-if="activeEntities.length === 0"
                        class="bg-white p-12 rounded-xl shadow text-center text-gray-400">
                        <p class="text-xl">–°–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</p>
                        <p>–î–æ–¥–∞–π—Ç–µ –≥—Ä—É–ø—É –∞–±–æ –≤–∏–∫–ª–∞–¥–∞—á–∞, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥</p>
                    </div>

                    <!-- Global Controls (Discipline Filter) -->
                    <div v-if="activeEntities.length > 0" class="bg-white p-4 rounded-xl shadow">
                        <div class="flex justify-between items-center mb-2">
                            <div class="font-bold text-gray-700">–§—ñ–ª—å—Ç—Ä (–ü—Ä–µ–¥–º–µ—Ç–∏, –í–∏–∫–ª–∞–¥–∞—á—ñ):</div>
                            <div class="flex gap-2">
                                <button @click="selectedDisciplines = []" :disabled="selectedDisciplines.length === 0"
                                    :class="['text-xs font-medium underline transition', selectedDisciplines.length > 0 ? 'text-red-500 hover:text-red-700 cursor-pointer' : 'text-gray-300 cursor-not-allowed']">
                                    –°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä
                                </button>
                                <button @click="clearAll"
                                    class="text-xs text-gray-400 hover:text-red-600 font-medium underline">
                                    –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ
                                </button>
                                <button v-if="activeEntities.length > 1" @click="findCommonFreeSlots"
                                    class="text-xs bg-indigo-100 text-indigo-700 hover:bg-indigo-200 font-bold px-2 py-1 rounded transition">
                                    üîç –ó–Ω–∞–π—Ç–∏ –≤—ñ–∫–Ω–∞
                                </button>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <!-- "All" Chip -->
                            <button @click="selectedDisciplines = []" :class="['px-3 py-1 rounded-full text-sm border transition', 
                                    selectedDisciplines.length === 0 
                                    ? 'bg-blue-600 text-white border-blue-600 font-bold shadow-md' 
                                    : 'bg-gray-100 text-gray-600 border-gray-200 hover:bg-gray-200']">
                                –í—Å—ñ –ø—Ä–µ–¥–º–µ—Ç–∏
                            </button>

                            <!-- Discipline Chips -->
                            <button v-for="disc in availableDisciplines" :key="disc" @click="toggleDiscipline(disc)"
                                :class="['px-3 py-1 rounded-full text-sm border transition text-left', 
                                    selectedDisciplines.includes(disc) 
                                    ? 'bg-blue-100 text-blue-800 border-blue-300 font-semibold shadow-sm ring-1 ring-blue-300' 
                                    : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50']">
                                {{ disc }}
                            </button>
                        </div>
                    </div>

                    <!-- Active Entities List -->
                    <div v-else class="flex flex-wrap gap-3">
                        <div v-for="(entity, index) in activeEntities" :key="index"
                            class="flex items-center bg-white border border-blue-200 text-blue-800 px-4 py-2 rounded-full shadow-sm">
                            <span class="font-medium mr-2">{{ entity.name }}</span>
                            <span class="text-xs text-gray-500 uppercase mr-3">({{ entity.type }})</span>
                            <button @click="removeEntity(index)"
                                class="text-red-400 hover:text-red-700 font-bold">‚úï</button>
                        </div>
                    </div>

                    <!-- Schedule Grid -->
                    <!-- We group by DATE, then by TIME slot -->
                    <div v-if="Object.keys(groupedSchedule).length > 0"
                        class="bg-white rounded-xl shadow overflow-hidden">
                        <div v-for="dayData in groupedSchedule" :key="dayData.date" class="border-b last:border-b-0">
                            <div
                                class="bg-gray-50 px-6 py-3 border-b border-gray-100 flex justify-between items-center">
                                <h3 class="font-bold text-lg text-gray-800">{{ dayData.dayName }}, {{
                                    dayData.date
                                    }}
                                </h3>
                            </div>

                            <div class="divide-y divide-gray-100">
                                <div v-for="timeSlot in dayData.slots" :key="timeSlot.time"
                                    class="grid grid-cols-12 hover:bg-gray-50 transition p-4">
                                    <!-- Time Column -->
                                    <div
                                        class="col-span-12 md:col-span-2 text-center md:text-left mb-2 md:mb-0 flex flex-row md:flex-col items-center md:items-start gap-2 md:gap-1">
                                        <span
                                            class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded whitespace-nowrap">
                                            {{ timeSlot.time }}
                                        </span>
                                        <span v-if="timeSlot.start" class="text-sm text-gray-500 font-medium">
                                            {{ timeSlot.start }} - {{ timeSlot.end }}
                                        </span>
                                    </div>

                                    <!-- Classes Column -->
                                    <div class="col-span-12 md:col-span-10 grid gap-4">
                                        <div v-for="(lesson, idx) in timeSlot.lessons" :key="idx"
                                            class="bg-white border rounded-lg p-3 shadow-sm relative pl-4 border-l-4 transition-all duration-500"
                                            :class="[
                                                getColorClass(lesson.entityId),
                                                isActiveLesson(dayData.date, timeSlot.start, timeSlot.end) ? 'ring-4 ring-green-400 scale-[1.02] z-10' : ''
                                            ]">

                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <div v-if="isActiveLesson(dayData.date, timeSlot.start, timeSlot.end)"
                                                        class="inline-block bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full mb-1 animate-pulse">
                                                        –ó–ê–†–ê–ó
                                                    </div>

                                                    <!-- Progress Bar -->
                                                    <div v-if="isActiveLesson(dayData.date, timeSlot.start, timeSlot.end)"
                                                        class="mb-2">
                                                        <div
                                                            class="flex justify-between text-[10px] text-gray-500 mb-1">
                                                            <span>–ü—Ä–æ–≥—Ä–µ—Å: {{ getLessonProgress(dayData.date,
                                                                timeSlot.start, timeSlot.end)?.percent
                                                                }}%</span>
                                                            <span>–ó–∞–ª–∏—à–∏–ª–æ—Å—å: {{ getLessonProgress(dayData.date,
                                                                timeSlot.start, timeSlot.end)?.timeLeft }}
                                                                —Ö–≤</span>
                                                        </div>
                                                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                                                            <div class="bg-blue-600 h-1.5 rounded-full transition-all duration-1000"
                                                                :style="{ width: getLessonProgress(dayData.date, timeSlot.start, timeSlot.end)?.percent + '%' }">
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- 1. Discipline + Group -->
                                                    <h4 class="font-bold text-gray-900 text-base mb-1">
                                                        {{ lesson.discipline }}
                                                        <span v-if="lesson.group" class="text-blue-600 font-normal">
                                                            ({{ lesson.group }})
                                                        </span>
                                                    </h4>

                                                    <!-- 2. Type -->
                                                    <div class="text-sm text-gray-500 mb-1" v-if="lesson.type">
                                                        üè∑Ô∏è {{ lesson.type }}
                                                    </div>

                                                    <!-- 3. Teacher -->
                                                    <div
                                                        class="text-sm text-gray-700 font-medium flex flex-wrap items-center gap-2">
                                                        <span v-if="lesson.teacher" class="flex items-center">
                                                            üë®‚Äç <span v-html="lesson.teacher" class="ml-1"></span>
                                                        </span>
                                                        <span v-if="lesson.cabinet" class="text-gray-400 text-xs ml-2">
                                                            üìç {{ lesson.cabinet }}
                                                        </span>
                                                    </div>

                                                </div>

                                                <!-- Global Links Buttons -->
                                                <div class="mt-2 flex gap-2">
                                                    <a v-if="getGlobalLink(lesson, 'courseUrl')"
                                                        :href="getGlobalLink(lesson, 'courseUrl')" target="_blank"
                                                        class="text-xs bg-blue-50 text-blue-700 border border-blue-200 px-2 py-1 rounded hover:bg-blue-100 font-medium flex items-center gap-1">
                                                        üìò –ö—É—Ä—Å
                                                    </a>
                                                    <a v-if="getGlobalLink(lesson, 'onlineUrl')"
                                                        :href="getGlobalLink(lesson, 'onlineUrl')" target="_blank"
                                                        class="text-xs bg-purple-50 text-purple-700 border border-purple-200 px-2 py-1 rounded hover:bg-purple-100 font-medium flex items-center gap-1">
                                                        üìπ –û–Ω–ª–∞–π–Ω
                                                    </a>
                                                </div>

                                                <!-- Admin Edit Button -->
                                                <button v-if="adminMode" @click.stop="openAdminModal(lesson)"
                                                    class="absolute top-2 right-2 text-xs bg-gray-600 text-white px-1 rounded opacity-50 hover:opacity-100 z-20">
                                                    ‚úèÔ∏è
                                                </button>

                                                <!-- Note Indicator/Button -->
                                                <div class="mt-2 flex justify-end">
                                                    <button @click.stop="openNote(lesson, dayData.date, timeSlot.time)"
                                                        class="text-xs px-2 py-1 rounded transition flex items-center gap-1"
                                                        :class="hasNote(lesson, dayData.date, timeSlot.time) ? 'bg-yellow-100 text-yellow-800 font-semibold' : 'text-gray-400 hover:text-gray-600 hover:bg-gray-50'">
                                                        <span v-if="hasNote(lesson, dayData.date, timeSlot.time)">üìù
                                                            –Ñ
                                                            –Ω–æ—Ç–∞—Ç–∫–∞</span>
                                                        <span v-else>‚ûï –ù–æ—Ç–∞—Ç–∫–∞</span>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="hidden md:block text-right">
                                                <span
                                                    class="text-xs font-bold uppercase tracking-wider text-gray-400 bg-gray-100 px-2 py-1 rounded">
                                                    {{ lesson.entityName }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="activeEntities.length > 0 && Object.keys(groupedSchedule).length === 0 && !loadingSchedule"
                    class="text-center py-10 text-gray-500">
                    –ù–∞ –≤–∏–±—Ä–∞–Ω–∏–π –ø–µ—Ä—ñ–æ–¥ —Ä–æ–∑–∫–ª–∞–¥—É –Ω–µ–º–∞—î.
                </div>

                <div v-if="loadingSchedule" class="text-center py-10">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="text-gray-500 mt-2">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—É...</p>
                </div>




                <!-- Modal: Admin Link Editor -->
                <div v-if="showAdminModal"
                    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] p-4"
                    @click.self="showAdminModal = false">
                    <div class="bg-white rounded-xl shadow-xl max-w-md w-full flex flex-col">
                        <div class="p-4 border-b bg-gray-100 rounded-t-xl">
                            <h3 class="font-bold text-lg text-gray-800">üîß –ê–¥–º—ñ–Ω: –ü–æ—Å–∏–ª–∞–Ω–Ω—è</h3>
                            <p class="text-xs text-gray-600 truncate">{{ adminTargetTitle }}</p>
                            <p class="text-[10px] text-gray-400 font-mono">{{ adminTargetKey }}</p>
                        </div>

                        <div class="p-4 space-y-4">
                            <div>
                                <label class="block text-sm font-bold mb-1">üîó –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∫—É—Ä—Å</label>
                                <input type="text" v-model="adminForm.courseUrl" placeholder="https://moodle..."
                                    class="w-full border rounded p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">üìπ –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –æ–Ω–ª–∞–π–Ω –ø–∞—Ä—É</label>
                                <input type="text" v-model="adminForm.onlineUrl" placeholder="https://zoom.us/..."
                                    class="w-full border rounded p-2">
                            </div>
                        </div>

                        <div class="p-4 border-t flex justify-end gap-2">
                            <button @click="showAdminModal = false"
                                class="text-gray-500 hover:bg-gray-100 font-bold py-2 px-4 rounded">
                                –°–∫–∞—Å—É–≤–∞—Ç–∏
                            </button>
                            <button @click="saveAdminLinks"
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                                –ó–±–µ—Ä–µ–≥—Ç–∏ (–°–µ—Ä–≤–µ—Ä)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <footer class="mt-12 text-center pb-8 text-gray-400 text-sm">
                    <a href="http://wp-fuaid.zzz.com.ua/r"
                        class="inline-block text-blue-600 hover:text-blue-800 font-semibold border-b-2 border-transparent hover:border-blue-600 transition mb-2">
                        ‚¨Ö –ù–∞ –≥–æ–ª–æ–≤–Ω—É
                    </a>
                    <div>
                        <button @click="toggleAdminLogin" class="hover:text-gray-600">Admin</button>
                    </div>
                </footer>


                <!-- Modal: Free Time -->
                <div v-if="showFreeTimeModal"
                    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                    @click.self="showFreeTimeModal = false">
                    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[80vh] flex flex-col">
                        <div class="p-4 border-b flex justify-between items-center bg-indigo-50 rounded-t-xl">
                            <h3 class="font-bold text-lg text-indigo-800">ü§ù –°–ø—ñ–ª—å–Ω–∏–π –≤—ñ–ª—å–Ω–∏–π —á–∞—Å</h3>
                            <button @click="showFreeTimeModal = false"
                                class="text-gray-500 hover:text-gray-800 text-2xl">√ó</button>
                        </div>

                        <div class="p-4 overflow-y-auto">
                            <p class="text-sm text-gray-600 mb-4">
                                –ó–Ω–∞–π–¥–µ–Ω–æ –≤ —Å–ø—ñ–ª—å–Ω—ñ "–≤—ñ–∫–Ω–∞" –¥–ª—è –≤–∏–±—Ä–∞–Ω–∏—Ö –≥—Ä—É–ø/–≤–∏–∫–ª–∞–¥–∞—á—ñ–≤ (–∫—Ä—ñ–º –≤–∏—Ö—ñ–¥–Ω–∏—Ö):
                            </p>

                            <div v-if="commonFreeSlots.length === 0" class="text-center py-8 text-gray-400">
                                –ù–∞ –∂–∞–ª—å, —Å–ø—ñ–ª—å–Ω–∏—Ö –≤—ñ–∫–æ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ üòî
                            </div>

                            <div v-else class="space-y-4">
                                <div v-for="day in commonFreeSlots" :key="day.date"
                                    class="border rounded-lg p-3 bg-gray-50">
                                    <div class="font-bold text-gray-800 border-b pb-1 mb-2">{{ day.date }}</div>
                                    <div class="grid grid-cols-3 gap-2">
                                        <div v-for="slot in day.slots" :key="slot.pair"
                                            class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded text-center border border-green-200">
                                            {{ slot.pair }} –ø–∞—Ä–∞
                                            <div class="font-normal text-green-600 text-[10px]">{{ slot.time }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 border-t text-right">
                            <button @click="showFreeTimeModal = false"
                                class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">
                                –ó–∞–∫—Ä–∏—Ç–∏
                            </button>
                        </div>
                    </div>
                </div>



                <!-- Modal: Edit Note -->
                <div v-if="showNoteModal"
                    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4"
                    @click.self="showNoteModal = false">
                    <div class="bg-white rounded-xl shadow-xl max-w-md w-full flex flex-col">
                        <div class="p-4 border-b bg-yellow-50 rounded-t-xl">
                            <h3 class="font-bold text-lg text-yellow-800">üìù –ù–æ—Ç–∞—Ç–∫–∞</h3>
                            <p class="text-xs text-yellow-600 truncate">{{ currentNoteTitle }}</p>
                        </div>

                        <div class="p-4">
                            <textarea v-model="noteText" rows="5"
                                placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à –∑–∞–ø–∏—Å —Ç—É—Ç (–Ω–∞–ø—Ä. '–î/–ó: –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Å—Ç. 20')"
                                class="w-full border rounded-lg p-3 focus:ring focus:ring-yellow-200 resize-none"></textarea>
                        </div>

                        <div class="p-4 border-t flex justify-end gap-2">
                            <button @click="showNoteModal = false"
                                class="text-gray-500 hover:bg-gray-100 font-bold py-2 px-4 rounded">
                                –°–∫–∞—Å—É–≤–∞—Ç–∏
                            </button>
                            <button @click="saveNote"
                                class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">
                                –ó–±–µ—Ä–µ–≥—Ç–∏
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: All Notes Manager -->
        <div v-if="showAllNotesModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4"
            @click.self="showAllNotesModal = false">
            <div class="bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[80vh] flex flex-col">
                <div class="p-4 border-b bg-yellow-50 rounded-t-xl flex justify-between items-center">
                    <h3 class="font-bold text-lg text-yellow-800">üìã –í—Å—ñ –Ω–æ—Ç–∞—Ç–∫–∏</h3>
                    <button @click="showAllNotesModal = false"
                        class="text-gray-500 hover:text-gray-800 text-2xl">√ó</button>
                </div>

                <div class="p-4 overflow-y-auto space-y-3">
                    <div v-if="allNotesList.length === 0" class="text-center text-gray-400 py-8">
                        –°–ø–∏—Å–æ–∫ –Ω–æ—Ç–∞—Ç–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π
                    </div>
                    <div v-for="n in allNotesList" :key="n.key"
                        class="bg-yellow-50 border border-yellow-200 rounded p-3 relative group">
                        <p class="text-sm text-gray-800 whitespace-pre-wrap">{{ n.text }}</p>
                        <div class="text-[10px] text-gray-400 mt-1 font-mono truncate">{{ n.key }}</div>
                        <button @click="deleteNote(n.key)"
                            class="absolute top-2 right-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            </div>
        </div>






        <!-- Float Settings Button -->
        <button @click="showSettingsModal = true"
            class="fixed bottom-4 right-4 bg-gray-800 text-white p-3 rounded-full shadow-lg hover:bg-gray-700 z-50 transition"
            title="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è">
            ‚öôÔ∏è
        </button>


        <!-- Settings Modal -->
        <div v-if="showSettingsModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-11/12 max-w-lg shadow-xl relative">
                <button @click="showSettingsModal = false"
                    class="absolute top-2 right-2 text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>

                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span>‚öôÔ∏è</span> –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —á–∞—Å—É –ø–∞—Ä
                </h3>

                <div class="bg-blue-50 p-3 rounded-md mb-4 text-sm text-gray-700">
                    –¢—É—Ç –≤–∏ –º–æ–∂–µ—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ —á–∞—Å –ø–æ—á–∞—Ç–∫—É —Ç–∞ –∫—ñ–Ω—Ü—è –ø–∞—Ä. –¶—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂—É—Ç—å—Å—è –Ω–∞ —Ü—å–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó.
                </div>

                <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                    <div v-for="(time, pairNum) in customTimes" :key="pairNum"
                        class="flex items-center justify-between">
                        <span class="font-bold w-16">{{ pairNum }} –ø–∞—Ä–∞:</span>
                        <div class="flex items-center gap-2">
                            <input type="time" v-model="customTimes[pairNum].start"
                                class="border rounded px-2 py-1 text-sm">
                            <span>-</span>
                            <input type="time" v-model="customTimes[pairNum].end"
                                class="border rounded px-2 py-1 text-sm">
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <button @click="resetCustomTimes" class="text-red-500 hover:text-red-700 text-sm underline">
                            –°–∫–∏–Ω—É—Ç–∏
                        </button>
                        <button v-if="!adminMode" @click="toggleAdminLogin"
                            class="text-gray-300 hover:text-gray-500 text-xs">
                            –ê–¥–º—ñ–Ω
                        </button>
                    </div>

                    <div class="flex gap-2">
                        <button v-if="adminMode" @click="saveGlobalTimes"
                            class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 shadow transition flex items-center gap-1">
                            <span>üåç</span> –í—Å—ñ–º
                        </button>
                        <button @click="saveState(); showSettingsModal = false"
                            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 shadow transition">
                            –ó–±–µ—Ä–µ–≥—Ç–∏
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div> <!-- End of #app -->

    <script src="js/app.js"></script>
</body>

</html>