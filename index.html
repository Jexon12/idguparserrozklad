<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="–£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π —Ä–æ–∑–∫–ª–∞–¥ –∑–∞–Ω—è—Ç—å ‚Äî –ø–µ—Ä–µ–≥–ª—è–¥ —Ä–æ–∑–∫–ª–∞–¥—É –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ —Ç–∞ –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤, –∑–∞–π–Ω—è—Ç—ñ—Å—Ç—å –∞—É–¥–∏—Ç–æ—Ä—ñ–π">
    <meta name="theme-color" content="#1d4ed8">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÖ</text></svg>">
    <title>–£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π –†–æ–∑–∫–ª–∞–¥</title>
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://cdn.sheetjs.com" crossorigin>
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: {} }
        };
    </script>
    <script src="https://unpkg.com/vue@3.4.21/dist/vue.global.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="css/styles.css">
    <script>
        // Auto-detect dark mode
        if (localStorage.getItem('darkMode') === 'true' ||
            (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 min-h-screen font-sans text-gray-800 dark:text-gray-200 transition-colors">
    <div id="app" class="min-h-screen">
        <!-- Toast Notification -->
        <div class="toast" :class="{ show: toastVisible }">{{ toastMessage }}</div>

        <!-- Global Sticky Status Bar -->
        <div v-if="currentLessonInfo"
            class="sticky top-0 z-[60] bg-green-600 text-white shadow-md px-4 py-2 flex items-center justify-between animate-slide-down">
            <div class="flex items-center gap-3 overflow-hidden">
                <div class="flex flex-col leading-tight min-w-0">
                    <span class="text-[10px] font-bold opacity-80 uppercase tracking-wider">–ó–∞—Ä–∞–∑ —ñ–¥–µ</span>
                    <span class="font-bold truncate text-sm">{{ currentLessonInfo.discipline }}</span>
                    <span class="text-[10px] opacity-90 truncate">{{ currentLessonInfo.type }} ¬∑ {{
                        currentLessonInfo.cabinet }}</span>
                </div>
            </div>
            <div class="flex flex-col items-end min-w-[70px] ml-2">
                <span class="font-bold font-mono text-lg leading-none">{{ currentLessonInfo.timeLeftStr }}</span>
                <div class="w-full bg-green-800/50 rounded-full h-1 mt-1">
                    <div class="bg-white h-1 rounded-full transition-all duration-1000"
                        :style="{ width: currentLessonInfo.percent + '%' }"></div>
                </div>
            </div>
        </div>

        <div class="p-4 md:p-8">
            <!-- Header -->
            <header class="mb-8 text-center relative">
                <div class="flex items-center justify-between md:justify-center">
                    <button @click="sidebarOpen = true"
                        class="mobile-menu-btn items-center justify-center p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition text-xl">
                        ‚ò∞
                    </button>
                    <h1 class="text-2xl md:text-4xl font-bold text-amber-700 dark:text-amber-400 mb-0 md:mb-2">üìÖ
                        –ì–Ω—É—á–∫–∏–π
                        –†–æ–∑–∫–ª–∞–¥</h1>
                    <button @click="toggleDarkMode"
                        class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition text-xl"
                        :title="isDark ? '–°–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞' : '–¢–µ–º–Ω–∞ —Ç–µ–º–∞'">
                        {{ isDark ? '‚òÄÔ∏è' : 'üåô' }}
                    </button>
                </div>
                <p class="text-gray-600 dark:text-gray-400 hidden md:block mt-1">–û–±–µ—Ä—ñ—Ç—å –¥–µ–∫—ñ–ª—å–∫–∞ –≥—Ä—É–ø –∞–±–æ –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤
                    –¥–ª—è
                    –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è</p>
            </header>

            <!-- MODALS MOVED HERE TO ENSURE SCOPE -->

            <!-- Modal: Admin Link Editor -->
            <div v-if="showAdminModal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] p-4"
                @click.self="showAdminModal = false">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full flex flex-col">
                    <div class="p-4 border-b dark:border-gray-700 bg-gray-100 dark:bg-gray-700 rounded-t-xl">
                        <h3 class="font-bold text-lg text-gray-800 dark:text-gray-200">üîß –ê–¥–º—ñ–Ω: –ü–æ—Å–∏–ª–∞–Ω–Ω—è</h3>
                        <p class="text-xs text-gray-600 dark:text-gray-400 truncate">{{ adminTargetTitle }}</p>
                        <p class="text-[10px] text-gray-400 dark:text-gray-500 font-mono">{{ adminTargetKey }}</p>
                    </div>

                    <div class="p-4 space-y-4">
                        <div>
                            <label class="block text-sm font-bold mb-1 dark:text-gray-300">üîó –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∫—É—Ä—Å</label>
                            <input type="text" v-model="adminForm.courseUrl" placeholder="https://moodle..."
                                class="w-full border rounded p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1 dark:text-gray-300">üìπ –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –æ–Ω–ª–∞–π–Ω
                                –ø–∞—Ä—É</label>
                            <input type="text" v-model="adminForm.onlineUrl" placeholder="https://zoom.us/..."
                                class="w-full border rounded p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                    </div>

                    <div class="p-4 border-t dark:border-gray-700 flex justify-end gap-2">
                        <button @click="showAdminModal = false"
                            class="text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 font-bold py-2 px-4 rounded">
                            –°–∫–∞—Å—É–≤–∞—Ç–∏
                        </button>
                        <button @click="saveAdminLinks"
                            class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded">
                            –ó–±–µ—Ä–µ–≥—Ç–∏ (–°–µ—Ä–≤–µ—Ä)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal: Free Time -->
            <div v-if="showFreeTimeModal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                @click.self="showFreeTimeModal = false">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-lg w-full max-h-[80vh] flex flex-col">
                    <div
                        class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-indigo-50 dark:bg-indigo-900/30 rounded-t-xl">
                        <h3 class="font-bold text-lg text-indigo-800 dark:text-indigo-300">ü§ù –°–ø—ñ–ª—å–Ω–∏–π –≤—ñ–ª—å–Ω–∏–π —á–∞—Å</h3>
                        <button @click="showFreeTimeModal = false"
                            class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-300 text-2xl">√ó</button>
                    </div>

                    <div class="p-4 overflow-y-auto">
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                            –ó–Ω–∞–π–¥–µ–Ω–æ –≤ —Å–ø—ñ–ª—å–Ω—ñ "–≤—ñ–∫–Ω–∞" –¥–ª—è –≤–∏–±—Ä–∞–Ω–∏—Ö –≥—Ä—É–ø/–≤–∏–∫–ª–∞–¥–∞—á—ñ–≤ (–∫—Ä—ñ–º –≤–∏—Ö—ñ–¥–Ω–∏—Ö):
                        </p>

                        <div v-if="commonFreeSlots.length === 0"
                            class="text-center py-8 text-gray-400 dark:text-gray-500">
                            –ù–∞ –∂–∞–ª—å, —Å–ø—ñ–ª—å–Ω–∏—Ö –≤—ñ–∫–æ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ üòî
                        </div>

                        <div v-else class="space-y-4">
                            <div v-for="day in commonFreeSlots" :key="day.date"
                                class="border dark:border-gray-700 rounded-lg p-3 bg-gray-50 dark:bg-gray-700">
                                <div
                                    class="font-bold text-gray-800 dark:text-gray-200 border-b dark:border-gray-600 pb-1 mb-2">
                                    {{ day.date }}</div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div v-for="slot in day.slots" :key="slot.pair"
                                        class="bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 text-xs font-bold px-2 py-1 rounded text-center border border-green-200 dark:border-green-700">
                                        {{ slot.pair }} –ø–∞—Ä–∞
                                        <div class="font-normal text-green-600 dark:text-green-400 text-[10px]">{{
                                            slot.time }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 border-t dark:border-gray-700 text-right">
                        <button @click="showFreeTimeModal = false"
                            class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded">
                            –ó–∞–∫—Ä–∏—Ç–∏
                        </button>
                    </div>
                </div>
            </div>



            <!-- Modal: Edit Note -->
            <div v-if="showNoteModal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4"
                @click.self="showNoteModal = false">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full flex flex-col">
                    <div class="p-4 border-b dark:border-gray-700 bg-yellow-50 dark:bg-yellow-900/20 rounded-t-xl">
                        <h3 class="font-bold text-lg text-yellow-800 dark:text-yellow-300">üìù –ù–æ—Ç–∞—Ç–∫–∞</h3>
                        <p class="text-xs text-yellow-600 dark:text-yellow-400 truncate">{{ currentNoteTitle }}</p>
                    </div>

                    <div class="p-4">
                        <textarea v-model="noteText" rows="5"
                            placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à –∑–∞–ø–∏—Å —Ç—É—Ç (–Ω–∞–ø—Ä. '–î/–ó: –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Å—Ç. 20')"
                            class="w-full border dark:border-gray-600 rounded-lg p-3 focus:ring focus:ring-yellow-200 dark:focus:ring-yellow-800 resize-none dark:bg-gray-700 dark:text-white"></textarea>
                    </div>

                    <div class="p-4 border-t dark:border-gray-700 flex justify-end gap-2">
                        <button @click="showNoteModal = false"
                            class="text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 font-bold py-2 px-4 rounded">
                            –°–∫–∞—Å—É–≤–∞—Ç–∏
                        </button>
                        <button @click="saveNote"
                            class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">
                            –ó–±–µ—Ä–µ–≥—Ç–∏
                        </button>
                    </div>
                </div>
            </div>


            <!-- Modal: All Notes Manager -->
            <div v-if="showAllNotesModal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4"
                @click.self="showAllNotesModal = false">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-lg w-full max-h-[80vh] flex flex-col">
                    <div
                        class="p-4 border-b dark:border-gray-700 bg-yellow-50 dark:bg-yellow-900/20 rounded-t-xl flex justify-between items-center">
                        <h3 class="font-bold text-lg text-yellow-800 dark:text-yellow-300">üìã –í—Å—ñ –Ω–æ—Ç–∞—Ç–∫–∏</h3>
                        <button @click="showAllNotesModal = false"
                            class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-300 text-2xl">√ó</button>
                    </div>

                    <div class="p-4 overflow-y-auto space-y-3">
                        <div v-if="allNotesList.length === 0" class="text-center text-gray-400 dark:text-gray-500 py-8">
                            –°–ø–∏—Å–æ–∫ –Ω–æ—Ç–∞—Ç–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π
                        </div>
                        <div v-for="n in allNotesList" :key="n.key"
                            class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded p-3 relative group">
                            <p class="text-sm text-gray-800 dark:text-gray-200 whitespace-pre-wrap">{{ n.text }}</p>
                            <div class="text-[10px] text-gray-400 dark:text-gray-500 mt-1 font-mono truncate">{{ n.key
                                }}</div>
                            <button @click="deleteNote(n.key)"
                                class="absolute top-2 right-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                </div>
            </div>






            <!-- Float Settings Button -->
            <button @click="showSettingsModal = true"
                class="fixed bottom-4 right-4 bg-gray-800 text-white p-3 rounded-full shadow-lg hover:bg-gray-700 z-50 transition"
                title="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è">
                ‚öôÔ∏è
            </button>


            <!-- Settings Modal -->
            <div v-if="showSettingsModal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-11/12 max-w-lg shadow-xl relative">
                    <button @click="showSettingsModal = false"
                        class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12">
                            </path>
                        </svg>
                    </button>

                    <h3 class="text-xl font-bold mb-4 flex items-center gap-2 dark:text-gray-200">
                        <span>‚öôÔ∏è</span> –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —á–∞—Å—É –ø–∞—Ä
                    </h3>

                    <div
                        class="bg-amber-50 dark:bg-amber-900/20 p-3 rounded-md mb-4 text-sm text-gray-700 dark:text-gray-300">
                        –¢—É—Ç –≤–∏ –º–æ–∂–µ—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ —á–∞—Å –ø–æ—á–∞—Ç–∫—É —Ç–∞ –∫—ñ–Ω—Ü—è –ø–∞—Ä. –¶—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂—É—Ç—å—Å—è –Ω–∞ —Ü—å–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó.
                    </div>

                    <div class="mb-6 border-b dark:border-gray-700 pb-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-bold dark:text-gray-200">–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è (–∑–∞ 5 —Ö–≤)</span>
                            <button @click="requestNotificationPermission"
                                class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none"
                                :class="notificationsEnabled ? 'bg-amber-600' : 'bg-gray-200 dark:bg-gray-700'">
                                <span
                                    class="translate-x-1 inline-block h-4 w-4 transform rounded-full bg-white transition"
                                    :class="notificationsEnabled ? 'translate-x-6' : 'translate-x-1'"></span>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            –ü—Ä–∞—Ü—é—î, –∫–æ–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞ (–º–æ–∂–Ω–∞ –∑–≥–æ—Ä–Ω—É—Ç–∏).
                        </p>
                    </div>

                    <!-- Auto-Refresh Settings -->
                    <div class="mb-6 border-b dark:border-gray-700 pb-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-bold dark:text-gray-200">–ê–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—É</span>
                            <button @click="toggleAutoRefresh"
                                class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none"
                                :class="autoRefreshEnabled ? 'bg-amber-600' : 'bg-gray-200 dark:bg-gray-700'">
                                <span
                                    class="translate-x-1 inline-block h-4 w-4 transform rounded-full bg-white transition"
                                    :class="autoRefreshEnabled ? 'translate-x-6' : 'translate-x-1'"></span>
                            </button>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400"
                            :class="{ 'opacity-50': !autoRefreshEnabled }">
                            <span>–ü–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –∫–æ–∂–Ω—ñ</span>
                            <input type="number" min="1" max="60" :value="autoRefreshInterval"
                                @input="setAutoRefreshInterval($event.target.value)" :disabled="!autoRefreshEnabled"
                                class="w-16 border dark:border-gray-600 rounded px-2 py-1 text-center dark:bg-gray-700 dark:text-gray-300">
                            <span>—Ö–≤–∏–ª–∏–Ω</span>
                        </div>
                    </div>

                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <div v-for="(time, pairNum) in customTimes" :key="pairNum"
                            class="flex items-center justify-between">
                            <span class="font-bold w-16 dark:text-gray-300">{{ pairNum }} –ø–∞—Ä–∞:</span>
                            <div class="flex items-center gap-2">
                                <input type="time" v-model="customTimes[pairNum].start"
                                    class="border dark:border-gray-600 rounded px-2 py-1 text-sm dark:bg-gray-700 dark:text-white">
                                <span class="dark:text-gray-400">-</span>
                                <input type="time" v-model="customTimes[pairNum].end"
                                    class="border dark:border-gray-600 rounded px-2 py-1 text-sm dark:bg-gray-700 dark:text-white">
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <button @click="resetCustomTimes" class="text-red-500 hover:text-red-700 text-sm underline">
                                –°–∫–∏–Ω—É—Ç–∏
                            </button>
                            <button v-if="!adminMode" @click="toggleAdminLogin"
                                class="text-gray-300 hover:text-gray-500 text-xs">
                                –ê–¥–º—ñ–Ω
                            </button>
                        </div>

                        <div class="flex gap-2">
                            <button v-if="adminMode" @click="saveGlobalTimes"
                                class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 shadow transition flex items-center gap-1">
                                <span>üåç</span> –í—Å—ñ–º
                            </button>
                            <button @click="saveState(); showSettingsModal = false"
                                class="bg-amber-600 text-white px-4 py-2 rounded hover:bg-amber-700 shadow transition">
                                –ó–±–µ—Ä–µ–≥—Ç–∏
                            </button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Modal: Report Download -->
            <div v-if="showReportModal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] p-4"
                @click.self="showReportModal = false">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full flex flex-col">
                    <div class="p-4 border-b dark:border-gray-700 bg-green-50 dark:bg-green-900/20 rounded-t-xl">
                        <h3 class="font-bold text-lg text-green-800 dark:text-green-300">üìä –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–≤—ñ—Ç</h3>
                        <p class="text-xs text-green-600 dark:text-green-400">–§–æ—Ä–º—É–≤–∞–Ω–Ω—è Excel-–∑–≤—ñ—Ç—É –¥–ª—è –≤–∏–∫–ª–∞–¥–∞—á–∞</p>
                    </div>

                    <div class="p-4 space-y-4">
                        <!-- Faculty -->
                        <div>
                            <label class="block text-sm font-bold mb-1 dark:text-gray-300">–§–∞–∫—É–ª—å—Ç–µ—Ç</label>
                            <select v-model="reportForm.faculty" @change="loadReportChairs"
                                class="w-full border rounded p-2 focus:ring focus:ring-green-200 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-green-900 transition-colors">
                                <option value="">-- –û–±–µ—Ä—ñ—Ç—å —Ñ–∞–∫—É–ª—å—Ç–µ—Ç --</option>
                                <option v-for="fac in faculties" :key="fac.Key" :value="fac">{{ fac.Value }}</option>
                            </select>
                        </div>

                        <!-- Chair -->
                        <div>
                            <label class="block text-sm font-bold mb-1 dark:text-gray-300">–ö–∞—Ñ–µ–¥—Ä–∞</label>
                            <select v-model="reportForm.chair" @change="loadReportEmployees"
                                :disabled="!reportForm.faculty"
                                class="w-full border rounded p-2 focus:ring focus:ring-green-200 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-green-900 transition-colors disabled:opacity-50">
                                <option value="">-- –û–±–µ—Ä—ñ—Ç—å –∫–∞—Ñ–µ–¥—Ä—É --</option>
                                <option v-for="chair in reportChairs" :key="chair.Key" :value="chair">{{ chair.Value }}
                                </option>
                            </select>
                        </div>

                        <!-- Teacher -->
                        <div>
                            <label class="block text-sm font-bold mb-1 dark:text-gray-300">–í–∏–∫–ª–∞–¥–∞—á</label>
                            <select v-model="reportForm.teacher" :disabled="!reportForm.chair"
                                class="w-full border rounded p-2 focus:ring focus:ring-green-200 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-green-900 transition-colors disabled:opacity-50">
                                <option value="">-- –û–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞ --</option>
                                <option v-for="emp in reportEmployees" :key="emp.Key" :value="emp">{{ emp.Value }}
                                </option>
                            </select>
                        </div>

                        <!-- Month Range -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold mb-1 dark:text-gray-300">–ó –º—ñ—Å—è—Ü—è</label>
                                <input type="month" v-model="reportForm.monthStart"
                                    class="w-full border rounded p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1 dark:text-gray-300">–ü–æ –º—ñ—Å—è—Ü—å</label>
                                <input type="month" v-model="reportForm.monthEnd"
                                    class="w-full border rounded p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                        </div>
                    </div>

                    <div class="p-4 border-t dark:border-gray-700 flex justify-end gap-2">
                        <button @click="showReportModal = false"
                            class="text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 font-bold py-2 px-4 rounded">
                            –°–∫–∞—Å—É–≤–∞—Ç–∏
                        </button>
                        <button @click="downloadReport" :disabled="!isReportFormValid || isDownloadingReport"
                            class="bg-green-600 hover:bg-green-700 disabled:bg-green-400 text-white font-bold py-2 px-4 rounded flex items-center gap-2">
                            <span v-if="isDownloadingReport"
                                class="animate-spin h-4 w-4 border-2 border-white rounded-full border-t-transparent"></span>
                            <span v-else>üì•</span>
                            {{ isDownloadingReport ? '–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è...' : '–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

                <!-- Mobile Sidebar Drawer -->
                <div class="sidebar-overlay" :class="{ active: sidebarOpen }" @click="sidebarOpen = false"></div>
                <div class="sidebar-drawer bg-white dark:bg-gray-800 p-6 shadow-2xl" :class="{ open: sidebarOpen }">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-lg text-gray-800 dark:text-gray-200">‚öôÔ∏è –§—ñ–ª—å—Ç—Ä–∏</h2>
                        <button @click="sidebarOpen = false"
                            class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl">√ó</button>
                    </div>
                    <!-- Mobile sidebar content is a clone. We use v-if to keep only one active -->
                    <div class="sidebar-content-mobile">
                        <!-- Favorites Quick Access -->
                        <div v-if="favorites.length > 0" class="mb-4 pb-4 border-b dark:border-gray-700">
                            <div
                                class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wider">
                                ‚≠ê
                                –û–±—Ä–∞–Ω–µ</div>
                            <div class="flex flex-wrap gap-2">
                                <div v-for="fav in favorites" :key="fav.id + fav.type"
                                    class="favorites-chip bg-yellow-50 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-300 border-yellow-200 dark:border-yellow-700"
                                    @click="loadFromFavorite(fav)">
                                    <span>{{ fav.type === '–ì—Ä—É–ø–∞' ? 'üéì' : 'üë®‚Äçüè´' }}</span>
                                    <span>{{ fav.name }}</span>
                                    <button class="remove-fav text-red-400 hover:text-red-600"
                                        @click.stop="removeFavorite(fav.id)">‚úï</button>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <button @click="openReportModal"
                                class="w-full bg-green-50 hover:bg-green-100 dark:bg-green-900/20 dark:hover:bg-green-900/30 text-green-700 dark:text-green-300 border border-green-200 dark:border-green-800 font-bold py-2 px-4 rounded transition flex items-center justify-center gap-2">
                                üìä –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–≤—ñ—Ç
                            </button>
                        </div>

                        <!-- Tabs: Student vs Teacher -->
                        <div class="flex mb-6 border-b">
                            <button @click="mode = 'student'"
                                :class="['flex-1 py-2 font-semibold transition', mode === 'student' ? 'text-amber-600 border-b-2 border-amber-600' : 'text-gray-400 hover:text-gray-600']">
                                –°—Ç—É–¥–µ–Ω—Ç
                            </button>
                            <button @click="mode = 'teacher'"
                                :class="['flex-1 py-2 font-semibold transition', mode === 'teacher' ? 'text-amber-600 border-b-2 border-amber-600' : 'text-gray-400 hover:text-gray-600']">
                                –í–∏–∫–ª–∞–¥–∞—á
                            </button>
                            <button @click="mode = 'occupancy'"
                                :class="['flex-1 py-2 font-semibold transition', mode === 'occupancy' ? 'text-amber-600 border-b-2 border-amber-600' : 'text-gray-400 hover:text-gray-600']">
                                –ó–∞–π–Ω—è—Ç—ñ—Å—Ç—å
                            </button>
                        </div>

                        <!-- Search Bar (Standard Mode Only) -->
                        <div v-if="mode !== 'occupancy'" class="mb-6 relative">
                            <label class="block text-sm font-bold mb-1">üîç –®–≤–∏–¥–∫–∏–π –ø–æ—à—É–∫ –≥—Ä—É–ø–∏</label>
                            <input type="text" v-model="searchQuery" @input="onSearchInput" @focus="onSearchInput"
                                placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–ù-21..."
                                class="w-full border rounded p-2 focus:ring focus:ring-amber-200 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-amber-900 transition-colors">

                            <!-- Dropdown Results -->
                            <div v-if="searchResults.length > 0"
                                class="absolute z-50 w-full bg-white dark:bg-gray-700 border dark:border-gray-600 rounded-b shadow-lg max-h-60 overflow-y-auto">
                                <div v-for="(res, idx) in searchResults" :key="idx" @click="selectSearchResult(res)"
                                    class="p-2 hover:bg-amber-50 dark:hover:bg-gray-600 cursor-pointer border-b dark:border-gray-600 last:border-b-0 text-sm flex items-center text-gray-800 dark:text-gray-200">
                                    <span class="mr-2 text-lg">{{ res.type === 'group' ? 'üéì' : 'üë®‚Äçüè´' }}</span>
                                    <div>
                                        <div class="font-bold text-amber-700">{{ res.label ? res.label.split('(')[0] :
                                            res.value.Value }}</div>
                                        <div class="text-gray-500 text-xs">{{ res.label }}</div>
                                    </div>
                                </div>
                            </div>
                            <div v-if="isSearching" class="absolute right-2 top-8 flex items-center gap-2">
                                <span class="text-xs text-gray-400 animate-pulse whitespace-nowrap">{{ cacheStatus
                                    }}</span>
                                <div
                                    class="animate-spin h-4 w-4 border-2 border-amber-500 rounded-full border-t-transparent">
                                </div>
                            </div>
                            <div v-if="searchQuery && searchResults.length === 0 && !isSearching && isCacheLoaded"
                                class="absolute z-50 w-full bg-white border rounded-b shadow-lg p-3 text-sm text-gray-500 text-center">
                                –ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ üòû
                            </div>
                        </div>

                        <div v-if="loadingFilters" class="space-y-4">
                            <!-- Skeleton Loader -->
                            <div class="space-y-2">
                                <div class="h-4 w-1/3 bg-gray-200 dark:bg-gray-700 rounded skeleton"></div>
                                <div class="h-10 w-full bg-gray-200 dark:bg-gray-700 rounded skeleton"></div>
                            </div>
                            <div class="space-y-2">
                                <div class="h-4 w-1/3 bg-gray-200 dark:bg-gray-700 rounded skeleton"></div>
                                <div class="h-10 w-full bg-gray-200 dark:bg-gray-700 rounded skeleton"></div>
                            </div>
                        </div>

                        <div v-else class="space-y-4">
                            <!-- Faculty Filter (Common) - Hide in Occupancy -->
                            <!-- Faculty Filter (Common) - Hide in Occupancy -->
                            <div v-if="mode !== 'occupancy'">
                                <label class="block text-sm font-bold mb-1 dark:text-gray-300">–§–∞–∫—É–ª—å—Ç–µ—Ç</label>
                                <select v-model="selectedFaculty" @change="onFacultyChange"
                                    class="w-full border rounded p-2 focus:ring focus:ring-amber-200 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-amber-900 transition-colors">
                                    <option value="">-- –û–±–µ—Ä—ñ—Ç—å —Ñ–∞–∫—É–ª—å—Ç–µ—Ç --</option>
                                    <option v-for="fac in faculties" :key="fac.Key" :value="fac.Key">{{ fac.Value }}
                                    </option>
                                </select>
                            </div>

                            <!-- Common Filter: Study Type -->
                            <div v-if="mode !== 'occupancy'">
                                <label class="block text-sm font-bold mb-1 dark:text-gray-300">–¢–∏–ø –∑–∞–Ω—è—Ç—Ç—è</label>
                                <select v-model="selectedStudyType"
                                    class="w-full border rounded p-2 focus:ring focus:ring-amber-200 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-amber-900 transition-colors">
                                    <option value="">-- –í—Å—ñ —Ç–∏–ø–∏ --</option>
                                    <option v-for="type in studyTypes" :key="type.Key" :value="type.Key">{{ type.Value
                                        }}
                                    </option>
                                </select>
                            </div>

                            <!-- Student Filters -->
                            <div v-if="mode === 'student'">
                                <div>
                                    <label class="block text-sm font-bold mb-1 dark:text-gray-300">–§–æ—Ä–º–∞
                                        –Ω–∞–≤—á–∞–Ω–Ω—è</label>
                                    <select v-model="selectedEduForm" @change="loadGroups"
                                        class="w-full border rounded p-2 focus:ring focus:ring-amber-200 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-amber-900 transition-colors">
                                        <option value="">-- –í—Å—ñ --</option>
                                        <option v-for="item in eduForms" :key="item.Key" :value="item.Key">{{ item.Value
                                            }}
                                        </option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-1 dark:text-gray-300">–ö—É—Ä—Å</label>
                                    <select v-model="selectedCourse" @change="loadGroups"
                                        class="w-full border rounded p-2 focus:ring focus:ring-amber-200 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-amber-900 transition-colors">
                                        <option value="">-- –í—Å—ñ --</option>
                                        <option v-for="item in courses" :key="item.Key" :value="item.Key">{{ item.Value
                                            }}
                                        </option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-bold mb-1 dark:text-gray-300">–ì—Ä—É–ø–∞</label>
                                    <select v-model="selectedGroup"
                                        class="w-full border rounded p-2 focus:ring focus:ring-amber-200 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-amber-900 transition-colors">
                                        <option value="">-- –û–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É --</option>
                                        <option v-for="grp in groups" :key="grp.Key" :value="grp">{{ grp.Value }}
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <!-- Teacher Filters -->
                            <div v-else-if="mode === 'teacher'">
                                <div>
                                    <label class="block text-sm font-bold mb-1 dark:text-gray-300">–ö–∞—Ñ–µ–¥—Ä–∞</label>
                                    <select v-model="selectedChair" @change="loadEmployees"
                                        class="w-full border rounded p-2 focus:ring focus:ring-amber-200 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-amber-900 transition-colors">
                                        <option value="">-- –û–±–µ—Ä—ñ—Ç—å –∫–∞—Ñ–µ–¥—Ä—É --</option>
                                        <option v-for="chair in chairs" :key="chair.Key" :value="chair.Key">{{
                                            chair.Value
                                            }}
                                        </option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-1 dark:text-gray-300">–í–∏–∫–ª–∞–¥–∞—á</label>
                                    <select v-model="selectedEmployee"
                                        class="w-full border rounded p-2 focus:ring focus:ring-amber-200 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-amber-900 transition-colors">
                                        <option value="">-- –û–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞ --</option>
                                        <option v-for="emp in employees" :key="emp.Key" :value="emp">{{ emp.Value }}
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <!-- Occupancy Controls -->
                            <div v-if="mode === 'occupancy'">
                                <div>
                                    <label class="block text-sm font-bold mb-1 dark:text-gray-300">–î–∞—Ç–∞ –∞–Ω–∞–ª—ñ–∑—É</label>
                                    <input type="date" v-model="occupancyDate"
                                        class="w-full border rounded p-2 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-amber-900 transition-colors">
                                </div>

                                <div v-if="isScanning" class="mt-4">
                                    <div class="text-sm font-bold text-amber-600 mb-1">–°–∫–∞–Ω—É–≤–∞–Ω–Ω—è...</div>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                                        <div class="bg-amber-600 h-2.5 rounded-full transition-all duration-300"
                                            :style="{ width: (scanProgress.total ? (scanProgress.current / scanProgress.total * 100) : 0) + '%' }">
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-500 text-center">
                                        {{ scanProgress.current }} / {{ scanProgress.total }}
                                        <br>
                                        {{ scanProgress.text }}
                                        <span v-if="scanErrors > 0" class="text-red-500 font-bold ml-1">
                                            (–ü–æ–º–∏–ª–æ–∫: {{ scanErrors }})
                                        </span>
                                    </div>
                                    <button @click="stopScan = true"
                                        class="mt-2 text-xs text-red-500 underline w-full text-center">
                                        –ó—É–ø–∏–Ω–∏—Ç–∏
                                    </button>
                                </div>

                                <div v-else class="mt-4">
                                    <button @click="startOccupancyScan"
                                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded transition">
                                        üöÄ –ü–æ—á–∞—Ç–∏ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è
                                    </button>
                                    <p class="text-xs text-gray-500 mt-2 text-center">
                                        –£–≤–∞–≥–∞: –¶–µ –∑–∞–π–º–µ –ø–µ–≤–Ω–∏–π —á–∞—Å (~30—Å). –ú–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ —Ä–æ–∑–∫–ª–∞–¥ —É—Å—ñ—Ö –≥—Ä—É–ø.
                                    </p>
                                </div>
                                <p v-if="errorMessage" class="text-red-500 text-sm mt-2">{{ errorMessage }}</p>
                            </div>

                            <!-- Notes Manager (New Button) -->
                            <div v-if="mode !== 'occupancy'" class="pt-4 border-t">
                                <button @click="showAllNotesModal = true"
                                    class="w-full bg-yellow-100 hover:bg-yellow-200 text-yellow-800 font-bold py-2 px-4 rounded transition flex items-center justify-center gap-2">
                                    üìù –ö–µ—Ä—É–≤–∞—Ç–∏ –Ω–æ—Ç–∞—Ç–∫–∞–º–∏
                                </button>
                            </div>

                            <!-- Date Range and Add Button (Standard Mode Only) -->
                            <div v-if="mode !== 'occupancy'" class="space-y-4 pt-4 border-t dark:border-gray-700">
                                <!-- Quick Date Buttons -->
                                <div class="flex flex-wrap gap-1">
                                    <button @click="setDateRange('today')" class="quick-date-btn"
                                        :class="{ active: datePreset === 'today' }">–°—å–æ–≥–æ–¥–Ω—ñ</button>
                                    <button @click="setDateRange('thisWeek')" class="quick-date-btn"
                                        :class="{ active: datePreset === 'thisWeek' }">–¶–µ–π —Ç–∏–∂–¥–µ–Ω—å</button>
                                    <button @click="setDateRange('nextWeek')" class="quick-date-btn"
                                        :class="{ active: datePreset === 'nextWeek' }">–ù–∞—Å—Ç—É–ø–Ω–∏–π</button>
                                    <button @click="setDateRange('twoWeeks')" class="quick-date-btn"
                                        :class="{ active: datePreset === 'twoWeeks' }">2 —Ç–∏–∂–Ω—ñ</button>
                                </div>

                                <!-- Date Range -->
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-sm font-bold mb-1 dark:text-gray-300">–ó</label>
                                        <input type="date" v-model="dateStart"
                                            class="w-full border rounded p-2 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white transition-colors">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold mb-1 dark:text-gray-300">–ü–æ</label>
                                        <input type="date" v-model="dateEnd"
                                            class="w-full border rounded p-2 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white transition-colors">
                                    </div>
                                </div>

                                <!-- Add Button + Favorite -->
                                <div class="flex gap-2">
                                    <button @click="addEntity" :disabled="!canAdd"
                                        class="flex-1 bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                                        + –î–æ–¥–∞—Ç–∏
                                    </button>
                                    <button @click="addToFavorites" :disabled="!canAdd" title="–î–æ–¥–∞—Ç–∏ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ"
                                        class="bg-yellow-100 hover:bg-yellow-200 dark:bg-yellow-900/30 dark:hover:bg-yellow-800/40 text-yellow-600 dark:text-yellow-400 font-bold py-2 px-3 rounded transition disabled:opacity-30 disabled:cursor-not-allowed">
                                        ‚≠ê
                                    </button>
                                </div>
                                <p v-if="errorMessage" class="text-red-500 text-sm mt-2">{{ errorMessage }}</p>
                            </div>

                            <!-- Export Buttons -->
                            <div v-if="Object.keys(groupedSchedule).length > 0"
                                class="mt-6 pt-4 border-t dark:border-gray-700 space-y-2">
                                <button @click="exportExcel"
                                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition flex items-center justify-center gap-2">
                                    <span>üì•</span> Excel
                                </button>
                                <div class="flex gap-2">
                                    <button @click="exportICal"
                                        class="flex-1 bg-indigo-100 hover:bg-indigo-200 dark:bg-indigo-900/30 dark:hover:bg-indigo-800/40 text-indigo-700 dark:text-indigo-300 font-bold py-2 px-3 rounded transition text-sm flex items-center justify-center gap-1">
                                        üìÜ iCal
                                    </button>
                                    <button @click="shareSchedule"
                                        class="flex-1 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-bold py-2 px-3 rounded transition text-sm flex items-center justify-center gap-1">
                                        üîó –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—å
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar: Controls -->
                <div class="lg:col-span-1 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg h-fit desktop-sidebar">

                    <!-- Favorites Quick Access -->
                    <div v-if="favorites.length > 0" class="mb-4 pb-4 border-b dark:border-gray-700">
                        <div class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wider">‚≠ê
                            –û–±—Ä–∞–Ω–µ</div>
                        <button class="remove-fav text-red-400 hover:text-red-600"
                            @click.stop="removeFavorite(fav.id)">‚úï</button>
                    </div>
                    <div class="mb-6">
                        <button @click="openReportModal"
                            class="w-full bg-green-50 hover:bg-green-100 dark:bg-green-900/20 dark:hover:bg-green-900/30 text-green-700 dark:text-green-300 border border-green-200 dark:border-green-800 font-bold py-2 px-4 rounded transition flex items-center justify-center gap-2">
                            üìä –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–≤—ñ—Ç
                        </button>
                    </div>

                    <!-- Tabs: Student vs Teacher -->
                    <div class="flex mb-6 border-b">
                        <button @click="mode = 'student'"
                            :class="['flex-1 py-2 font-semibold transition', mode === 'student' ? 'text-amber-600 border-b-2 border-amber-600' : 'text-gray-400 hover:text-gray-600']">
                            –°—Ç—É–¥–µ–Ω—Ç
                        </button>
                        <button @click="mode = 'teacher'"
                            :class="['flex-1 py-2 font-semibold transition', mode === 'teacher' ? 'text-amber-600 border-b-2 border-amber-600' : 'text-gray-400 hover:text-gray-600']">
                            –í–∏–∫–ª–∞–¥–∞—á
                        </button>
                        <button @click="mode = 'occupancy'"
                            :class="['flex-1 py-2 font-semibold transition', mode === 'occupancy' ? 'text-amber-600 border-b-2 border-amber-600' : 'text-gray-400 hover:text-gray-600']">
                            –ó–∞–π–Ω—è—Ç—ñ—Å—Ç—å
                        </button>
                    </div>

                    <!-- Search Bar (Standard Mode Only) -->
                    <div v-if="mode !== 'occupancy'" class="mb-6 relative">
                        <label class="block text-sm font-bold mb-1">üîç –®–≤–∏–¥–∫–∏–π –ø–æ—à—É–∫ –≥—Ä—É–ø–∏</label>
                        <input type="text" v-model="searchQuery" @input="onSearchInput" @focus="onSearchInput"
                            placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–ù-21..."
                            class="w-full border rounded p-2 focus:ring focus:ring-amber-200 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-amber-900 transition-colors">

                        <!-- Dropdown Results -->
                        <div v-if="searchResults.length > 0"
                            class="absolute z-50 w-full bg-white dark:bg-gray-700 border dark:border-gray-600 rounded-b shadow-lg max-h-60 overflow-y-auto">
                            <div v-for="(res, idx) in searchResults" :key="idx" @click="selectSearchResult(res)"
                                class="p-2 hover:bg-amber-50 dark:hover:bg-gray-600 cursor-pointer border-b dark:border-gray-600 last:border-b-0 text-sm flex items-center text-gray-800 dark:text-gray-200">
                                <span class="mr-2 text-lg">{{ res.type === 'group' ? 'üéì' : 'üë®‚Äçüè´' }}</span>
                                <div>
                                    <div class="font-bold text-amber-700">{{ res.label ? res.label.split('(')[0] :
                                        res.value.Value }}</div>
                                    <div class="text-gray-500 text-xs">{{ res.label }}</div>
                                </div>
                            </div>
                        </div>
                        <div v-if="isSearching" class="absolute right-2 top-8 flex items-center gap-2">
                            <span class="text-xs text-gray-400 animate-pulse whitespace-nowrap">{{ cacheStatus }}</span>
                            <div
                                class="animate-spin h-4 w-4 border-2 border-amber-500 rounded-full border-t-transparent">
                            </div>
                        </div>
                        <div v-if="searchQuery && searchResults.length === 0 && !isSearching && isCacheLoaded"
                            class="absolute z-50 w-full bg-white border rounded-b shadow-lg p-3 text-sm text-gray-500 text-center">
                            –ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ üòû
                        </div>
                    </div>

                    <div v-if="loadingFilters" class="space-y-4">
                        <!-- Skeleton Loader -->
                        <div class="space-y-2">
                            <div class="h-4 w-1/3 bg-gray-200 dark:bg-gray-700 rounded skeleton"></div>
                            <div class="h-10 w-full bg-gray-200 dark:bg-gray-700 rounded skeleton"></div>
                        </div>
                        <div class="space-y-2">
                            <div class="h-4 w-1/3 bg-gray-200 dark:bg-gray-700 rounded skeleton"></div>
                            <div class="h-10 w-full bg-gray-200 dark:bg-gray-700 rounded skeleton"></div>
                        </div>
                    </div>

                    <div v-else class="space-y-4">
                        <!-- Faculty Filter (Common) - Hide in Occupancy -->
                        <!-- Faculty Filter (Common) - Hide in Occupancy -->
                        <div v-if="mode !== 'occupancy'">
                            <label class="block text-sm font-bold mb-1 dark:text-gray-300">–§–∞–∫—É–ª—å—Ç–µ—Ç</label>
                            <select v-model="selectedFaculty" @change="onFacultyChange"
                                class="w-full border rounded p-2 focus:ring focus:ring-amber-200 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-amber-900 transition-colors">
                                <option value="">-- –û–±–µ—Ä—ñ—Ç—å —Ñ–∞–∫—É–ª—å—Ç–µ—Ç --</option>
                                <option v-for="fac in faculties" :key="fac.Key" :value="fac.Key">{{ fac.Value }}
                                </option>
                            </select>
                        </div>

                        <!-- Common Filter: Study Type -->
                        <div v-if="mode !== 'occupancy'">
                            <label class="block text-sm font-bold mb-1 dark:text-gray-300">–¢–∏–ø –∑–∞–Ω—è—Ç—Ç—è</label>
                            <select v-model="selectedStudyType"
                                class="w-full border rounded p-2 focus:ring focus:ring-amber-200 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-amber-900 transition-colors">
                                <option value="">-- –í—Å—ñ —Ç–∏–ø–∏ --</option>
                                <option v-for="type in studyTypes" :key="type.Key" :value="type.Key">{{ type.Value }}
                                </option>
                            </select>
                        </div>

                        <!-- Student Filters -->
                        <div v-if="mode === 'student'">
                            <div>
                                <label class="block text-sm font-bold mb-1 dark:text-gray-300">–§–æ—Ä–º–∞ –Ω–∞–≤—á–∞–Ω–Ω—è</label>
                                <select v-model="selectedEduForm" @change="loadGroups"
                                    class="w-full border rounded p-2 focus:ring focus:ring-amber-200 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-amber-900 transition-colors">
                                    <option value="">-- –í—Å—ñ --</option>
                                    <option v-for="item in eduForms" :key="item.Key" :value="item.Key">{{ item.Value }}
                                    </option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1 dark:text-gray-300">–ö—É—Ä—Å</label>
                                <select v-model="selectedCourse" @change="loadGroups"
                                    class="w-full border rounded p-2 focus:ring focus:ring-amber-200 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-amber-900 transition-colors">
                                    <option value="">-- –í—Å—ñ --</option>
                                    <option v-for="item in courses" :key="item.Key" :value="item.Key">{{ item.Value }}
                                    </option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-bold mb-1 dark:text-gray-300">–ì—Ä—É–ø–∞</label>
                                <select v-model="selectedGroup"
                                    class="w-full border rounded p-2 focus:ring focus:ring-amber-200 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-amber-900 transition-colors">
                                    <option value="">-- –û–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É --</option>
                                    <option v-for="grp in groups" :key="grp.Key" :value="grp">{{ grp.Value }}</option>
                                </select>
                            </div>
                        </div>

                        <!-- Teacher Filters -->
                        <div v-else-if="mode === 'teacher'">
                            <div>
                                <label class="block text-sm font-bold mb-1 dark:text-gray-300">–ö–∞—Ñ–µ–¥—Ä–∞</label>
                                <select v-model="selectedChair" @change="loadEmployees"
                                    class="w-full border rounded p-2 focus:ring focus:ring-amber-200 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-amber-900 transition-colors">
                                    <option value="">-- –û–±–µ—Ä—ñ—Ç—å –∫–∞—Ñ–µ–¥—Ä—É --</option>
                                    <option v-for="chair in chairs" :key="chair.Key" :value="chair.Key">{{ chair.Value
                                        }}
                                    </option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1 dark:text-gray-300">–í–∏–∫–ª–∞–¥–∞—á</label>
                                <select v-model="selectedEmployee"
                                    class="w-full border rounded p-2 focus:ring focus:ring-amber-200 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-amber-900 transition-colors">
                                    <option value="">-- –û–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞ --</option>
                                    <option v-for="emp in employees" :key="emp.Key" :value="emp">{{ emp.Value }}
                                    </option>
                                </select>
                            </div>
                        </div>

                        <!-- Occupancy Controls -->
                        <div v-if="mode === 'occupancy'">
                            <div>
                                <label class="block text-sm font-bold mb-1 dark:text-gray-300">–î–∞—Ç–∞ –∞–Ω–∞–ª—ñ–∑—É</label>
                                <input type="date" v-model="occupancyDate"
                                    class="w-full border rounded p-2 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-amber-900 transition-colors">
                            </div>

                            <div v-if="isScanning" class="mt-4">
                                <div class="text-sm font-bold text-amber-600 mb-1">–°–∫–∞–Ω—É–≤–∞–Ω–Ω—è...</div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                                    <div class="bg-amber-600 h-2.5 rounded-full transition-all duration-300"
                                        :style="{ width: (scanProgress.total ? (scanProgress.current / scanProgress.total * 100) : 0) + '%' }">
                                    </div>
                                </div>
                                <div class="text-xs text-gray-500 text-center">
                                    {{ scanProgress.current }} / {{ scanProgress.total }}
                                    <br>
                                    {{ scanProgress.text }}
                                    <span v-if="scanErrors > 0" class="text-red-500 font-bold ml-1">
                                        (–ü–æ–º–∏–ª–æ–∫: {{ scanErrors }})
                                    </span>
                                </div>
                                <button @click="stopScan = true"
                                    class="mt-2 text-xs text-red-500 underline w-full text-center">
                                    –ó—É–ø–∏–Ω–∏—Ç–∏
                                </button>
                            </div>

                            <div v-else class="mt-4">
                                <button @click="startOccupancyScan"
                                    class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded transition">
                                    üöÄ –ü–æ—á–∞—Ç–∏ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è
                                </button>
                                <p class="text-xs text-gray-500 mt-2 text-center">
                                    –£–≤–∞–≥–∞: –¶–µ –∑–∞–π–º–µ –ø–µ–≤–Ω–∏–π —á–∞—Å (~30—Å). –ú–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ —Ä–æ–∑–∫–ª–∞–¥ —É—Å—ñ—Ö –≥—Ä—É–ø.
                                </p>
                            </div>
                            <p v-if="errorMessage" class="text-red-500 text-sm mt-2">{{ errorMessage }}</p>
                        </div>

                        <!-- Notes Manager (New Button) -->
                        <div v-if="mode !== 'occupancy'" class="pt-4 border-t">
                            <button @click="showAllNotesModal = true"
                                class="w-full bg-yellow-100 hover:bg-yellow-200 text-yellow-800 font-bold py-2 px-4 rounded transition flex items-center justify-center gap-2">
                                üìù –ö–µ—Ä—É–≤–∞—Ç–∏ –Ω–æ—Ç–∞—Ç–∫–∞–º–∏
                            </button>
                        </div>

                        <!-- Date Range and Add Button (Standard Mode Only) -->
                        <div v-if="mode !== 'occupancy'" class="space-y-4 pt-4 border-t dark:border-gray-700">
                            <!-- Quick Date Buttons -->
                            <div class="flex flex-wrap gap-1">
                                <button @click="setDateRange('today')" class="quick-date-btn"
                                    :class="{ active: datePreset === 'today' }">–°—å–æ–≥–æ–¥–Ω—ñ</button>
                                <button @click="setDateRange('thisWeek')" class="quick-date-btn"
                                    :class="{ active: datePreset === 'thisWeek' }">–¶–µ–π —Ç–∏–∂–¥–µ–Ω—å</button>
                                <button @click="setDateRange('nextWeek')" class="quick-date-btn"
                                    :class="{ active: datePreset === 'nextWeek' }">–ù–∞—Å—Ç—É–ø–Ω–∏–π</button>
                                <button @click="setDateRange('twoWeeks')" class="quick-date-btn"
                                    :class="{ active: datePreset === 'twoWeeks' }">2 —Ç–∏–∂–Ω—ñ</button>
                            </div>

                            <!-- Date Range -->
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-sm font-bold mb-1 dark:text-gray-300">–ó</label>
                                    <input type="date" v-model="dateStart"
                                        class="w-full border rounded p-2 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white transition-colors">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-1 dark:text-gray-300">–ü–æ</label>
                                    <input type="date" v-model="dateEnd"
                                        class="w-full border rounded p-2 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white transition-colors">
                                </div>
                            </div>

                            <!-- Add Button + Favorite -->
                            <div class="flex gap-2">
                                <button @click="addEntity" :disabled="!canAdd"
                                    class="flex-1 bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    + –î–æ–¥–∞—Ç–∏
                                </button>
                                <button @click="addToFavorites" :disabled="!canAdd" title="–î–æ–¥–∞—Ç–∏ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ"
                                    class="bg-yellow-100 hover:bg-yellow-200 dark:bg-yellow-900/30 dark:hover:bg-yellow-800/40 text-yellow-600 dark:text-yellow-400 font-bold py-2 px-3 rounded transition disabled:opacity-30 disabled:cursor-not-allowed">
                                    ‚≠ê
                                </button>
                            </div>
                            <p v-if="errorMessage" class="text-red-500 text-sm mt-2">{{ errorMessage }}</p>
                        </div>

                        <!-- Export Buttons -->
                        <div v-if="Object.keys(groupedSchedule).length > 0"
                            class="mt-6 pt-4 border-t dark:border-gray-700 space-y-2">
                            <button @click="exportExcel"
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition flex items-center justify-center gap-2">
                                <span>üì•</span> Excel
                            </button>
                            <div class="flex gap-2">
                                <button @click="exportICal"
                                    class="flex-1 bg-indigo-100 hover:bg-indigo-200 dark:bg-indigo-900/30 dark:hover:bg-indigo-800/40 text-indigo-700 dark:text-indigo-300 font-bold py-2 px-3 rounded transition text-sm flex items-center justify-center gap-1">
                                    üìÜ iCal
                                </button>
                                <button @click="shareSchedule"
                                    class="flex-1 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-bold py-2 px-3 rounded transition text-sm flex items-center justify-center gap-1">
                                    üîó –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—å
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Panel: Results -->

                <!-- Main Panel: Results -->
                <div class="lg:col-span-3 space-y-6">

                    <!-- OCCUPANCY VIEW -->
                    <div v-if="mode === 'occupancy'">
                        <div v-if="occupancyResults.length > 0"
                            class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow transition-colors">
                            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                                <h3 class="font-bold text-lg text-gray-800 dark:text-gray-200">–ó–∞–π–Ω—è—Ç—ñ—Å—Ç—å –∞—É–¥–∏—Ç–æ—Ä—ñ–π ({{
                                    occupancyDate
                                    }})
                                </h3>

                                <div class="flex gap-2 w-full md:w-auto">
                                    <input type="text" v-model="occupancySearch" placeholder="–ü–æ—à—É–∫ (–Ω–∞–ø—Ä. 110)..."
                                        class="border rounded px-3 py-1 text-sm focus:ring focus:ring-amber-200 flex-grow dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-amber-900 transition-colors">
                                    <button @click="exportOccupancy"
                                        class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-1 px-3 rounded transition flex items-center gap-2 whitespace-nowrap">
                                        <span>üì•</span> Excel
                                    </button>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div v-for="cab in filteredOccupancyResults" :key="cab.name"
                                    class="border rounded-lg p-3 hover:shadow-md transition bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                    <div
                                        class="font-bold text-lg text-gray-800 dark:text-gray-200 mb-2 flex justify-between">
                                        {{ cab.name }}
                                        <span
                                            class="text-xs font-normal bg-white dark:bg-gray-600 border dark:border-gray-500 px-1 rounded text-gray-500 dark:text-gray-300">{{
                                            cab.building || '?' }}</span>
                                    </div>
                                    <div class="space-y-1">
                                        <div v-for="slot in [1,2,3,4,5,6,7]" :key="slot"
                                            class="flex items-center text-xs">
                                            <div class="w-6 font-bold text-gray-400">{{ slot }}</div>
                                            <div class="flex-1 h-6 rounded px-2 flex items-center overflow-hidden whitespace-nowrap"
                                                :class="cab.slots[slot] ? 'bg-red-100 text-red-800 border border-red-200' : 'bg-green-100 text-green-800 border border-green-200'">
                                                <span v-if="cab.slots[slot]" class="truncate">
                                                    {{ cab.slots[slot].group }} ({{ cab.slots[slot].teacher }})
                                                </span>
                                                <span v-else class="text-green-600 font-bold">–í—ñ–ª—å–Ω–∞</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Scan Empty State or No Matches -->
                            <div v-if="occupancyResults.length > 0 && filteredOccupancyResults.length === 0"
                                class="text-center py-8 text-gray-500">
                                –ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ –∑–∞–ø–∏—Ç–æ–º "{{ occupancySearch }}" üòû
                            </div>

                        </div>

                        <div v-else-if="!isScanning"
                            class="bg-white dark:bg-gray-800 p-12 rounded-xl shadow text-center text-gray-400 dark:text-gray-500 transition-colors">
                            <p class="text-xl">–î–∞–Ω—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ</p>
                            <p v-if="scanErrors > 0">
                                –°–∫–∞–Ω—É–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ, –∞–ª–µ –∞—É–¥–∏—Ç–æ—Ä—ñ–π –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.
                                <br>–°–ø—Ä–æ–±—É–π—Ç–µ –æ–±—Ä–∞—Ç–∏ —ñ–Ω—à–∏–π –¥–µ–Ω—å (–±—É–¥–Ω—ñ–π).
                            </p>
                            <p v-else>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ü–æ—á–∞—Ç–∏ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è", —â–æ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∑–∞–π–Ω—è—Ç—ñ—Å—Ç—å</p>
                        </div>

                    </div>

                    <!-- STANDARD VIEW -->
                    <div v-else>
                        <!-- Countdown to Next Lesson -->
                        <div v-if="nextLessonInfo" class="countdown-banner mb-6 flex items-center justify-between">
                            <div>
                                <div class="text-xs font-medium opacity-80">‚è∞ –ù–∞—Å—Ç—É–ø–Ω–∞ –ø–∞—Ä–∞</div>
                                <div class="font-bold text-lg">{{ nextLessonInfo.discipline }}</div>
                                <div class="text-sm opacity-90">{{ nextLessonInfo.teacher }} ¬∑ {{ nextLessonInfo.cabinet
                                    }}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold">{{ nextLessonInfo.timeLeft }}</div>
                                <div class="text-xs opacity-80">{{ nextLessonInfo.time }}</div>
                            </div>
                        </div>

                        <!-- Statistics Block -->
                        <div v-if="activeEntities.length > 0"
                            class="bg-white dark:bg-gray-800 rounded-xl shadow mb-6 transition-colors overflow-hidden">

                            <!-- Header & Auto-Refresh Indicator -->
                            <div
                                class="px-4 py-3 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-750">
                                <h3 class="font-bold text-gray-700 dark:text-gray-200 flex items-center gap-2">
                                    üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞
                                </h3>
                                <div v-if="autoRefreshEnabled && lastRefreshTime"
                                    class="text-xs text-amber-600 dark:text-amber-400 font-medium flex items-center gap-1">
                                    <span class="animate-pulse">‚óè</span> –û–Ω–æ–≤–ª–µ–Ω–æ: {{ lastRefreshTime }}
                                </div>
                            </div>

                            <div class="p-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                                <!-- Key Metrics -->
                                <div class="bg-amber-50 dark:bg-amber-900/20 p-3 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-amber-600 dark:text-amber-400">{{
                                        scheduleStats.totalPairs }}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">–ü–∞—Ä
                                    </div>
                                </div>
                                <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{
                                        scheduleStats.totalHours }}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">–ì–æ–¥–∏–Ω
                                    </div>
                                </div>
                                <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-green-600 dark:text-green-400">{{
                                        scheduleStats.avgPairsPerDay }}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">–ü–∞—Ä /
                                        –î–µ–Ω—å
                                    </div>
                                </div>
                                <div class="bg-purple-50 dark:bg-purple-900/20 p-3 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">{{
                                        scheduleStats.totalFreeWindows }}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">–í—ñ–∫–æ–Ω
                                    </div>
                                </div>
                            </div>

                            <div class="px-4 pb-4 grid md:grid-cols-2 gap-6">
                                <!-- Type Distribution -->
                                <div>
                                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">–ó–∞ —Ç–∏–ø–∞–º–∏</h4>
                                    <div class="space-y-2">
                                        <div v-for="type in scheduleStats.typeDistribution" :key="type.name"
                                            class="flex items-center text-sm">
                                            <div class="w-8 text-xl text-center">{{ getLessonTypeIcon(type.name) }}
                                            </div>
                                            <div class="flex-1">
                                                <div class="flex justify-between mb-1">
                                                    <span class="font-medium text-gray-700 dark:text-gray-300">{{
                                                        type.name
                                                        }}</span>
                                                    <span class="text-gray-500 dark:text-gray-400 text-xs">{{ type.count
                                                        }}
                                                        ({{ type.percent }}%)</span>
                                                </div>
                                                <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-1.5">
                                                    <div class="h-1.5 rounded-full transition-all duration-1000"
                                                        :class="getLessonTypeClass(type.name).replace('lesson-type-', 'bg-').replace('default', 'gray-400')"
                                                        :style="{ width: type.percent + '%' }"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Top Subjects -->
                                <div>
                                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">–¢–æ–ø –¥–∏—Å—Ü–∏–ø–ª—ñ–Ω</h4>
                                    <div class="space-y-3">
                                        <div v-for="subj in scheduleStats.topSubjects" :key="subj.name">
                                            <div class="flex justify-between text-xs mb-1">
                                                <span class="truncate pr-2 font-medium text-gray-700 dark:text-gray-300"
                                                    title="{{ subj.name }}">{{ subj.name }}</span>
                                                <span class="text-gray-500 dark:text-gray-400">{{ subj.count }}</span>
                                            </div>
                                            <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-1.5">
                                                <div class="bg-amber-500 dark:bg-amber-400 h-1.5 rounded-full transition-all duration-1000"
                                                    :style="{ width: subj.percent + '%' }"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Helper message if empty -->
                        <div v-if="activeEntities.length === 0"
                            class="bg-white dark:bg-gray-800 p-12 rounded-xl shadow text-center text-gray-400 dark:text-gray-500 transition-colors">
                            <p class="text-5xl mb-4">üìÖ</p>
                            <p class="text-xl font-medium">–°–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</p>
                            <p>–î–æ–¥–∞–π—Ç–µ –≥—Ä—É–ø—É –∞–±–æ –≤–∏–∫–ª–∞–¥–∞—á–∞, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥</p>
                        </div>

                        <!-- Global Controls (Discipline Filter) -->
                        <div v-if="activeEntities.length > 0"
                            class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow transition-colors">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-bold text-gray-700 dark:text-gray-200">–§—ñ–ª—å—Ç—Ä (–ü—Ä–µ–¥–º–µ—Ç–∏, –í–∏–∫–ª–∞–¥–∞—á—ñ):
                                </div>
                                <div class="flex gap-2">
                                    <button @click="selectedDisciplines = []"
                                        :disabled="selectedDisciplines.length === 0"
                                        :class="['text-xs font-medium underline transition', selectedDisciplines.length > 0 ? 'text-red-500 hover:text-red-700 cursor-pointer' : 'text-gray-300 cursor-not-allowed']">
                                        –°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä
                                    </button>
                                    <button @click="clearAll"
                                        class="text-xs text-gray-400 hover:text-red-600 font-medium underline">
                                        –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ
                                    </button>
                                    <button v-if="activeEntities.length > 1" @click="findCommonFreeSlots"
                                        class="text-xs bg-indigo-100 text-indigo-700 hover:bg-indigo-200 font-bold px-2 py-1 rounded transition">
                                        üîç –ó–Ω–∞–π—Ç–∏ –≤—ñ–∫–Ω–∞
                                    </button>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <!-- "All" Chip -->
                                <button @click="selectedDisciplines = []" :class="['px-3 py-1 rounded-full text-sm border transition', 
                                    selectedDisciplines.length === 0 
                                    ? 'bg-amber-600 text-white border-amber-600 font-bold shadow-md' 
                                    : 'bg-gray-100 text-gray-600 border-gray-200 hover:bg-gray-200']">
                                    –í—Å—ñ –ø—Ä–µ–¥–º–µ—Ç–∏
                                </button>

                                <!-- Discipline Chips -->
                                <button v-for="disc in availableDisciplines" :key="disc" @click="toggleDiscipline(disc)"
                                    :class="['px-3 py-1 rounded-full text-sm border transition text-left', 
                                    selectedDisciplines.includes(disc) 
                                    ? 'bg-amber-100 text-amber-800 border-amber-300 font-semibold shadow-sm ring-1 ring-amber-300' 
                                    : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50']">
                                    {{ disc }}
                                </button>
                            </div>
                        </div>

                        <!-- Active Entities List -->
                        <div v-else class="flex flex-wrap gap-3">
                            <div v-for="(entity, index) in activeEntities" :key="index"
                                class="flex items-center bg-white border border-amber-200 text-amber-800 px-4 py-2 rounded-full shadow-sm">
                                <span class="font-medium mr-2">{{ entity.name }}</span>
                                <span class="text-xs text-gray-500 uppercase mr-3">({{ entity.type }})</span>
                                <button @click="removeEntity(index)"
                                    class="text-red-400 hover:text-red-700 font-bold">‚úï</button>
                            </div>
                        </div>

                        <!-- Week Navigation + View Toggle -->
                        <div v-if="activeEntities.length > 0"
                            class="flex flex-wrap items-center justify-between gap-2 mb-4">
                            <div class="flex gap-2">
                                <button @click="shiftWeek(-1)" class="week-nav-btn">‚Üê –ü—Ä–µ–¥. —Ç–∏–∂–¥–µ–Ω—å</button>
                                <button @click="shiftWeek(1)" class="week-nav-btn">–ù–∞—Å—Ç. —Ç–∏–∂–¥–µ–Ω—å ‚Üí</button>
                            </div>
                            <div class="flex gap-1 bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                                <button @click="viewMode = 'cards'"
                                    :class="['px-3 py-1 rounded-md text-xs font-semibold transition', viewMode === 'cards' ? 'bg-white dark:bg-gray-600 shadow text-gray-800 dark:text-white' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700']">
                                    üÉè –ö–∞—Ä—Ç–∫–∏
                                </button>
                                <button @click="viewMode = 'table'"
                                    :class="['px-3 py-1 rounded-md text-xs font-semibold transition', viewMode === 'table' ? 'bg-white dark:bg-gray-600 shadow text-gray-800 dark:text-white' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700']">
                                    üìã –¢–∞–±–ª–∏—Ü—è
                                </button>
                            </div>
                        </div>

                        <!-- COMPACT TABLE VIEW -->
                        <div v-if="viewMode === 'table' && Object.keys(groupedSchedule).length > 0"
                            class="bg-white dark:bg-gray-800 rounded-xl shadow overflow-hidden transition-colors overflow-x-auto">
                            <table class="schedule-table w-full text-sm">
                                <thead>
                                    <tr class="bg-gray-50 dark:bg-gray-700 border-b dark:border-gray-600">
                                        <th class="text-gray-500 dark:text-gray-400 text-left px-3 py-2 w-28">–î–∞—Ç–∞</th>
                                        <th class="text-gray-500 dark:text-gray-400 text-center px-3 py-2 w-40">–ü–∞—Ä–∞
                                        </th>
                                        <th class="text-gray-500 dark:text-gray-400 text-left px-3 py-2">–î–∏—Å—Ü–∏–ø–ª—ñ–Ω–∞</th>
                                        <th class="text-gray-500 dark:text-gray-400 text-center px-3 py-2 w-28">–¢–∏–ø</th>
                                        <th class="text-gray-500 dark:text-gray-400 text-left px-3 py-2 w-40">–í–∏–∫–ª–∞–¥–∞—á
                                        </th>
                                        <th class="text-gray-500 dark:text-gray-400 text-center px-3 py-2 w-24">–ö–∞–±.
                                        </th>
                                        <th class="text-gray-500 dark:text-gray-400 text-left px-3 py-2 w-36">–ì—Ä—É–ø–∞</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template v-for="dayData in groupedSchedule" :key="'t-'+dayData.date">
                                        <template v-for="(timeSlot, si) in dayData.slots" :key="'ts-'+dayData.date+si">
                                            <tr v-for="(lesson, li) in timeSlot.lessons" :key="'tl-'+dayData.date+si+li"
                                                class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-750 transition"
                                                :class="[isActiveLesson(dayData.date, timeSlot.start, timeSlot.end) ? 'bg-green-50 dark:bg-green-900/20' : '']">
                                                <td v-if="si === 0 && li === 0"
                                                    :rowspan="dayData.slots.reduce((sum, s) => sum + s.lessons.length, 0)"
                                                    class="px-3 py-2 whitespace-nowrap font-semibold text-gray-700 dark:text-gray-300 border-r dark:border-gray-700 align-top bg-gray-50/50 dark:bg-gray-800">
                                                    <div>{{ dayData.dayName }}</div>
                                                    <div class="text-xs text-gray-400 font-normal">{{ dayData.date }}
                                                    </div>
                                                </td>
                                                <td class="px-3 py-2 whitespace-nowrap text-center align-middle">
                                                    <div class="flex flex-col items-center">
                                                        <span
                                                            class="inline-block bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-200 text-xs font-semibold px-2 py-0.5 rounded">
                                                            {{ timeSlot.time }}
                                                        </span>
                                                        <!-- Progress Bar in Table -->
                                                        <div v-if="isActiveLesson(dayData.date, timeSlot.start, timeSlot.end)"
                                                            class="w-16 bg-gray-200 dark:bg-gray-600 rounded-full h-1 mt-1 overflow-hidden">
                                                            <div class="bg-green-500 h-1 rounded-full transition-all duration-1000"
                                                                :style="{ width: getLessonProgress(dayData.date, timeSlot.start, timeSlot.end)?.percent + '%' }">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-3 py-2 font-medium text-gray-800 dark:text-gray-200">{{
                                                    lesson.discipline }}</td>
                                                <td class="px-3 py-2 text-center"><span
                                                        :class="['lesson-type-badge text-xs', getLessonTypeClass(lesson.type)]">{{
                                                        lesson.type || '‚Äî' }}</span></td>
                                                <td class="px-3 py-2 text-gray-600 dark:text-gray-400">{{ lesson.teacher
                                                    }}
                                                </td>
                                                <td class="px-3 py-2 text-center text-gray-500 dark:text-gray-400">{{
                                                    lesson.cabinet }}</td>
                                                <td
                                                    class="px-3 py-2 text-amber-600 dark:text-amber-400 font-medium text-sm">
                                                    {{ lesson.group || lesson.entityName }}</td>
                                            </tr>
                                        </template>
                                    </template>
                                </tbody>
                            </table>
                        </div>

                        <!-- CARD VIEW (Schedule Grid) -->
                        <div v-if="viewMode === 'cards' && Object.keys(groupedSchedule).length > 0"
                            class="bg-white dark:bg-gray-800 rounded-xl shadow overflow-hidden transition-colors">
                            <div v-for="dayData in groupedSchedule" :key="dayData.date"
                                class="border-b dark:border-gray-700 last:border-b-0">
                                <div
                                    class="day-header-sticky bg-gray-50/95 dark:bg-gray-700/95 px-6 py-3 border-b border-gray-100 dark:border-gray-600 flex justify-between items-center transition-colors">
                                    <h3 class="font-bold text-lg text-gray-800 dark:text-gray-200">{{ dayData.dayName
                                        }}, {{
                                        dayData.date }}</h3>
                                    <span class="text-xs text-gray-400 dark:text-gray-500">{{ dayData.slots.length }}
                                        –ø–∞—Ä</span>
                                </div>

                                <div class="divide-y divide-gray-100 dark:divide-gray-700">
                                    <div v-for="timeSlot in dayData.slots" :key="timeSlot.time"
                                        class="grid grid-cols-12 hover:bg-gray-50 dark:hover:bg-gray-750 transition p-4">
                                        <!-- Time Column -->
                                        <div
                                            class="col-span-12 md:col-span-2 text-center md:text-left mb-2 md:mb-0 flex flex-row md:flex-col items-center md:items-start gap-2 md:gap-1">
                                            <span
                                                class="inline-block bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200 text-xs font-semibold px-2 py-1 rounded whitespace-nowrap">
                                                {{ timeSlot.time }}
                                            </span>
                                            <span v-if="timeSlot.start"
                                                class="text-sm text-gray-500 dark:text-gray-400 font-medium">
                                                {{ timeSlot.start }} - {{ timeSlot.end }}
                                            </span>
                                        </div>

                                        <!-- Classes Column -->
                                        <div class="col-span-12 md:col-span-10 grid gap-4">
                                            <div v-for="(lesson, idx) in timeSlot.lessons" :key="idx"
                                                class="bg-white dark:bg-gray-800 border dark:border-gray-600 rounded-lg p-3 shadow-sm relative pl-4 border-l-4 transition-all duration-500 text-gray-800 dark:text-gray-200"
                                                :class="[
                                                getColorClass(lesson.entityId),
                                                isActiveLesson(dayData.date, timeSlot.start, timeSlot.end) ? 'ring-4 ring-green-400 scale-[1.02] z-10' : ''
                                            ]">

                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <div v-if="isActiveLesson(dayData.date, timeSlot.start, timeSlot.end)"
                                                            class="inline-block bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full mb-1 animate-pulse">
                                                            –ó–ê–†–ê–ó
                                                        </div>

                                                        <!-- Progress Bar -->
                                                        <div v-if="isActiveLesson(dayData.date, timeSlot.start, timeSlot.end)"
                                                            class="mb-2">
                                                            <div
                                                                class="flex justify-between text-[10px] text-gray-500 mb-1">
                                                                <span>–ü—Ä–æ–≥—Ä–µ—Å: {{ getLessonProgress(dayData.date,
                                                                    timeSlot.start, timeSlot.end)?.percent
                                                                    }}%</span>
                                                                <span>–ó–∞–ª–∏—à–∏–ª–æ—Å—å: {{ getLessonProgress(dayData.date,
                                                                    timeSlot.start, timeSlot.end)?.timeLeft }}
                                                                    —Ö–≤</span>
                                                            </div>
                                                            <div class="w-full bg-gray-200 rounded-full h-1.5">
                                                                <div class="bg-amber-600 h-1.5 rounded-full transition-all duration-1000"
                                                                    :style="{ width: getLessonProgress(dayData.date, timeSlot.start, timeSlot.end)?.percent + '%' }">
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- 1. Discipline + Group -->
                                                        <h4 class="font-bold text-gray-900 text-base mb-1">
                                                            {{ lesson.discipline }}
                                                            <span v-if="lesson.group"
                                                                class="text-amber-600 font-normal">
                                                                ({{ lesson.group }})
                                                            </span>
                                                        </h4>

                                                        <!-- 2. Type Badge -->
                                                        <div class="mb-1" v-if="lesson.type">
                                                            <span
                                                                :class="['lesson-type-badge', getLessonTypeClass(lesson.type)]">
                                                                {{ getLessonTypeIcon(lesson.type) }} {{ lesson.type }}
                                                            </span>
                                                        </div>

                                                        <!-- 3. Teacher -->
                                                        <div
                                                            class="text-sm text-gray-700 font-medium flex flex-wrap items-center gap-2">
                                                            <span v-if="lesson.teacher" class="flex items-center">
                                                                üë®‚Äç <span class="ml-1">{{ lesson.teacher }}</span>
                                                            </span>
                                                            <span v-if="lesson.cabinet"
                                                                class="text-gray-400 text-xs ml-2">
                                                                üìç {{ lesson.cabinet }}
                                                            </span>
                                                        </div>

                                                    </div>

                                                    <!-- Global Links Buttons -->
                                                    <div class="mt-2 flex gap-2">
                                                        <a v-if="getGlobalLink(lesson, 'courseUrl')"
                                                            :href="getGlobalLink(lesson, 'courseUrl')" target="_blank"
                                                            class="text-xs bg-amber-50 text-amber-700 border border-amber-200 px-2 py-1 rounded hover:bg-amber-100 font-medium flex items-center gap-1">
                                                            üìò –ö—É—Ä—Å
                                                        </a>
                                                        <a v-if="getGlobalLink(lesson, 'onlineUrl')"
                                                            :href="getGlobalLink(lesson, 'onlineUrl')" target="_blank"
                                                            class="text-xs bg-purple-50 text-purple-700 border border-purple-200 px-2 py-1 rounded hover:bg-purple-100 font-medium flex items-center gap-1">
                                                            üìπ –û–Ω–ª–∞–π–Ω
                                                        </a>
                                                    </div>

                                                    <!-- Admin Edit Button -->
                                                    <button v-if="adminMode" @click.stop="openAdminModal(lesson)"
                                                        class="absolute top-2 right-2 text-xs bg-gray-600 text-white px-1 rounded opacity-50 hover:opacity-100 z-20">
                                                        ‚úèÔ∏è
                                                    </button>

                                                    <!-- Note Indicator/Button -->
                                                    <div class="mt-2 flex justify-end">
                                                        <button
                                                            @click.stop="openNote(lesson, dayData.date, timeSlot.time)"
                                                            class="text-xs px-2 py-1 rounded transition flex items-center gap-1"
                                                            :class="hasNote(lesson, dayData.date, timeSlot.time) ? 'bg-yellow-100 text-yellow-800 font-semibold' : 'text-gray-400 hover:text-gray-600 hover:bg-gray-50'">
                                                            <span v-if="hasNote(lesson, dayData.date, timeSlot.time)">üìù
                                                                –Ñ
                                                                –Ω–æ—Ç–∞—Ç–∫–∞</span>
                                                            <span v-else>‚ûï –ù–æ—Ç–∞—Ç–∫–∞</span>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="hidden md:block text-right">
                                                    <span
                                                        class="text-xs font-bold uppercase tracking-wider text-gray-400 bg-gray-100 px-2 py-1 rounded">
                                                        {{ lesson.entityName }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="activeEntities.length > 0 && Object.keys(groupedSchedule).length === 0 && !loadingSchedule"
                        class="text-center py-10 text-gray-500">
                        –ù–∞ –≤–∏–±—Ä–∞–Ω–∏–π –ø–µ—Ä—ñ–æ–¥ —Ä–æ–∑–∫–ª–∞–¥—É –Ω–µ–º–∞—î.
                    </div>

                    <!-- Schedule Loading Skeleton -->
                    <div v-if="loadingSchedule" class="space-y-4">
                        <div v-for="i in 3" :key="i"
                            class="bg-white dark:bg-gray-800 rounded-xl shadow overflow-hidden p-4 transition-colors">
                            <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-1/4 mb-4 skeleton"></div>
                            <div class="space-y-3">
                                <div class="h-20 bg-gray-100 dark:bg-gray-700 rounded skeleton"></div>
                                <div class="h-20 bg-gray-100 dark:bg-gray-700 rounded skeleton"></div>
                            </div>
                        </div>
                    </div>
                </div> <!-- End of lg:col-span-3 -->
            </div> <!-- End of grid -->







            <!-- Footer -->
            <footer class="mt-12 text-center pb-8 text-gray-400 text-sm">
                <a href="http://wp-fuaid.zzz.com.ua/r"
                    class="inline-block text-amber-600 hover:text-amber-800 font-semibold border-b-2 border-transparent hover:border-amber-600 transition mb-2">
                    ‚¨Ö –ù–∞ –≥–æ–ª–æ–≤–Ω—É
                </a>
                <div>
                    <button @click="toggleAdminLogin" class="hover:text-gray-600">Admin</button>
                </div>
            </footer>


        </div> <!-- End of content wrapper -->

    </div> <!-- End of #app -->

    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/search.js"></script>
    <script src="js/occupancy.js"></script>
    <script src="js/notes.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/report.js"></script>
    <script src="js/app.js"></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(registrationError => console.log('SW registration failed: ', registrationError));
            });
        }
    </script>
</body>

</html>