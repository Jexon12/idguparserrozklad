<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Універсальний Розклад</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.5s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen font-sans text-gray-800">
    <div id="app" class="p-4 md:p-8">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-700 mb-2">📅 Гнучкий Розклад</h1>
            <p class="text-gray-600">Оберіть декілька груп або викладачів для порівняння</p>
        </header>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

            <!-- Sidebar: Controls -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">

                <!-- Tabs: Student vs Teacher -->
                <div class="flex mb-6 border-b">
                    <button @click="mode = 'student'"
                        :class="['flex-1 py-2 font-semibold transition', mode === 'student' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-400 hover:text-gray-600']">
                        Студент
                    </button>
                    <button @click="mode = 'teacher'"
                        :class="['flex-1 py-2 font-semibold transition', mode === 'teacher' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-400 hover:text-gray-600']">
                        Викладач
                    </button>
                    <button @click="mode = 'occupancy'"
                        :class="['flex-1 py-2 font-semibold transition', mode === 'occupancy' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-400 hover:text-gray-600']">
                        Зайнятість
                    </button>
                </div>

                <!-- Search Bar (Standard Mode Only) -->
                <div v-if="mode !== 'occupancy'" class="mb-6 relative">
                    <label class="block text-sm font-bold mb-1">🔍 Швидкий пошук групи</label>
                    <input type="text" v-model="searchQuery" @input="onSearchInput" @focus="onSearchInput"
                        placeholder="Наприклад: КН-21..."
                        class="w-full border rounded p-2 focus:ring focus:ring-blue-200">

                    <!-- Dropdown Results -->
                    <div v-if="searchResults.length > 0"
                        class="absolute z-50 w-full bg-white border rounded-b shadow-lg max-h-60 overflow-y-auto">
                        <div v-for="(res, idx) in searchResults" :key="idx" @click="selectSearchResult(res)"
                            class="p-2 hover:bg-blue-50 cursor-pointer border-b last:border-b-0 text-sm flex items-center">
                            <span class="mr-2 text-lg">{{ res.type === 'group' ? '🎓' : '👨‍🏫' }}</span>
                            <div>
                                <div class="font-bold text-blue-700">{{ res.label ? res.label.split('(')[0] :
                                    res.value.Value }}</div>
                                <div class="text-gray-500 text-xs">{{ res.label }}</div>
                            </div>
                        </div>
                    </div>
                    <div v-if="isSearching" class="absolute right-2 top-8 flex items-center gap-2">
                        <span class="text-xs text-gray-400 animate-pulse whitespace-nowrap">{{ cacheStatus }}</span>
                        <div class="animate-spin h-4 w-4 border-2 border-blue-500 rounded-full border-t-transparent">
                        </div>
                    </div>
                    <div v-if="searchQuery && searchResults.length === 0 && !isSearching && isCacheLoaded"
                        class="absolute z-50 w-full bg-white border rounded-b shadow-lg p-3 text-sm text-gray-500 text-center">
                        Нічого не знайдено 😞
                    </div>
                </div>

                <div v-if="loadingFilters" class="text-center py-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                </div>

                <div v-else class="space-y-4">
                    <!-- Faculty Filter (Common) - Hide in Occupancy -->
                    <div v-if="mode !== 'occupancy'">
                        <label class="block text-sm font-bold mb-1">Факультет</label>
                        <select v-model="selectedFaculty" @change="onFacultyChange"
                            class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                            <option value="">-- Оберіть факультет --</option>
                            <option v-for="fac in faculties" :key="fac.Key" :value="fac.Key">{{ fac.Value }}
                            </option>
                        </select>
                    </div>

                    <!-- Student Filters -->
                    <div v-if="mode === 'student'">
                        <div>
                            <label class="block text-sm font-bold mb-1">Форма навчання</label>
                            <select v-model="selectedEduForm" @change="loadGroups"
                                class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                                <option value="">-- Всі --</option>
                                <option v-for="item in eduForms" :key="item.Key" :value="item.Key">{{ item.Value }}
                                </option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Курс</label>
                            <select v-model="selectedCourse" @change="loadGroups"
                                class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                                <option value="">-- Всі --</option>
                                <option v-for="item in courses" :key="item.Key" :value="item.Key">{{ item.Value }}
                                </option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Тип заняття</label>
                            <select v-model="selectedStudyType"
                                class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                                <option value="">-- Всі типи --</option>
                                <option v-for="type in studyTypes" :key="type.Key" :value="type.Key">{{ type.Value }}
                                </option>
                            </select>
                        </div>


                        <div>
                            <label class="block text-sm font-bold mb-1">Група</label>
                            <select v-model="selectedGroup"
                                class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                                <option value="">-- Оберіть групу --</option>
                                <option v-for="grp in groups" :key="grp.Key" :value="grp">{{ grp.Value }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- Teacher Filters -->
                    <div v-else-if="mode === 'teacher'">
                        <div>
                            <label class="block text-sm font-bold mb-1">Кафедра</label>
                            <select v-model="selectedChair" @change="loadEmployees"
                                class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                                <option value="">-- Оберіть кафедру --</option>
                                <option v-for="chair in chairs" :key="chair.Key" :value="chair.Key">{{ chair.Value
                                    }}
                                </option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Викладач</label>
                            <select v-model="selectedEmployee"
                                class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                                <option value="">-- Оберіть викладача --</option>
                                <option v-for="emp in employees" :key="emp.Key" :value="emp">{{ emp.Value }}
                                </option>
                            </select>
                        </div>
                    </div>

                    <!-- Occupancy Controls -->
                    <div v-if="mode === 'occupancy'">
                        <div>
                            <label class="block text-sm font-bold mb-1">Дата аналізу</label>
                            <input type="date" v-model="occupancyDate" class="w-full border rounded p-2 text-sm">
                        </div>

                        <div v-if="isScanning" class="mt-4">
                            <div class="text-sm font-bold text-blue-600 mb-1">Сканування...</div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                                <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-300"
                                    :style="{ width: (scanProgress.total ? (scanProgress.current / scanProgress.total * 100) : 0) + '%' }">
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 text-center">
                                {{ scanProgress.current }} / {{ scanProgress.total }}
                                <br>
                                {{ scanProgress.text }}
                                <span v-if="scanErrors > 0" class="text-red-500 font-bold ml-1">
                                    (Помилок: {{ scanErrors }})
                                </span>
                            </div>
                            <button @click="stopScan = true"
                                class="mt-2 text-xs text-red-500 underline w-full text-center">
                                Зупинити
                            </button>
                        </div>

                        <div v-else class="mt-4">
                            <button @click="startOccupancyScan"
                                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded transition">
                                🚀 Почати сканування
                            </button>
                            <p class="text-xs text-gray-500 mt-2 text-center">
                                Увага: Це займе певний час (~30с). Ми перевіримо розклад усіх груп.
                            </p>
                        </div>
                        <p v-if="errorMessage" class="text-red-500 text-sm mt-2">{{ errorMessage }}</p>
                    </div>

                    <!-- Notes Manager (New Button) -->
                    <div v-if="mode !== 'occupancy'" class="pt-4 border-t">
                        <button @click="showAllNotesModal = true"
                            class="w-full bg-yellow-100 hover:bg-yellow-200 text-yellow-800 font-bold py-2 px-4 rounded transition flex items-center justify-center gap-2">
                            📝 Керувати нотатками
                        </button>
                    </div>

                    <!-- Date Range and Add Button (Standard Mode Only) -->
                    <div v-if="mode !== 'occupancy'" class="space-y-4 pt-4 border-t">
                        <!-- Date Range -->
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-sm font-bold mb-1">З</label>
                                <input type="date" v-model="dateStart" class="w-full border rounded p-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">По</label>
                                <input type="date" v-model="dateEnd" class="w-full border rounded p-2 text-sm">
                            </div>
                        </div>

                        <!-- Add Button -->
                        <button @click="addEntity" :disabled="!canAdd"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                            + Додати до порівняння
                        </button>
                        <p v-if="errorMessage" class="text-red-500 text-sm mt-2">{{ errorMessage }}</p>
                    </div>

                    <!-- Export -->
                    <div v-if="Object.keys(groupedSchedule).length > 0" class="mt-6 pt-6 border-t">
                        <button v-if="Object.keys(groupedSchedule).length > 0" @click="exportExcel"
                            class="mt-6 pt-6 border-t w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition flex items-center justify-center gap-2">
                            <span>📥</span> Завантажити Excel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Panel: Results -->
            <div class="lg:col-span-3 space-y-6">

                <!-- OCCUPANCY VIEW -->
                <div v-if="mode === 'occupancy'">
                    <div v-if="occupancyResults.length > 0" class="bg-white p-4 rounded-xl shadow">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <h3 class="font-bold text-lg text-gray-800">Зайнятість аудиторій ({{ occupancyDate
                                }})
                            </h3>

                            <div class="flex gap-2 w-full md:w-auto">
                                <input type="text" v-model="occupancySearch" placeholder="Пошук (напр. 110)..."
                                    class="border rounded px-3 py-1 text-sm focus:ring focus:ring-blue-200 flex-grow">
                                <button @click="exportOccupancy"
                                    class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-1 px-3 rounded transition flex items-center gap-2 whitespace-nowrap">
                                    <span>📥</span> Excel
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div v-for="cab in filteredOccupancyResults" :key="cab.name"
                                class="border rounded-lg p-3 hover:shadow-md transition bg-gray-50">
                                <div class="font-bold text-lg text-gray-800 mb-2 flex justify-between">
                                    {{ cab.name }}
                                    <span class="text-xs font-normal bg-white border px-1 rounded text-gray-500">{{
                                        cab.building || '?' }}</span>
                                </div>
                                <div class="space-y-1">
                                    <div v-for="slot in [1,2,3,4,5,6,7]" :key="slot" class="flex items-center text-xs">
                                        <div class="w-6 font-bold text-gray-400">{{ slot }}</div>
                                        <div class="flex-1 h-6 rounded px-2 flex items-center overflow-hidden whitespace-nowrap"
                                            :class="cab.slots[slot] ? 'bg-red-100 text-red-800 border border-red-200' : 'bg-green-100 text-green-800 border border-green-200'">
                                            <span v-if="cab.slots[slot]" class="truncate">
                                                {{ cab.slots[slot].group }} ({{ cab.slots[slot].teacher }})
                                            </span>
                                            <span v-else class="text-green-600 font-bold">Вільна</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Scan Empty State or No Matches -->
                        <div v-if="occupancyResults.length > 0 && filteredOccupancyResults.length === 0"
                            class="text-center py-8 text-gray-500">
                            Нічого не знайдено за запитом "{{ occupancySearch }}" 😞
                        </div>

                    </div>

                    <div v-else-if="!isScanning" class="bg-white p-12 rounded-xl shadow text-center text-gray-400">
                        <p class="text-xl">Дані відсутні</p>
                        <p>Натисніть "Почати сканування", щоб перевірити зайнятість</p>
                    </div>
                </div>

                <!-- STANDARD VIEW -->
                <div v-else>
                    <!-- Statistics Block -->
                    <div v-if="activeEntities.length > 0" class="bg-white p-4 rounded-xl shadow mb-6">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center">
                            📊 Статистика розкладу
                            <span class="ml-auto text-xs font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
                                Всього пар: {{ scheduleStats.totalPairs }}
                            </span>
                        </h3>
                        <div class="space-y-3">
                            <div v-for="subj in scheduleStats.topSubjects" :key="subj.name">
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="truncate pr-2 font-medium text-gray-700">{{ subj.name }}</span>
                                    <span class="text-gray-500">{{ subj.count }} ({{ subj.percent }}%)</span>
                                </div>
                                <div class="w-full bg-gray-100 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full transition-all duration-1000"
                                        :style="{ width: subj.percent + '%' }"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Helper message if empty -->
                    <div v-if="activeEntities.length === 0"
                        class="bg-white p-12 rounded-xl shadow text-center text-gray-400">
                        <p class="text-xl">Список порожній</p>
                        <p>Додайте групу або викладача, щоб побачити розклад</p>
                    </div>

                    <!-- Global Controls (Discipline Filter) -->
                    <div v-if="activeEntities.length > 0" class="bg-white p-4 rounded-xl shadow">
                        <div class="flex justify-between items-center mb-2">
                            <div class="font-bold text-gray-700">Фільтр (Предмети, Викладачі):</div>
                            <div class="flex gap-2">
                                <button @click="selectedDisciplines = []" :disabled="selectedDisciplines.length === 0"
                                    :class="['text-xs font-medium underline transition', selectedDisciplines.length > 0 ? 'text-red-500 hover:text-red-700 cursor-pointer' : 'text-gray-300 cursor-not-allowed']">
                                    Скинути фільтр
                                </button>
                                <button @click="clearAll"
                                    class="text-xs text-gray-400 hover:text-red-600 font-medium underline">
                                    Очистити все
                                </button>
                                <button v-if="activeEntities.length > 1" @click="findCommonFreeSlots"
                                    class="text-xs bg-indigo-100 text-indigo-700 hover:bg-indigo-200 font-bold px-2 py-1 rounded transition">
                                    🔍 Знайти вікна
                                </button>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <!-- "All" Chip -->
                            <button @click="selectedDisciplines = []" :class="['px-3 py-1 rounded-full text-sm border transition', 
                                    selectedDisciplines.length === 0 
                                    ? 'bg-blue-600 text-white border-blue-600 font-bold shadow-md' 
                                    : 'bg-gray-100 text-gray-600 border-gray-200 hover:bg-gray-200']">
                                Всі предмети
                            </button>

                            <!-- Discipline Chips -->
                            <button v-for="disc in availableDisciplines" :key="disc" @click="toggleDiscipline(disc)"
                                :class="['px-3 py-1 rounded-full text-sm border transition text-left', 
                                    selectedDisciplines.includes(disc) 
                                    ? 'bg-blue-100 text-blue-800 border-blue-300 font-semibold shadow-sm ring-1 ring-blue-300' 
                                    : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50']">
                                {{ disc }}
                            </button>
                        </div>
                    </div>

                    <!-- Active Entities List -->
                    <div v-else class="flex flex-wrap gap-3">
                        <div v-for="(entity, index) in activeEntities" :key="index"
                            class="flex items-center bg-white border border-blue-200 text-blue-800 px-4 py-2 rounded-full shadow-sm">
                            <span class="font-medium mr-2">{{ entity.name }}</span>
                            <span class="text-xs text-gray-500 uppercase mr-3">({{ entity.type }})</span>
                            <button @click="removeEntity(index)"
                                class="text-red-400 hover:text-red-700 font-bold">✕</button>
                        </div>
                    </div>

                    <!-- Schedule Grid -->
                    <!-- We group by DATE, then by TIME slot -->
                    <div v-if="Object.keys(groupedSchedule).length > 0"
                        class="bg-white rounded-xl shadow overflow-hidden">
                        <div v-for="dayData in groupedSchedule" :key="dayData.date" class="border-b last:border-b-0">
                            <div
                                class="bg-gray-50 px-6 py-3 border-b border-gray-100 flex justify-between items-center">
                                <h3 class="font-bold text-lg text-gray-800">{{ dayData.dayName }}, {{
                                    dayData.date
                                    }}
                                </h3>
                            </div>

                            <div class="divide-y divide-gray-100">
                                <div v-for="timeSlot in dayData.slots" :key="timeSlot.time"
                                    class="grid grid-cols-12 hover:bg-gray-50 transition p-4">
                                    <!-- Time Column -->
                                    <div
                                        class="col-span-12 md:col-span-2 text-center md:text-left mb-2 md:mb-0 flex flex-row md:flex-col items-center md:items-start gap-2 md:gap-1">
                                        <span
                                            class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded whitespace-nowrap">
                                            {{ timeSlot.time }}
                                        </span>
                                        <span v-if="timeSlot.start" class="text-sm text-gray-500 font-medium">
                                            {{ timeSlot.start }} - {{ timeSlot.end }}
                                        </span>
                                    </div>

                                    <!-- Classes Column -->
                                    <div class="col-span-12 md:col-span-10 grid gap-4">
                                        <div v-for="(lesson, idx) in timeSlot.lessons" :key="idx"
                                            class="bg-white border rounded-lg p-3 shadow-sm relative pl-4 border-l-4 transition-all duration-500"
                                            :class="[
                                                getColorClass(lesson.entityId),
                                                isActiveLesson(dayData.date, timeSlot.start, timeSlot.end) ? 'ring-4 ring-green-400 scale-[1.02] z-10' : ''
                                            ]">

                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <div v-if="isActiveLesson(dayData.date, timeSlot.start, timeSlot.end)"
                                                        class="inline-block bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full mb-1 animate-pulse">
                                                        ЗАРАЗ
                                                    </div>

                                                    <!-- Progress Bar -->
                                                    <div v-if="isActiveLesson(dayData.date, timeSlot.start, timeSlot.end)"
                                                        class="mb-2">
                                                        <div
                                                            class="flex justify-between text-[10px] text-gray-500 mb-1">
                                                            <span>Прогрес: {{ getLessonProgress(dayData.date,
                                                                timeSlot.start, timeSlot.end)?.percent
                                                                }}%</span>
                                                            <span>Залишилось: {{ getLessonProgress(dayData.date,
                                                                timeSlot.start, timeSlot.end)?.timeLeft }}
                                                                хв</span>
                                                        </div>
                                                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                                                            <div class="bg-blue-600 h-1.5 rounded-full transition-all duration-1000"
                                                                :style="{ width: getLessonProgress(dayData.date, timeSlot.start, timeSlot.end)?.percent + '%' }">
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- 1. Discipline + Group -->
                                                    <h4 class="font-bold text-gray-900 text-base mb-1">
                                                        {{ lesson.discipline }}
                                                        <span v-if="lesson.group" class="text-blue-600 font-normal">
                                                            ({{ lesson.group }})
                                                        </span>
                                                    </h4>

                                                    <!-- 2. Type -->
                                                    <div class="text-sm text-gray-500 mb-1" v-if="lesson.type">
                                                        🏷️ {{ lesson.type }}
                                                    </div>

                                                    <!-- 3. Teacher -->
                                                    <div
                                                        class="text-sm text-gray-700 font-medium flex flex-wrap items-center gap-2">
                                                        <span v-if="lesson.teacher" class="flex items-center">
                                                            👨‍ <span v-html="lesson.teacher" class="ml-1"></span>
                                                        </span>
                                                        <span v-if="lesson.cabinet" class="text-gray-400 text-xs ml-2">
                                                            📍 {{ lesson.cabinet }}
                                                        </span>
                                                    </div>

                                                </div>

                                                <!-- Global Links Buttons -->
                                                <div class="mt-2 flex gap-2">
                                                    <a v-if="getGlobalLink(lesson, 'courseUrl')"
                                                        :href="getGlobalLink(lesson, 'courseUrl')" target="_blank"
                                                        class="text-xs bg-blue-50 text-blue-700 border border-blue-200 px-2 py-1 rounded hover:bg-blue-100 font-medium flex items-center gap-1">
                                                        📘 Курс
                                                    </a>
                                                    <a v-if="getGlobalLink(lesson, 'onlineUrl')"
                                                        :href="getGlobalLink(lesson, 'onlineUrl')" target="_blank"
                                                        class="text-xs bg-purple-50 text-purple-700 border border-purple-200 px-2 py-1 rounded hover:bg-purple-100 font-medium flex items-center gap-1">
                                                        📹 Онлайн
                                                    </a>
                                                </div>

                                                <!-- Admin Edit Button -->
                                                <button v-if="adminMode" @click.stop="openAdminModal(lesson)"
                                                    class="absolute top-2 right-2 text-xs bg-gray-600 text-white px-1 rounded opacity-50 hover:opacity-100 z-20">
                                                    ✏️
                                                </button>

                                                <!-- Note Indicator/Button -->
                                                <div class="mt-2 flex justify-end">
                                                    <button @click.stop="openNote(lesson, dayData.date, timeSlot.time)"
                                                        class="text-xs px-2 py-1 rounded transition flex items-center gap-1"
                                                        :class="hasNote(lesson, dayData.date, timeSlot.time) ? 'bg-yellow-100 text-yellow-800 font-semibold' : 'text-gray-400 hover:text-gray-600 hover:bg-gray-50'">
                                                        <span v-if="hasNote(lesson, dayData.date, timeSlot.time)">📝
                                                            Є
                                                            нотатка</span>
                                                        <span v-else>➕ Нотатка</span>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="hidden md:block text-right">
                                                <span
                                                    class="text-xs font-bold uppercase tracking-wider text-gray-400 bg-gray-100 px-2 py-1 rounded">
                                                    {{ lesson.entityName }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="activeEntities.length > 0 && Object.keys(groupedSchedule).length === 0 && !loadingSchedule"
                    class="text-center py-10 text-gray-500">
                    На вибраний період розкладу немає.
                </div>

                <div v-if="loadingSchedule" class="text-center py-10">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="text-gray-500 mt-2">Завантаження розкладу...</p>
                </div>




                <!-- Modal: Admin Link Editor -->
                <div v-if="showAdminModal"
                    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] p-4"
                    @click.self="showAdminModal = false">
                    <div class="bg-white rounded-xl shadow-xl max-w-md w-full flex flex-col">
                        <div class="p-4 border-b bg-gray-100 rounded-t-xl">
                            <h3 class="font-bold text-lg text-gray-800">🔧 Адмін: Посилання</h3>
                            <p class="text-xs text-gray-600 truncate">{{ adminTargetTitle }}</p>
                            <p class="text-[10px] text-gray-400 font-mono">{{ adminTargetKey }}</p>
                        </div>

                        <div class="p-4 space-y-4">
                            <div>
                                <label class="block text-sm font-bold mb-1">🔗 Посилання на курс</label>
                                <input type="text" v-model="adminForm.courseUrl" placeholder="https://moodle..."
                                    class="w-full border rounded p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">📹 Посилання на онлайн пару</label>
                                <input type="text" v-model="adminForm.onlineUrl" placeholder="https://zoom.us/..."
                                    class="w-full border rounded p-2">
                            </div>
                        </div>

                        <div class="p-4 border-t flex justify-end gap-2">
                            <button @click="showAdminModal = false"
                                class="text-gray-500 hover:bg-gray-100 font-bold py-2 px-4 rounded">
                                Скасувати
                            </button>
                            <button @click="saveAdminLinks"
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                                Зберегти (Сервер)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <footer class="mt-12 text-center pb-8 text-gray-400 text-sm">
                    <a href="http://wp-fuaid.zzz.com.ua/r"
                        class="inline-block text-blue-600 hover:text-blue-800 font-semibold border-b-2 border-transparent hover:border-blue-600 transition mb-2">
                        ⬅ На головну
                    </a>
                    <div>
                        <button @click="toggleAdminLogin" class="hover:text-gray-600">Admin</button>
                    </div>
                </footer>


                <!-- Modal: Free Time -->
                <div v-if="showFreeTimeModal"
                    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                    @click.self="showFreeTimeModal = false">
                    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[80vh] flex flex-col">
                        <div class="p-4 border-b flex justify-between items-center bg-indigo-50 rounded-t-xl">
                            <h3 class="font-bold text-lg text-indigo-800">🤝 Спільний вільний час</h3>
                            <button @click="showFreeTimeModal = false"
                                class="text-gray-500 hover:text-gray-800 text-2xl">×</button>
                        </div>

                        <div class="p-4 overflow-y-auto">
                            <p class="text-sm text-gray-600 mb-4">
                                Знайдено в спільні "вікна" для вибраних груп/викладачів (крім вихідних):
                            </p>

                            <div v-if="commonFreeSlots.length === 0" class="text-center py-8 text-gray-400">
                                На жаль, спільних вікон не знайдено 😔
                            </div>

                            <div v-else class="space-y-4">
                                <div v-for="day in commonFreeSlots" :key="day.date"
                                    class="border rounded-lg p-3 bg-gray-50">
                                    <div class="font-bold text-gray-800 border-b pb-1 mb-2">{{ day.date }}</div>
                                    <div class="grid grid-cols-3 gap-2">
                                        <div v-for="slot in day.slots" :key="slot.pair"
                                            class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded text-center border border-green-200">
                                            {{ slot.pair }} пара
                                            <div class="font-normal text-green-600 text-[10px]">{{ slot.time }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 border-t text-right">
                            <button @click="showFreeTimeModal = false"
                                class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">
                                Закрити
                            </button>
                        </div>
                    </div>
                </div>



                <!-- Modal: Edit Note -->
                <div v-if="showNoteModal"
                    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4"
                    @click.self="showNoteModal = false">
                    <div class="bg-white rounded-xl shadow-xl max-w-md w-full flex flex-col">
                        <div class="p-4 border-b bg-yellow-50 rounded-t-xl">
                            <h3 class="font-bold text-lg text-yellow-800">📝 Нотатка</h3>
                            <p class="text-xs text-yellow-600 truncate">{{ currentNoteTitle }}</p>
                        </div>

                        <div class="p-4">
                            <textarea v-model="noteText" rows="5"
                                placeholder="Введіть ваш запис тут (напр. 'Д/З: прочитати ст. 20')"
                                class="w-full border rounded-lg p-3 focus:ring focus:ring-yellow-200 resize-none"></textarea>
                        </div>

                        <div class="p-4 border-t flex justify-end gap-2">
                            <button @click="showNoteModal = false"
                                class="text-gray-500 hover:bg-gray-100 font-bold py-2 px-4 rounded">
                                Скасувати
                            </button>
                            <button @click="saveNote"
                                class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">
                                Зберегти
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: All Notes Manager -->
        <div v-if="showAllNotesModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4"
            @click.self="showAllNotesModal = false">
            <div class="bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[80vh] flex flex-col">
                <div class="p-4 border-b bg-yellow-50 rounded-t-xl flex justify-between items-center">
                    <h3 class="font-bold text-lg text-yellow-800">📋 Всі нотатки</h3>
                    <button @click="showAllNotesModal = false"
                        class="text-gray-500 hover:text-gray-800 text-2xl">×</button>
                </div>

                <div class="p-4 overflow-y-auto space-y-3">
                    <div v-if="allNotesList.length === 0" class="text-center text-gray-400 py-8">
                        Список нотаток порожній
                    </div>
                    <div v-for="n in allNotesList" :key="n.key"
                        class="bg-yellow-50 border border-yellow-200 rounded p-3 relative group">
                        <p class="text-sm text-gray-800 whitespace-pre-wrap">{{ n.text }}</p>
                        <div class="text-[10px] text-gray-400 mt-1 font-mono truncate">{{ n.key }}</div>
                        <button @click="deleteNote(n.key)"
                            class="absolute top-2 right-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition">
                            🗑️
                        </button>
                    </div>
                </div>
            </div>
        </div>




    </div> <!-- End of #app -->

    <script>
        // Auto-detect environment:
        // - Port 3000 or Vercel -> Use Node Proxy (/api/)
        // - Otherwise (PHP Hosting) -> Use PHP Proxy (proxy.php)
        const isNode = window.location.port === '3000' || window.location.hostname.includes('vercel.app');
        const API_PROXY = isNode ? '/api/' : 'proxy.php?action=';

        const VUZ_ID = 11927; // Hardcoded ID from analysis

        try {
            if (typeof Vue === 'undefined') {
                throw new Error("Vue library failed to load (CDN issue).");
            }
            const { createApp, ref, computed, onMounted, watch } = Vue;

            createApp({
                setup() {
                    // State
                    const mode = ref('student'); // 'student' or 'teacher'
                    const loadingFilters = ref(false);
                    const loadingSchedule = ref(false);
                    const errorMessage = ref('');

                    // Dictionaries
                    const faculties = ref([]);
                    const eduForms = ref([]);
                    const courses = ref([]);
                    const chairs = ref([]);
                    const groups = ref([]); // List of groups for selected faculty
                    const employees = ref([]); // List of teachers
                    const studyTypes = ref([
                        { Key: '10', Value: 'Лекції' },
                        { Key: '11', Value: 'Практичні' },
                        { Key: '12', Value: 'Лабораторні' },
                        { Key: '14', Value: 'Консультації' },
                        { Key: '21', Value: 'Семінарські' },
                        { Key: '23', Value: 'Індивідуальні заняття' }
                    ]);

                    // Selections
                    const selectedFaculty = ref('');
                    const selectedEduForm = ref('');
                    const selectedCourse = ref('');
                    const selectedGroup = ref(''); // Object {Key, Value}
                    const selectedChair = ref('');
                    const selectedEmployee = ref(''); // Object {Key, Value}
                    const selectedStudyType = ref('');

                    // Filter within results
                    const selectedDisciplines = ref([]);

                    // Dates (Default to current week)
                    const dateStart = ref(new Date().toISOString().split('T')[0]);
                    const nextWeek = new Date();
                    nextWeek.setDate(nextWeek.getDate() + 7);
                    const dateEnd = ref(nextWeek.toISOString().split('T')[0]);

                    // Active Data
                    const activeEntities = ref([]); // Array of { id, name, type, scheduleData }

                    // --- Occupancy State ---
                    const occupancyDate = ref(new Date().toISOString().split('T')[0]);
                    const isScanning = ref(false);
                    const stopScan = ref(false);
                    const scanProgress = ref({ current: 0, total: 0, text: '' });
                    const occupancyResults = ref([]); // Array of { name, building, slots: { 1: ... } }
                    const occupancySearch = ref('');

                    const filteredOccupancyResults = computed(() => {
                        let q = occupancySearch.value.toLowerCase().trim();
                        if (!q) return occupancyResults.value;

                        // Advanced Normalize: remove separators AND map Latin to Cyrillic
                        const normalize = (str) => {
                            let out = str.toLowerCase().replace(/[^a-zа-я0-9іїєґ]/gi, '');
                            // Map Latin lookalikes to Cyrillic
                            const map = {
                                'a': 'а', 'b': 'ь', 'c': 'с', 'd': 'д', 'e': 'е', 'f': 'ф',
                                'g': 'г', 'h': 'н', 'i': 'і', 'j': 'й', 'k': 'к', 'l': 'л',
                                'm': 'м', 'n': 'н', 'o': 'о', 'p': 'р', 'q': 'я', 'r': 'р',
                                's': 'с', 't': 'т', 'u': 'у', 'v': 'в', 'w': 'в', 'x': 'х',
                                'y': 'у', 'z': 'з',
                                // Common specific:
                                '3': 'з', '0': 'о'
                            };
                            // We do a simple Replace for common letters that look IDENTICAL or are common typos
                            // Focus on: k->к, i->і, c->с, x->х, p->р, a->а, o->о, e->е
                            const typoMap = {
                                'k': 'к', 'c': 'с', 'x': 'х', 'p': 'р', 'a': 'а', 'o': 'о', 'e': 'е', 'i': 'і', 'y': 'у'
                            };

                            return out.split('').map(c => typoMap[c] || c).join('');
                        };

                        const qNorm = normalize(q);

                        return occupancyResults.value.filter(c => {
                            return normalize(c.name).includes(qNorm);
                        });
                    });

                    const scanErrors = ref(0);

                    // --- Admin State ---
                    const adminMode = ref(false);
                    const showAdminModal = ref(false);
                    const adminTargetTitle = ref('');
                    const adminTargetKey = ref('');
                    const adminForm = ref({ courseUrl: '', onlineUrl: '' });
                    const adminPassword = ref('');
                    const globalLinks = ref({});

                    // --- API Helpers ---
                    const fetchApi = async (action, params = {}, options = {}) => {
                        // Append action to the path for the Node server to parse correctly
                        const url = new URL(API_PROXY + action, window.location.origin);

                        url.searchParams.append('aVuzID', VUZ_ID);

                        // Filters needs GiveStudyTimes. 
                        if (action === 'GetStudyGroups') {
                            url.searchParams.append('aGiveStudyTimes', 'false');
                        } else if (!action.startsWith('GetScheduleData') && action !== 'GetEmployees') {
                            url.searchParams.append('aGiveStudyTimes', 'true');
                        }

                        // Force JSONP params to satisfy the server
                        // The server seems to require these to function correctly (avoids 500/401)
                        // We use a fixed callback name or random.
                        const callbackName = 'jsonp' + Date.now();
                        url.searchParams.append('callback', callbackName);
                        url.searchParams.append('_', Date.now());

                        const quoteIfNeeded = (val) => {
                            if (options.noQuote) return val;
                            // Avoid double quoting if already quoted
                            if (typeof val === 'string' && val.startsWith('"') && val.endsWith('"')) return val;
                            if (typeof val === 'string') return `"${val}"`;
                            return val;
                        };

                        for (const [key, value] of Object.entries(params)) {
                            if (value !== undefined && value !== null) {
                                url.searchParams.append(key, quoteIfNeeded(value));
                            }
                        }

                        try {
                            const res = await fetch(url);
                            if (!res.ok) throw new Error('Network error: ' + res.status);

                            const text = await res.text();

                            // Parse JSONP or JSON
                            // expected: jsonp123({...}) or {...}
                            let json;
                            const jsonpMatch = text.match(/^\s*([a-zA-Z0-9_]+)\s*\((.*)\)\s*;?\s*$/s);
                            if (jsonpMatch) {
                                // It is JSONP
                                json = JSON.parse(jsonpMatch[2]);
                            } else {
                                // Try standard JSON
                                json = JSON.parse(text);
                            }

                            return json.d || json; // The API wraps result in 'd' usually
                        } catch (e) {
                            if (!options.silent) {
                                console.error("API Error", e);
                                errorMessage.value = "Помилка завантаження даних";
                            } else {
                                console.warn("Silent API Fail:", action);
                            }
                            return null;
                        }
                    };

                    // --- Computed ---
                    // --- Computed ---
                    const availableDisciplines = computed(() => {
                        const set = new Set();
                        activeEntities.value.forEach(entity => {
                            if (!entity.scheduleData) return;
                            entity.scheduleData.forEach(item => {
                                if (item.discipline) set.add(item.discipline);

                                // User requested NO groups in filter ("мне не нужен поиск по группам")
                                // const g = item.group || item.groupName || item.study_group;
                                // if (g) set.add(g);

                                if (item.teacher) {
                                    let t = item.teacher;
                                    if (t.includes('<')) {
                                        const temp = document.createElement("div");
                                        temp.innerHTML = t;
                                        t = temp.textContent || "";
                                    }
                                    if (t) set.add(t);
                                }
                            });
                        });
                        return Array.from(set).sort();
                    });

                    const canAdd = computed(() => {
                        if (mode.value === 'student') return !!selectedGroup.value;
                        if (mode.value === 'teacher') return !!selectedEmployee.value;
                        return false;
                    });

                    const groupedSchedule = computed(() => {
                        // Merge all schedules from activeEntities
                        const merged = [];

                        activeEntities.value.forEach(entity => {
                            if (!entity.scheduleData) return;
                            entity.scheduleData.forEach(item => {
                                merged.push({
                                    ...item,
                                    entityName: entity.name,
                                    entityId: entity.id, // For coloring
                                    entityType: entity.type
                                });
                            });
                        });

                        // Group by Date -> Time
                        const days = {};

                        // Sorting helper
                        const parseDate = (str) => { // dd.mm.yyyy
                            const [d, m, y] = str.split('.');
                            return new Date(`${y}-${m}-${d}`);
                        };

                        merged.sort((a, b) => parseDate(a.full_date) - parseDate(b.full_date));

                        // Helper to find group name dynamically
                        const getGroupName = (obj) => {
                            // 1. Try known keys
                            if (obj.group) return obj.group;
                            if (obj.groupName) return obj.groupName;
                            if (obj.study_group) return obj.study_group;
                            if (obj.stream) return obj.stream;

                            // 2. Check 'contingent' field (Found via Debug: "Група: 121УЗ")
                            if (obj.contingent) {
                                // Try to clean it "Група: 121УЗ" -> "121УЗ"
                                return obj.contingent.replace(/Група:\s*/i, '').trim();
                            }

                            // 3. Search for any key containing 'group' or 'stream'
                            for (const key in obj) {
                                const lower = key.toLowerCase();
                                if ((lower.includes('group') || lower.includes('stream')) && obj[key]) {
                                    return obj[key];
                                }
                            }
                            return "";
                        };

                        merged.forEach(lesson => {
                            // Create Day if not exists
                            if (!days[lesson.full_date]) {
                                days[lesson.full_date] = {
                                    date: lesson.full_date,
                                    dayName: lesson.week_day,
                                    slots: {}
                                };
                            }

                            // normalize data for display
                            const groupName = getGroupName(lesson);

                            const lessonData = {
                                discipline: lesson.discipline,
                                type: lesson.study_type,
                                cabinet: lesson.cabinet,
                                teacher: lesson.employee_short || lesson.employee, // For students seeing teacher
                                group: groupName,
                                entityName: lesson.entityName,
                                entityId: lesson.entityId,
                                timeStart: lesson.study_time_begin,
                                timeEnd: lesson.study_time_end
                            };

                            // Filtering logic
                            if (selectedDisciplines.value.length > 0) {
                                const matchDiscipline = selectedDisciplines.value.includes(lesson.discipline);

                                // Handle Teacher match
                                let matchTeacher = false;
                                if (lesson.teacher || lesson.employee) {
                                    if (selectedDisciplines.value.includes(lesson.teacher) || selectedDisciplines.value.includes(lesson.employee)) {
                                        matchTeacher = true; // Direct match
                                    } else {
                                        // Clean match
                                        const raw = lesson.teacher || lesson.employee || "";
                                        if (raw.includes('<')) {
                                            const temp = document.createElement("div");
                                            temp.innerHTML = raw;
                                            if (selectedDisciplines.value.includes(temp.textContent)) matchTeacher = true;
                                        }
                                    }
                                }

                                if (!matchDiscipline && !matchTeacher) {
                                    return;
                                }
                            }

                            const timeKey = lesson.study_time;
                            if (!days[lesson.full_date].slots[timeKey]) {
                                days[lesson.full_date].slots[timeKey] = {
                                    time: timeKey, // "1 пара (08:30-09:50)"
                                    start: lesson.study_time_begin,
                                    end: lesson.study_time_end,
                                    lessons: []
                                };
                            }
                            days[lesson.full_date].slots[timeKey].lessons.push(lessonData);
                        });

                        // Convert days object to array and SORT by Date
                        return Object.values(days).sort((a, b) => parseDate(a.date) - parseDate(b.date)).map(day => {
                            // Convert slots object to array and SORT by Start Time
                            const sortedSlots = Object.values(day.slots).sort((a, b) => {
                                const [h1, m1] = a.start ? a.start.split(':') : [0, 0];
                                const [h2, m2] = b.start ? b.start.split(':') : [0, 0];
                                return (h1 * 60 + +m1) - (h2 * 60 + +m2);
                            });
                            return { ...day, slots: sortedSlots };
                        });
                    });

                    // --- Methods ---

                    const init = async () => {
                        loadState();
                        loadingFilters.value = true;
                        // Initial load -> Get Faculties
                        const data = await fetchApi('GetStudentScheduleFiltersData');
                        if (data) {
                            faculties.value = data.faculties || [];
                            eduForms.value = data.educForms || [];
                            courses.value = data.courses || [];
                        }
                        loadingFilters.value = false;
                    };

                    const clearAll = () => {
                        activeEntities.value = [];
                        selectedDisciplines.value = [];
                    };

                    const onFacultyChange = () => {
                        // Reset dependants
                        groups.value = [];
                        chairs.value = [];
                        selectedGroup.value = '';
                        selectedEmployee.value = '';
                        selectedChair.value = '';

                        if (!selectedFaculty.value) return;

                        if (mode.value === 'student') loadGroups();
                        else loadChairs();
                    };

                    const loadGroups = async () => {
                        if (mode.value !== 'student' || !selectedFaculty.value) return;

                        const data = await fetchApi('GetStudyGroups', {
                            aFacultyID: selectedFaculty.value,
                            aEducationForm: selectedEduForm.value || "",
                            aCourse: selectedCourse.value || ""
                        });

                        if (data && data.studyGroups) {
                            groups.value = data.studyGroups;
                        }
                    };

                    const loadChairs = async () => {
                        const data = await fetchApi('GetEmployeeChairs', {
                            aFacultyID: selectedFaculty.value
                        });
                        if (data) {
                            chairs.value = data.chairs || [];
                            // Some endpoints return employees right away if chair is null, but we usually pick chair first
                        }
                    };

                    const loadEmployees = async () => {
                        if (!selectedChair.value) return;
                        const data = await fetchApi('GetEmployees', {
                            aFacultyID: selectedFaculty.value,
                            aChairID: selectedChair.value
                        });
                        if (data) {
                            employees.value = data || []; // Sometimes it's direct array or {d: ...}
                        }
                    };

                    const addEntity = async () => {
                        let id, name, type, payload, action;
                        const startDate = dateStart.value.split('-').reverse().join('.'); // YYYY-MM-DD -> DD.MM.YYYY
                        const endDate = dateEnd.value.split('-').reverse().join('.');

                        if (mode.value === 'student') {
                            id = selectedGroup.value.Key;
                            name = selectedGroup.value.Value;
                            type = 'Група';
                            action = 'GetScheduleDataX'; // Student schedule
                            payload = {
                                aStudyGroupID: id,
                                aStartDate: startDate,
                                aEndDate: endDate,
                                aStudyTypeID: selectedStudyType.value ? `"${selectedStudyType.value}"` : "" // API expects quoted ID or empty
                            };
                        } else {
                            id = selectedEmployee.value.Key;
                            name = selectedEmployee.value.Value;
                            type = 'Викладач';
                            action = 'GetScheduleDataEmp'; // Teacher schedule
                            payload = {
                                aEmployeeID: id,
                                aStartDate: startDate,
                                aEndDate: endDate,
                                aStudyTypeID: selectedStudyType.value ? `"${selectedStudyType.value}"` : "" // API expects quoted ID or empty
                            };
                        }

                        // Check if already exists
                        if (activeEntities.value.find(e => e.id === id && e.type === type)) {
                            errorMessage.value = "Вже додано!";
                            setTimeout(() => errorMessage.value = '', 2000);
                            return;
                        }

                        loadingSchedule.value = true;
                        const data = await fetchApi(action, payload);
                        loadingSchedule.value = false;

                        if (data) {
                            activeEntities.value.push({
                                id,
                                name,
                                type,
                                scheduleData: data
                            });
                        }
                    };

                    const removeEntity = (index) => {
                        activeEntities.value.splice(index, 1);
                    };

                    const exportExcel = () => {
                        const rows = [];
                        // Headers
                        rows.push(["Дата", "День тижня", "Час", "Дисципліна", "Тип", "Викладач", "Кабінет", "Група/Викладач"]);

                        groupedSchedule.value.forEach(dayData => {
                            dayData.slots.forEach(timeSlot => {
                                timeSlot.lessons.forEach(lesson => {
                                    rows.push([
                                        dayData.date,
                                        dayData.dayName,
                                        timeSlot.time,
                                        lesson.discipline,
                                        lesson.type,
                                        lesson.teacher.replace(/<[^>]*>?/gm, ''), // Remove HTML from teacher name
                                        lesson.cabinet,
                                        lesson.entityName
                                    ]);
                                });
                            });
                        });

                        const ws = XLSX.utils.aoa_to_sheet(rows);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "Розклад");
                        XLSX.writeFile(wb, "rozklad.xlsx");
                    };

                    // --- Occupancy Logic ---
                    const startOccupancyScan = async () => {
                        if (isScanning.value) return;
                        isScanning.value = true;
                        stopScan.value = false;
                        occupancyResults.value = [];
                        errorMessage.value = '';

                        const dateVal = occupancyDate.value.split('-').reverse().join('.'); // DD.MM.YYYY

                        try {
                            // 1. Get Filters if not loaded
                            scanProgress.value = { current: 0, total: 0, text: 'Отримання списку факультетів та параметрів...' };
                            scanErrors.value = 0;

                            if (faculties.value.length === 0 || courses.value.length === 0 || eduForms.value.length === 0) {
                                const data = await fetchApi('GetStudentScheduleFiltersData');
                                if (data) {
                                    faculties.value = data.faculties || [];
                                    eduForms.value = data.educForms || [];
                                    courses.value = data.courses || [];
                                } else {
                                    throw new Error("Не вдалося завантажити параметри (факультети/курси)");
                                }
                            }

                            // 2. Get All Groups
                            // Iterate usage of parameters: aFacultyID, aEducationForm, aCourse
                            scanProgress.value.text = 'Збір списку груп (це може зайняти час)...';
                            let allGroups = [];

                            // Flatten the tasks to a list of combinations
                            const tasks = [];
                            for (const fac of faculties.value) {
                                // Some faculties might not have all courses, but we must try all combinations
                                // because the API provides global lists.
                                for (const form of eduForms.value) {
                                    for (const course of courses.value) {
                                        tasks.push({ fac, form, course });
                                    }
                                }
                            }

                            // Process tasks in chunks
                            const TASK_CHUNK = 5; // Parallel requests
                            for (let i = 0; i < tasks.length; i += TASK_CHUNK) {
                                if (stopScan.value) break;
                                const chunk = tasks.slice(i, i + TASK_CHUNK);

                                const chunkPromises = chunk.map(async ({ fac, form, course }) => {
                                    try {
                                        // Parameters must be strings. fetchApi will quote them if they are strings.
                                        // IDs are likely strings in JSON "1", "2".
                                        const res = await fetchApi('GetStudyGroups', {
                                            aFacultyID: fac.Key,
                                            aEducationForm: form.Key,
                                            aCourse: course.Key
                                        }, { silent: true });

                                        if (res && res.studyGroups) {
                                            return res.studyGroups.map(g => ({ ...g, _fac: fac.Value })); // Attach faculty name for context if needed
                                        }
                                        return [];
                                    } catch (e) {
                                        return [];
                                    }
                                });

                                const chunkRes = await Promise.all(chunkPromises);
                                chunkRes.forEach(g => {
                                    if (g.length > 0) allGroups.push(...g);
                                });

                                // Update progress text occasionally
                                if (i % 20 === 0) {
                                    scanProgress.value.text = `Збір груп: перевірено ${Math.min(i + TASK_CHUNK, tasks.length)} з ${tasks.length} комбінацій...`;
                                }

                                // Delay to prevent overwhelming server
                                await new Promise(r => setTimeout(r, 100)); // 100ms
                            }

                            // Deduplicate groups (just in case) based on Key
                            const uniqueGroups = [];
                            const seenKeys = new Set();
                            for (const g of allGroups) {
                                if (!seenKeys.has(g.Key)) {
                                    seenKeys.add(g.Key);
                                    uniqueGroups.push(g);
                                }
                            }
                            allGroups = uniqueGroups;

                            if (stopScan.value) throw new Error("Сканування зупинено");
                            if (allGroups.length === 0) throw new Error("Не вдалося знайти жодної групи. Спробуйте змінити фільтри або сервер недоступний.");

                            scanProgress.value = { current: 0, total: allGroups.length, text: 'Сканування розкладу...' };

                            // 3. Scan Process
                            // Map: CabinetName -> { slots: { pairNumber: Data } }
                            const cabinetMap = {};

                            // Chunking to avoid rate limits / browser hang
                            const CHUNK_SIZE = 5;
                            for (let i = 0; i < allGroups.length; i += CHUNK_SIZE) {
                                if (stopScan.value) break;

                                const chunk = allGroups.slice(i, i + CHUNK_SIZE);
                                const promises = chunk.map(async group => {
                                    const data = await fetchApi('GetScheduleDataX', {
                                        aStudyGroupID: group.Key,
                                        aStartDate: dateVal,
                                        aEndDate: dateVal,
                                        aStudyTypeID: ""
                                    }, { silent: true });

                                    if (!data) scanErrors.value++;
                                    return { group, data };
                                });

                                const results = await Promise.all(promises);

                                results.forEach(({ group, data }) => {
                                    if (!data) return;

                                    data.forEach(lesson => {
                                        if (!lesson.cabinet) return;
                                        const cabName = lesson.cabinet.trim();
                                        if (!cabName) return;

                                        // Parse pair number "1 пара..." -> 1
                                        const pairStr = lesson.study_time.split(' ')[0];
                                        const pairNum = parseInt(pairStr);
                                        if (isNaN(pairNum)) return;

                                        if (!cabinetMap[cabName]) {
                                            // Heuristic for building: "1-203" -> 1, "k2-304" -> 2
                                            let building = '?';
                                            const match = cabName.match(/^(\d+|[a-zA-Zа-яА-Я0-9]+)[-\s]/);
                                            if (match) building = match[1];

                                            cabinetMap[cabName] = {
                                                name: cabName,
                                                building: building,
                                                slots: {}
                                            };
                                        }

                                        // Make sure we don't overwrite if multiple groups share (lecture)
                                        // For now, just taking the first one found or appending
                                        if (!cabinetMap[cabName].slots[pairNum]) {
                                            cabinetMap[cabName].slots[pairNum] = {
                                                group: group.Value,
                                                teacher: lesson.employee_short || lesson.employee,
                                                discipline: lesson.discipline
                                            };
                                        } else {
                                            // If already occupied, maybe append group name?
                                            const existing = cabinetMap[cabName].slots[pairNum];
                                            if (!existing.group.includes(group.Value)) {
                                                existing.group += ", " + group.Value;
                                            }
                                        }
                                    });
                                });

                                // Update UI
                                scanProgress.value.current = Math.min(i + CHUNK_SIZE, allGroups.length);
                                occupancyResults.value = Object.values(cabinetMap).sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));

                                // Gentle delay to avoid DoS detection
                                await new Promise(r => setTimeout(r, 300));
                            }

                            // Convert map to array and sort
                            occupancyResults.value = Object.values(cabinetMap).sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));

                        } catch (e) {
                            console.error(e);
                            errorMessage.value = e.message;
                        } finally {
                            isScanning.value = false;
                        }
                    };

                    const exportOccupancy = () => {
                        const rows = [];
                        // Header
                        rows.push(["Аудиторія", "1 пара", "2 пара", "3 пара", "4 пара", "5 пара", "6 пара", "7 пара"]);

                        occupancyResults.value.forEach(cab => {
                            const row = [cab.name];
                            for (let i = 1; i <= 7; i++) {
                                if (cab.slots[i]) {
                                    row.push(`${cab.slots[i].group} (${cab.slots[i].teacher})`);
                                } else {
                                    row.push("");
                                }
                            }
                            rows.push(row);
                        });

                        const ws = XLSX.utils.aoa_to_sheet(rows);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "Зайнятість");
                        XLSX.writeFile(wb, `occupancy_${occupancyDate.value}.xlsx`);
                    };

                    // --- Statistics ---
                    const scheduleStats = computed(() => {
                        const stats = {
                            totalPairs: 0,
                            bySubject: {},
                            byType: {}
                        };

                        activeEntities.value.forEach(entity => {
                            if (!entity.scheduleData) return;
                            entity.scheduleData.forEach(item => {
                                stats.totalPairs++;

                                // By Subject
                                const subj = item.discipline;
                                stats.bySubject[subj] = (stats.bySubject[subj] || 0) + 1;

                                // By Type
                                const type = item.study_type || 'Інше';
                                stats.byType[type] = (stats.byType[type] || 0) + 1;
                            });
                        });

                        // Sort Subject by count
                        const sortedSubjects = Object.entries(stats.bySubject)
                            .map(([name, count]) => ({ name, count, percent: 0 }))
                            .sort((a, b) => b.count - a.count)
                            .slice(0, 5);

                        if (stats.totalPairs > 0) {
                            sortedSubjects.forEach(s => s.percent = Math.round((s.count / stats.totalPairs) * 100));
                        }

                        return {
                            totalPairs: stats.totalPairs,
                            topSubjects: sortedSubjects
                        };
                    });

                    // --- Persistence ---
                    const STORAGE_KEY = 'schedule_app_v1';

                    const saveState = () => {
                        const state = {
                            mode: mode.value,
                            activeEntities: activeEntities.value,
                            selectedDisciplines: selectedDisciplines.value,
                            notesMap: notesMap.value
                        };
                        try {
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                        } catch (e) {
                            console.error('Save failed', e);
                        }
                    };

                    const loadState = () => {
                        const saved = localStorage.getItem(STORAGE_KEY);
                        if (saved) {
                            try {
                                const parsed = JSON.parse(saved);
                                if (parsed.mode) mode.value = parsed.mode;
                                if (parsed.activeEntities) activeEntities.value = parsed.activeEntities;
                                if (parsed.selectedDisciplines) selectedDisciplines.value = parsed.selectedDisciplines;
                                if (parsed.notesMap) notesMap.value = parsed.notesMap;
                            } catch (e) {
                                console.error('Load failed', e);
                            }
                        }
                    };

                    // Watch for changes to auto-save
                    watch([mode, activeEntities, selectedDisciplines], () => {
                        saveState();
                    }, { deep: true });

                    const toggleDiscipline = (disc) => {
                        if (selectedDisciplines.value.includes(disc)) {
                            selectedDisciplines.value = selectedDisciplines.value.filter(d => d !== disc);
                        } else {
                            selectedDisciplines.value.push(disc);
                        }
                    };

                    // Color generator for different entities
                    const getColorClass = (id) => {
                        const colors = [
                            'border-red-400 bg-red-50',
                            'border-green-400 bg-green-50',
                            'border-yellow-400 bg-yellow-50',
                            'border-purple-400 bg-purple-50',
                            'border-pink-400 bg-pink-50',
                            'border-indigo-400 bg-indigo-50'
                        ];
                        // Simple hash
                        const num = String(id).split('').reduce((a, b) => a + b.charCodeAt(0), 0);
                        return colors[num % colors.length];
                    };

                    // Watchers
                    watch(mode, () => {
                        // Clear deeper selections when switching mode, but keep faculty
                        selectedGroup.value = '';
                        selectedEmployee.value = '';
                        if (selectedFaculty.value) {
                            if (mode.value === 'student') loadGroups();
                            else loadChairs();
                        }
                    });

                    // Watch for Study Type changes -> Reload all active entities
                    watch(selectedStudyType, async () => {
                        if (activeEntities.value.length === 0) return;

                        // We need to re-fetch data for all active entities with the new filter
                        const entities = [...activeEntities.value];
                        activeEntities.value = []; // Clear current list to force re-render/re-fetch logic

                        // Re-add them one by one (this reuses the addEntity logic which now reads the new filter)
                        // This is a bit hacky but ensures consistency with minimal code duplication
                        // Better approach: Iterate and update data in place.

                        loadingSchedule.value = true;

                        const promises = entities.map(async (entity) => {
                            let action, payload;
                            const startDate = dateStart.value.split('-').reverse().join('.');
                            const endDate = dateEnd.value.split('-').reverse().join('.');
                            const typeIdParam = selectedStudyType.value ? `"${selectedStudyType.value}"` : "";

                            if (entity.type === 'Група') {
                                action = 'GetScheduleDataX';
                                payload = {
                                    aStudyGroupID: entity.id,
                                    aStartDate: startDate,
                                    aEndDate: endDate,
                                    aStudyTypeID: typeIdParam
                                };
                            } else {
                                action = 'GetScheduleDataEmp';
                                payload = {
                                    aEmployeeID: entity.id,
                                    aStartDate: startDate,
                                    aEndDate: endDate,
                                    aStudyTypeID: typeIdParam
                                };
                            }

                            const data = await fetchApi(action, payload);
                            return { ...entity, scheduleData: data };
                        });

                        const updatedEntities = await Promise.all(promises);
                        activeEntities.value = updatedEntities;
                        loadingSchedule.value = false;
                    });

                    // --- Smart Search ---
                    const searchQuery = ref('');
                    const searchResults = ref([]);
                    const allItemsCache = ref([]); // { type, value, id, facultyId, label, ... }
                    const isCacheLoaded = ref(false);
                    const isSearching = ref(false);
                    const cacheStatus = ref('');

                    const buildUniversalCache = async () => {
                        if (isCacheLoaded.value) return;
                        isSearching.value = true;

                        if (faculties.value.length === 0) await init();

                        // 1. Fetch Groups (Batch)
                        cacheStatus.value = "Індексація груп...";

                        // Chunk faculties to avoid 500 errors
                        const FAC_CHUNK = 3;
                        for (let i = 0; i < faculties.value.length; i += FAC_CHUNK) {
                            const chunk = faculties.value.slice(i, i + FAC_CHUNK);
                            const chunkPromises = chunk.map(async (fac) => {
                                try {
                                    const data = await fetchApi('GetStudyGroups', { aFacultyID: fac.Key }, { silent: true });
                                    if (data && data.studyGroups) {
                                        return data.studyGroups.map(g => ({
                                            type: 'group',
                                            value: g,
                                            facultyId: fac.Key,
                                            facultyName: fac.Value,
                                            label: `${g.Value} (${fac.Value})`
                                        }));
                                    }
                                } catch (e) { return []; }
                                return [];
                            });

                            const chunkRes = await Promise.all(chunkPromises);
                            chunkRes.forEach(arr => {
                                allItemsCache.value.push(...arr);
                            });

                            // Delay between chunks
                            await new Promise(r => setTimeout(r, 200));
                        }


                        // 2. Fetch Teachers (Slower)
                        cacheStatus.value = "Індексація викладачів...";

                        for (const fac of faculties.value) {
                            try {
                                const chairData = await fetchApi('GetEmployeeChairs', { aFacultyID: fac.Key }, { silent: true });
                                if (chairData && chairData.chairs) {
                                    const empPromises = chairData.chairs.map(async (chair) => {
                                        try {
                                            const empData = await fetchApi('GetEmployees', {
                                                aFacultyID: fac.Key,
                                                aChairID: chair.Key
                                            }, { silent: true });
                                            if (empData) {
                                                const list = Array.isArray(empData) ? empData : [];
                                                return list.map(e => ({
                                                    type: 'teacher',
                                                    value: e,
                                                    facultyId: fac.Key,
                                                    chairId: chair.Key,
                                                    label: `${e.Value} (${chair.Value})`
                                                }));
                                            }
                                        } catch (e) { return []; }
                                        return [];
                                    });

                                    const empArrays = await Promise.all(empPromises);
                                    const emps = empArrays.flat();
                                    allItemsCache.value = [...allItemsCache.value, ...emps];
                                }
                            } catch (e) { console.error(e); }
                            await new Promise(r => setTimeout(r, 200)); // Rate limit
                        }

                        isCacheLoaded.value = true;
                        isSearching.value = false;
                        cacheStatus.value = "";
                    };

                    const onSearchInput = async () => {
                        if (!isCacheLoaded.value && !isSearching.value && searchQuery.value.length > 0) {
                            buildUniversalCache();
                        }

                        const q = searchQuery.value.toLowerCase().trim();
                        if (!q) {
                            searchResults.value = [];
                            return;
                        }

                        searchResults.value = allItemsCache.value
                            .filter(item => item.label.toLowerCase().includes(q))
                            .sort((a, b) => {
                                // Prioritize startsWith
                                const aStarts = a.label.toLowerCase().startsWith(q);
                                const bStarts = b.label.toLowerCase().startsWith(q);
                                if (aStarts && !bStarts) return -1;
                                if (!aStarts && bStarts) return 1;
                                return 0;
                            })
                            .slice(0, 10);
                    };

                    const selectSearchResult = async (item) => {
                        searchQuery.value = '';
                        searchResults.value = [];

                        if (item.type === 'group') {
                            mode.value = 'student';
                            selectedFaculty.value = item.facultyId;
                            await loadGroups();
                            selectedGroup.value = item.value;
                        } else {
                            mode.value = 'teacher';
                            selectedFaculty.value = item.facultyId;
                            await loadChairs();
                            selectedChair.value = item.chairId;
                            await loadEmployees();
                            selectedEmployee.value = item.value;
                        }

                        await addEntity();
                    };

                    // --- Time Highlighting ---
                    const currentTime = ref(new Date());

                    setInterval(() => {
                        currentTime.value = new Date();
                    }, 60000); // Every minute

                    const isActiveLesson = (dateStr, start, end) => {
                        if (!start || !end) return false;

                        const now = currentTime.value;

                        // Check Date
                        // dateStr is dd.mm.yyyy
                        const [d, m, y] = dateStr.split('.').map(Number);
                        if (now.getDate() !== d || (now.getMonth() + 1) !== m || now.getFullYear() !== y) {
                            return false;
                        }

                        // Check Time
                        // start/end is "HH:mm"
                        const [h1, m1] = start.split(':').map(Number);
                        const [h2, m2] = end.split(':').map(Number);

                        const nowMin = now.getHours() * 60 + now.getMinutes();
                        const startMin = h1 * 60 + m1;
                        const endMin = h2 * 60 + m2;

                        return nowMin >= startMin && nowMin < endMin;
                    };

                    const getLessonProgress = (dateStr, start, end) => {
                        if (!isActiveLesson(dateStr, start, end)) return null;

                        const now = currentTime.value;
                        const [h1, m1] = start.split(':').map(Number);
                        const [h2, m2] = end.split(':').map(Number);

                        const nowMin = now.getHours() * 60 + now.getMinutes();
                        const startMin = h1 * 60 + m1;
                        const endMin = h2 * 60 + m2;

                        const total = endMin - startMin;
                        const current = nowMin - startMin;
                        const percent = Math.min(100, Math.max(0, (current / total) * 100));

                        return {
                            percent: percent.toFixed(1),
                            timeLeft: endMin - nowMin
                        };
                    };

                    // --- Free Time Finder ---
                    const showFreeTimeModal = ref(false);
                    const commonFreeSlots = ref([]);

                    const findCommonFreeSlots = () => {
                        if (activeEntities.value.length < 2) return;

                        // 1. Collect all dates involved
                        const allDates = new Set();
                        activeEntities.value.forEach(e => {
                            if (e.scheduleData) {
                                e.scheduleData.forEach(d => allDates.add(d.full_date));
                            }
                        });

                        const sortedDates = Array.from(allDates).sort((a, b) => {
                            const [d1, m1, y1] = a.split('.');
                            const [d2, m2, y2] = b.split('.');
                            return new Date(`${y1}-${m1}-${d1}`) - new Date(`${y2}-${m2}-${d2}`);
                        });

                        const results = [];

                        // Standard pairs 1-7 (approximate times needed? No, just slots)
                        const PAIRS = [1, 2, 3, 4, 5, 6, 7];

                        // Maps for pair times (approximate, based on first found)
                        const pairTimes = {};

                        // Pre-fill busy map: Date -> Pair -> Set(EntityId)
                        const busyMap = {};

                        activeEntities.value.forEach(entity => {
                            if (!entity.scheduleData) return;
                            entity.scheduleData.forEach(lesson => {
                                if (!busyMap[lesson.full_date]) busyMap[lesson.full_date] = {};

                                // Extract pair number
                                const pairNum = parseInt(lesson.study_time.split(' ')[0]);
                                if (isNaN(pairNum)) return;

                                if (!busyMap[lesson.full_date][pairNum]) busyMap[lesson.full_date][pairNum] = new Set();
                                busyMap[lesson.full_date][pairNum].add(entity.id);

                                // Store time string for display if not exists
                                if (!pairTimes[pairNum]) {
                                    // Extract time range "(08:30-09:50)"
                                    const match = lesson.study_time.match(/\((.*?)\)/);
                                    if (match) pairTimes[pairNum] = match[1];
                                }
                            });
                        });

                        sortedDates.forEach(dateStr => {
                            const daySlots = [];
                            PAIRS.forEach(pair => {
                                // Check if ANY entity is busy at this slot
                                // Wait, "Common Free Time" means everyone is free.
                                // So if busyMap has NO entries for this entity?
                                // Logic: For this date and pair, check if EVERY active entity is free.

                                // But maybe some entities don't have lessons on this date at all (e.g. only Tue/Thu group).
                                // If I select Group A (Mon/Wed) and Group B (Tue/Thu).
                                // On Monday: Group A is busy. Group B is free. Common free? No, A is busy.
                                // On Tuesday: Group A is free. Group B is busy. Common free? No, B is busy.
                                // On Friday: Both free. Common free? Yes.

                                // So, we need to know if an entity is busy.
                                let isAnyBusy = false;

                                const busyInSlot = busyMap[dateStr]?.[pair];
                                if (busyInSlot && busyInSlot.size > 0) {
                                    isAnyBusy = true;
                                }

                                if (!isAnyBusy) {
                                    // Potentially free. But is it a working day?
                                    // If it's Sunday, likely no one has lessons. 
                                    // Let's check date day of week?
                                    const [d, m, y] = dateStr.split('.');
                                    const dayOfWeek = new Date(`${y}-${m}-${d}`).getDay();
                                    if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Exclude weekends from "Free Windows" unless requested?
                                        // Also, usually we care about breaks *between* classes or common free days.
                                        daySlots.push({
                                            pair,
                                            time: pairTimes[pair] || ''
                                        });
                                    }
                                }
                            });

                            if (daySlots.length > 0) {
                                results.push({
                                    date: dateStr,
                                    slots: daySlots
                                });
                            }
                        });

                        commonFreeSlots.value = results;
                        showFreeTimeModal.value = true;
                    };

                    // --- Notes System ---
                    const notesMap = ref({}); // Key: entityId_date_time -> text
                    const showNoteModal = ref(false);
                    const noteText = ref('');
                    const currentNoteKey = ref('');
                    const currentNoteTitle = ref('');

                    const showAllNotesModal = ref(false);

                    // Helper to generate key
                    const getNoteKey = (lesson, date, time) => {
                        // Unique check: Entity + Date + Time
                        // Lesson has entityId.
                        // Time is "1 пара (08:30...)"
                        // Simplify time to just pair number if possible, but strict string matching is safer.
                        return `${lesson.entityId}_${date}_${time}`;
                    };

                    const openNote = (lesson, date, time) => {
                        const key = getNoteKey(lesson, date, time);
                        currentNoteKey.value = key;
                        currentNoteTitle.value = `${lesson.discipline} (${date}, ${time})`;
                        noteText.value = notesMap.value[key] || '';
                        showNoteModal.value = true;
                    };

                    const saveNote = () => {
                        if (!noteText.value.trim()) {
                            delete notesMap.value[currentNoteKey.value];
                        } else {
                            notesMap.value[currentNoteKey.value] = noteText.value;
                        }
                        saveState(); // Persist
                        showNoteModal.value = false;
                    };

                    const hasNote = (lesson, date, time) => {
                        const key = getNoteKey(lesson, date, time);
                        return !!notesMap.value[key];
                    };

                    const allNotesList = computed(() => {
                        return Object.entries(notesMap.value).map(([key, text]) => {
                            const parts = key.split('_');
                            // entityId_date_time 
                            // Note: time might contain underscores if formatted? 
                            // Actually time is "1 пара (..)". Safe.
                            // But entityId might have underscores? Usually numeric or short code.
                            // Let's rely on simple split for now or store metadata?
                            // Storing metadata would be better, but map is simple.
                            // Let's just return key and text.
                            return { key, text };
                        });
                    });

                    const deleteNote = (key) => {
                        delete notesMap.value[key];
                        saveState();
                    };



                    // Load links on start
                    const loadGlobalLinks = async () => {
                        try {
                            const res = await fetch('/api/links');
                            if (res.ok) {
                                globalLinks.value = await res.json();
                            }
                        } catch (e) {
                            console.error("Failed to load global links", e);
                        }
                    };

                    const toggleAdminLogin = async () => {
                        if (adminMode.value) {
                            adminMode.value = false;
                            adminPassword.value = '';
                            return;
                        }
                        const pwd = prompt("Введіть пароль адміністратора:");
                        if (pwd === "admin123") {
                            adminMode.value = true;
                            adminPassword.value = pwd;
                            alert("Режим адміна активовано! Тепер ви бачите олівці для редагування.");
                        } else {
                            alert("Невірний пароль");
                        }
                    };

                    // Generate a stable key for the SUBJECT/LESSON type
                    // We want: Group + Discipline + Type
                    // Or: Teacher + Discipline + Type?
                    // Let's rely on what we have in the lesson object.
                    // Lesson: { group: "...", discipline: "...", type: "...", teacher: "..." }
                    // We want to apply this link for ALL occurrences of this subject for this group.
                    const getGlobalKey = (lesson) => {
                        // Try to make it as specific as possible but reusable across weeks
                        // Key: "Discipline_Group_Type"
                        // Sanitize
                        const safe = (s) => (s || '').replace(/[^a-zA-Zа-яА-Я0-9]/g, '');
                        return `${safe(lesson.discipline)}_${safe(lesson.group)}_${safe(lesson.type)}`;
                    };

                    const openAdminModal = (lesson) => {
                        const key = getGlobalKey(lesson);
                        adminTargetKey.value = key;
                        adminTargetTitle.value = `${lesson.discipline} (${lesson.group})`;

                        const existing = globalLinks.value[key] || {};
                        adminForm.value = {
                            courseUrl: existing.courseUrl || '',
                            onlineUrl: existing.onlineUrl || ''
                        };
                        showAdminModal.value = true;
                    };

                    const saveAdminLinks = async () => {
                        const key = adminTargetKey.value;
                        const val = { ...adminForm.value };

                        // Optimistic update
                        if (!globalLinks.value[key]) globalLinks.value[key] = {};
                        globalLinks.value[key] = val;

                        // Send to server
                        try {
                            // We need the password. I stored it in adminPassword ref.
                            const res = await fetch('/api/links', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    password: adminPassword.value,
                                    key: key,
                                    value: val
                                })
                            });
                            const data = await res.json();
                            if (!res.ok) {
                                alert("Помилка збереження: " + (data.error || "Невідома помилка"));
                            } else {
                                // Success
                            }
                        } catch (e) {
                            alert("Помилка мережі");
                        }
                        showAdminModal.value = false;
                    };

                    const getGlobalLink = (lesson, type) => {
                        const key = getGlobalKey(lesson);
                        if (globalLinks.value[key]) {
                            return globalLinks.value[key][type];
                        }
                        return null;
                    };

                    onMounted(async () => {
                        await init();
                        loadGlobalLinks();
                        // ...
                        // Start building search index in background immediately
                        // DISABLED: Causes server overload (500 errors). Only build when user types.
                        // setTimeout(() => {
                        //    buildUniversalCache();
                        // }, 500);
                    });

                    return {
                        mode,
                        loadingFilters,
                        loadingSchedule,
                        errorMessage,
                        faculties,
                        eduForms,
                        courses,
                        chairs,
                        groups,
                        employees,

                        selectedFaculty,
                        selectedEduForm,
                        selectedCourse,
                        selectedGroup,
                        selectedChair,
                        selectedEmployee,
                        selectedDisciplines,
                        studyTypes,
                        selectedStudyType,

                        dateStart,
                        dateEnd,
                        activeEntities,
                        onSearchInput,
                        searchQuery,
                        searchResults,
                        isSearching,
                        isCacheLoaded,
                        cacheStatus,
                        selectSearchResult,

                        availableDisciplines,
                        canAdd,
                        groupedSchedule,
                        scheduleStats,

                        onFacultyChange,
                        loadGroups,
                        loadChairs,
                        loadEmployees,
                        addEntity,
                        removeEntity,
                        clearAll,
                        exportExcel,
                        toggleDiscipline,
                        getColorClass,
                        isActiveLesson,
                        getLessonProgress,

                        // Free Time
                        showFreeTimeModal,
                        findCommonFreeSlots,
                        commonFreeSlots,

                        // Notes
                        showNoteModal,
                        noteText,
                        currentNoteKey,
                        currentNoteTitle,
                        openNote,
                        saveNote,
                        hasNote,
                        showAllNotesModal,
                        allNotesList,
                        deleteNote,

                        // Admin Global Links
                        adminMode,
                        toggleAdminLogin,
                        globalLinks,
                        showAdminModal,
                        openAdminModal,
                        adminTargetTitle,
                        adminTargetKey,
                        adminForm,
                        saveAdminLinks,
                        getGlobalLink,

                        // Occupancy
                        occupancyDate,
                        isScanning,
                        scanProgress,
                        stopScan,
                        occupancyResults,
                        startOccupancyScan,
                        exportOccupancy,
                        occupancySearch,
                        filteredOccupancyResults,
                        scanErrors
                    };
                }
            }).mount('#app');
        } catch (e) {
            alert("CRITICAL ERROR: " + e.message + "\nCheck console for details.");
            console.error(e);
        }
    </script>
</body>

</html>